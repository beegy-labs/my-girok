# PR 575 코드 리뷰: Admin Enterprise 기능 추가

안녕하세요. PR 575에 대한 상세 코드 리뷰를 공유합니다. 이 PR은 SCIM 2.0, JML, NHI 표준에 기반한 포괄적인 관리자(Admin) 프로필 및 기업 관리 기능을 도입하는 대규모 업데이트입니다.

전반적으로 컨트롤러, DTO, 타입 정의의 품질은 매우 높지만, 서비스 계층의 성능과 문서 정책 준수 측면에서 심각한 문제가 발견되었습니다.

---

## 종합 평가

| 영역                       | 상태                  | 요약                                                                                                                              |
| :------------------------- | :-------------------- | :-------------------------------------------------------------------------------------------------------------------------------- |
| **문서 (SSOT)**            | 🔴 **심각한 위반**    | **SSOT 정책이 지켜지지 않았습니다.** `.ai` 요약 문서는 업데이트되었으나, 핵심 SSOT인 `docs/llm` 문서는 전혀 변경되지 않았습니다.  |
| **서비스 (비즈니스 로직)** | 🟡 **주요 개선 필요** | **심각한 성능 안티패턴이 존재합니다.** N+1 쿼리 문제와 불필요한 DB 조회가 반복되어, 배포 시 즉각적인 성능 저하를 유발할 것입니다. |
| **테스트**                 | 🟢 **좋음**           | 새로운 서비스 로직에 대한 테스트가 충실하게 작성되었습니다. 성공/실패 케이스를 모두 다루고 있어 코드의 안정성을 높여줍니다.       |
| **타입 / DTO / 컨트롤러**  | ✅ **매우 좋음**      | 타입, DTO, 컨트롤러는 NestJS 모범 사례를 따라 매우 잘 작성되었습니다. 구조가 명확하고, 유효성 검사가 철저하며, 가독성이 높습니다. |
| **데이터베이스 스키마**    | 🟢 **좋음**           | 신규 기능을 지원하기 위한 스키마 확장이 논리적으로 잘 설계되었습니다. 사소한 네이밍 불일치 외에는 문제가 없습니다.                |
| **정책 준수**              | 🟢 **좋음**           | Git 커밋, 언어 등 다른 프로젝트 정책은 잘 준수되었습니다.                                                                         |

---

## 🔴 가장 시급한 문제 (Action Items)

### 1. 서비스 계층 성능 리팩터링 (심각도: Critical)

**문제점:**
현재 `AdminProfileService`와 `AdminEnterpriseService`는 심각한 성능 문제를 유발하는 안티패턴을 포함하고 있습니다.

1.  **N+1 쿼리 문제:** `AdminEnterpriseService.listAdmins` 메서드는 관리자 목록을 조회한 후, 각 관리자마다 `getAdminDetail`을 다시 호출합니다. 페이지 크기가 20이면 **총 21번 이상의 DB 쿼리**가 발생합니다.
2.  **불필요한 SELECT 후 UPDATE:** 모든 `update*` 메서드는 데이터를 수정한 후, 업데이트된 내용을 반환하기 위해 `getAdminDetail`을 다시 호출합니다. Prisma의 `update`는 수정된 객체를 바로 반환할 수 있으므로, 이는 불필요한 `SELECT` 쿼리입니다.
3.  **순차적 UPDATE:** `updateProfile`과 `updateEnterprise` 메서드는 여러 `update`를 순차적으로 호출하여, 단일 API 요청에 대해 수많은 DB 쿼리를 발생시킵니다.

**수정 제안:**

- **`listAdmins`:** `findMany` 호출 시 `include`를 통해 모든 연관 데이터를 한 번에 가져온 후, 이 결과를 DTO로 직접 매핑해야 합니다. 루프 안에서 `getAdminDetail`을 호출하는 로직은 반드시 제거되어야 합니다.
- **`update*` 메서드:** Prisma의 `update` 메서드가 반환하는 업데이트된 객체를 활용하고, 불필요한 `getAdminDetail` 호출을 제거해야 합니다.
- **`updateProfile`, `updateEnterprise`:** 여러 데이터를 모아 **단일 `update` 호출**로 리팩터링해야 합니다.

### 2. SSOT 문서 정책 위반 (심각도: High)

**문제점:**
`GEMINI.md`에 명시된 문서 정책에 따라, `.ai/` 파일은 `docs/llm/`에 있는 SSOT 문서의 요약본이어야 합니다. 하지만 이 PR에서는 `.ai/services/auth-service.md`만 업데이트되었고, 정작 SSOT인 `docs/llm/services/auth-service.md`는 전혀 업데이트되지 않았습니다.

**수정 제안:**

- `docs/llm/services/auth-service.md` 파일에 이번 PR에서 추가된 모든 기능(Admin Profile, Enterprise, NHI, JML 등)에 대한 상세 명세를 작성해야 합니다.
- `.ai/services/auth-service.md`는 이 상세 명세의 핵심만 요약하는 내용으로 수정되어야 합니다.

---

## 🟡 코드 품질 및 개선 제안

### 타입 안전성 문제 (`as any` 사용)

**문제점:**
두 서비스 파일 전반에 걸쳐 `as any` 타입 캐스팅이 남발되고 있습니다. 특히 Prisma의 `Json` 타입을 DTO 타입으로 변환하는 부분에서 두드러집니다. 이는 TypeScript의 타입 검사 기능을 무력화하여 코드의 안정성을 저해합니다.

**수정 제안:**

- `as any` 대신, 타입 가드(type guard)나 Zod와 같은 스키마 유효성 검사 라이브러리를 사용하여 Prisma에서 읽어온 `Json` 데이터를 명확한 타입으로 파싱하고 검증하는 것을 권장합니다.
- 간단하게는 `dto.skills as AdminSkill[]`와 같이 좀 더 구체적인 타입으로 캐스팅할 수 있습니다.

### 네이밍 컨벤션 불일치

**문제점:**
`schema.prisma` 파일 내에서 `enum` 정의 시 `snake_case`와 `PascalCase`가 혼용되고 있습니다. 신규 추가된 enum은 대부분 `snake_case`이지만, 기존 enum은 `PascalCase`를 따르는 경우가 있어 일관성이 부족합니다.

**수정 제안:**

- 프로젝트 전체의 `enum` 네이밍 컨벤션을 하나로 통일하는 것이 좋습니다. 일반적으로 Prisma 모델 및 필드는 `snake_case` 또는 `camelCase`, enum 타입명 자체는 `PascalCase`를 따르는 것이 권장됩니다.

---

## ✅ 칭찬할 점 (What Went Well)

- **DTO, 컨트롤러, 타입의 품질:** `packages/types`, DTO, 컨트롤러 코드는 매우 훌륭합니다. 역할 분리가 명확하고, NestJS의 기능을 잘 활용했으며, JSDoc 주석을 통해 문서화가 매우 잘 되어 있습니다. 이는 코드의 유지보수성과 개발자 경험을 크게 향상시킵니다.
- **철저한 테스트 코드:** 새로운 기능에 대한 유닛 테스트가 매우 꼼꼼하게 작성되었습니다. 성공 및 실패 시나리오를 모두 고려하여 코드의 신뢰도를 높였습니다. 이러한 테스트 덕분에 위에서 제안한 성능 리팩터링을 훨씬 안전하게 진행할 수 있습니다.
- **논리적인 DB 스키마 설계:** 새로운 기업 관리 기능을 지원하기 위한 `admins` 테이블 확장은 매우 논리적이고 포괄적으로 설계되었습니다.

---

## 최종 의견

이 PR은 프로젝트에 매우 중요한 기능을 추가하는 인상적인 작업입니다. 코드의 많은 부분이 높은 품질 기준을 보여줍니다.

하지만, **서비스 계층의 심각한 성능 문제**와 **핵심 문서 정책 위반**은 머지(Merge) 전에 반드시 해결되어야 합니다. 특히 성능 문제는 지금 수정하지 않으면 프로덕션 환경에서 즉시 장애로 이어질 수 있습니다.

위의 제안 사항들을 반영하여 수정 후 다시 리뷰를 요청해주시기 바랍니다.

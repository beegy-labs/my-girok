# Scope: 2026-Scope1 (Email Service)

> L2: Human approval required | Extracted from roadmap

## Status

| Phase          | Status      | Date       |
| -------------- | ----------- | ---------- |
| Spec           | ✅ Complete | 2026-01-22 |
| Implementation | ⏳ Pending  | -          |

## Target

Build global email service infrastructure (foundation for all notifications/invitations)

## Architecture

```
┌─────────────┐      gRPC       ┌──────────────┐      Kafka      ┌─────────┐
│  auth-bff   │ ──────────────> │ mail-service │ ──────────────> │ AWS SES │
│  (+ others) │                 │              │                 └─────────┘
└─────────────┘                 │  - i18n      │
                                │  - Templates │
                                │  - Tracking  │
                                └──────────────┘
                                       │
                                       ▼
                                ┌──────────────┐
                                │  PostgreSQL  │
                                │  - EmailLog  │
                                │  - Inbox     │
                                └──────────────┘
```

## Core Requirements

### 1. i18n (Multi-language Support)

| Item               | Description                               |
| ------------------ | ----------------------------------------- |
| User language      | `preferredLanguage` (ko, en, ja, zh, ...) |
| User country       | `countryCode` (KR, US, JP, CN, ...)       |
| Template structure | `templates/{template}/{locale}.hbs`       |
| Fallback           | Unsupported language → `en`               |

### 2. Service-level Tracking

| Item           | Description                                       |
| -------------- | ------------------------------------------------- |
| Source service | `sourceService` (auth-bff, identity-service, ...) |
| From address   | `fromEmail` (noreply@, support@, ...)             |
| Tenant         | `tenantId`                                        |
| Account        | `accountId`                                       |

### 3. Inbox - Future Extension

| Item               | Description               |
| ------------------ | ------------------------- |
| Per-account emails | `Inbox` table             |
| Read status        | `readAt`                  |
| Delete             | soft delete (`deletedAt`) |

## Items

| Priority | Feature                   | Description               | Status |
| -------- | ------------------------- | ------------------------- | ------ |
| P0       | Proto definition          | gRPC interface            | ⏳     |
| P0       | mail-service creation     | NestJS gRPC server        | ⏳     |
| P0       | i18n templates            | Multi-language templates  | ⏳     |
| P0       | Kafka Producer/Consumer   | Email send queuing        | ⏳     |
| P0       | AWS SES Integration       | Actual email delivery     | ⏳     |
| P0       | SES Webhook               | Open/Click/Bounce track   | ⏳     |
| P0       | audit-service integration | Send/open event tracking  | ⏳     |
| P0       | Database design           | EmailLog, Inbox tables    | ⏳     |
| P0       | Service-level tracking    | sourceService, fromEmail  | ⏳     |
| P0       | Dockerfile                | Container image           | ⏳     |
| P0       | docker-compose            | Local dev environment     | ⏳     |
| P0       | Helm Chart                | K8s deploy (Kafka topics) | ⏳     |
| P0       | auth-bff gRPC Client      | Client integration        | ⏳     |

## Email Templates (i18n)

```
src/templates/
├── admin-invite/
│   ├── en.hbs
│   ├── ko.hbs
│   ├── ja.hbs
│   └── zh.hbs
├── partner-invite/
│   ├── en.hbs
│   └── ko.hbs
├── password-reset/
│   ├── en.hbs
│   └── ko.hbs
└── welcome/
    ├── en.hbs
    └── ko.hbs
```

## Database Schema

### EmailLog (Send History)

| Column        | Type      | Description                                 |
| ------------- | --------- | ------------------------------------------- |
| id            | UUID      | PK                                          |
| tenantId      | UUID      | Tenant ID                                   |
| accountId     | UUID      | Recipient account ID (nullable)             |
| sourceService | VARCHAR   | Source service (auth-bff, identity-service) |
| fromEmail     | VARCHAR   | Sender email address                        |
| toEmail       | VARCHAR   | Recipient email address                     |
| template      | VARCHAR   | Template name                               |
| locale        | VARCHAR   | Language code (ko, en, ...)                 |
| subject       | VARCHAR   | Email subject                               |
| status        | ENUM      | PENDING, SENT, FAILED, BOUNCED              |
| messageId     | VARCHAR   | SES Message ID                              |
| sentAt        | TIMESTAMP | Sent timestamp                              |
| error         | TEXT      | Error message (nullable)                    |
| metadata      | JSONB     | Additional metadata                         |
| createdAt     | TIMESTAMP | Created timestamp                           |

### Inbox (Future Extension)

| Column     | Type      | Description               |
| ---------- | --------- | ------------------------- |
| id         | UUID      | PK                        |
| tenantId   | UUID      | Tenant ID                 |
| accountId  | UUID      | Recipient account ID      |
| emailLogId | UUID      | FK → EmailLog             |
| readAt     | TIMESTAMP | Read timestamp (nullable) |
| deletedAt  | TIMESTAMP | Deleted timestamp (soft)  |
| createdAt  | TIMESTAMP | Created timestamp         |

## audit-service Integration

### Kafka Topic: `audit.events`

| Event          | Trigger        | Tracking Data                                  |
| -------------- | -------------- | ---------------------------------------------- |
| `mail.sent`    | Send complete  | senderId, recipientId, template, sourceService |
| `mail.opened`  | Recipient open | recipientId, emailLogId, openedAt              |
| `mail.clicked` | Link click     | recipientId, emailLogId, linkUrl               |
| `mail.bounced` | Bounce occurs  | recipientEmail, bounceType, bounceReason       |

### SES Webhook

```
AWS SES → SNS Topic → mail-service (POST /webhook/ses)
                              ↓
                      Kafka: audit.events
                              ↓
                      audit-service (ClickHouse)
```

---

## Helm Configurable Values

### Kafka Environment Separation

| Environment | Topic Prefix | Example                                     |
| ----------- | ------------ | ------------------------------------------- |
| dev         | `dev.`       | `dev.mail.send`, `dev.audit.events`         |
| release     | `release.`   | `release.mail.send`, `release.audit.events` |
| main (prod) | (none)       | `mail.send`, `audit.events`                 |

```yaml
# values.yaml
mail:
  # Kafka config
  kafka:
    brokers: 'kafka:9092'
    topicPrefix: '' # dev., release., or empty for prod
    topics:
      send: 'mail.send' # → {prefix}mail.send
      dlq: 'mail.send.dlq' # → {prefix}mail.send.dlq
      audit: 'audit.events' # → {prefix}audit.events
    consumerGroup: 'mail-service-consumer' # → {prefix}mail-service-consumer
    sasl:
      enabled: true
      mechanism: 'scram-sha-512'
      username: ''
      password: ''

  # AWS SES config
  ses:
    region: 'ap-northeast-2'
    fromAddresses:
      default: 'noreply@example.com'
      support: 'support@example.com'
      marketing: 'marketing@example.com'
    configurationSet: 'mail-tracking'

  # i18n config
  i18n:
    defaultLocale: 'en'
    supportedLocales:
      - 'en'
      - 'ko'
      - 'ja'
      - 'zh'
    fallbackLocale: 'en'

  # Retry config
  retry:
    maxAttempts: 3
    backoffMs: 1000
    backoffMultiplier: 2

  # Tracking config
  tracking:
    enabled: true
    clickTracking: true
    openTracking: true
```

## Deliverables

- `services/mail-service/` - NestJS gRPC server
- `packages/proto/mail/v1/mail.proto` - Proto definition
- `packages/nest-common/` - MailGrpcClient addition
- `services/mail-service/helm/` - Helm Chart
- `services/mail-service/Dockerfile` - Docker image
- `docker-compose.yml.example` - mail-service addition
- `.ai/services/mail-service.md` - CDD document
- `docs/llm/services/mail-service.md` - SSOT document

## Success Criteria

- [ ] mail-service gRPC server working
- [ ] i18n templates (ko, en) working
- [ ] Kafka message publish/consume working
- [ ] AWS SES email delivery success
- [ ] EmailLog table storing send history
- [ ] Service-level tracking (sourceService, fromEmail) working
- [ ] auth-bff can call mail-service
- [ ] Helm deploy success (with Kafka topic config)
- [ ] 80% test coverage
- [ ] CDD documentation updated

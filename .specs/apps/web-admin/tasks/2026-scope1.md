# Tasks: 2026-Scope1 (Email Service)

> L3: LLM autonomous | Based on scopes/2026-scope1.md

## Status

| Item        | Count |
| ----------- | ----- |
| Total steps | 16    |
| Completed   | 0     |
| In progress | 0     |
| Pending     | 16    |

---

## Summary

| Step | Task             | Status |
| ---- | ---------------- | ------ |
| 1    | Proto definition | ⏳     |
| 2    | Project setup    | ⏳     |
| 3    | Dockerfile       | ⏳     |
| 4    | docker-compose   | ⏳     |
| 5    | Database design  | ⏳     |
| 6    | Core modules     | ⏳     |
| 7    | i18n templates   | ⏳     |
| 8    | gRPC Controller  | ⏳     |
| 9    | Kafka Producer   | ⏳     |
| 10   | Kafka Consumer   | ⏳     |
| 10-1 | SES Webhook      | ⏳     |
| 11   | AWS SES          | ⏳     |
| 12   | gRPC Client      | ⏳     |
| 13   | Helm Chart       | ⏳     |
| 14   | Environment vars | ⏳     |
| 15   | Testing          | ⏳     |
| 16   | CDD docs         | ⏳     |

---

## Active

(Activated when implementation starts)

---

## Pending

### Step 1: Proto Definition

**Tasks:**

- [ ] Create `packages/proto/mail/v1/mail.proto`

  ```protobuf
  service MailService {
    rpc SendEmail(SendEmailRequest) returns (SendEmailResponse);
    rpc SendBulkEmail(SendBulkEmailRequest) returns (SendBulkEmailResponse);
    rpc GetEmailStatus(GetEmailStatusRequest) returns (GetEmailStatusResponse);
    rpc GetInbox(GetInboxRequest) returns (GetInboxResponse);
    rpc MarkAsRead(MarkAsReadRequest) returns (MarkAsReadResponse);
  }

  message SendEmailRequest {
    string tenant_id = 1;
    string account_id = 2;           // Recipient account ID (optional)
    string to_email = 3;
    EmailTemplate template = 4;
    string locale = 5;               // ko, en, ja, zh
    map<string, string> variables = 6;
    string source_service = 7;       // auth-bff, identity-service
    string from_email = 8;           // noreply@, support@
    map<string, string> metadata = 9;
  }

  enum EmailTemplate {
    EMAIL_TEMPLATE_UNSPECIFIED = 0;
    EMAIL_TEMPLATE_ADMIN_INVITE = 1;
    EMAIL_TEMPLATE_PARTNER_INVITE = 2;
    EMAIL_TEMPLATE_PASSWORD_RESET = 3;
    EMAIL_TEMPLATE_WELCOME = 4;
  }
  ```

- [ ] Update `packages/proto/buf.yaml`
- [ ] Run `pnpm generate`

**Verification:**

```bash
cd packages/proto && buf lint
pnpm generate
ls packages/types/src/generated/proto/mail/v1/
```

---

### Step 2: mail-service Project Setup

**Tasks:**

- [ ] Create `services/mail-service/` directory
- [ ] Create `package.json`
  - dependencies: @nestjs/core, @nestjs/microservices, @grpc/grpc-js
  - dependencies: @aws-sdk/client-ses, kafkajs, handlebars
  - dependencies: @prisma/client
  - devDependencies: @my-girok/vitest-config, typescript, prisma
- [ ] Create `tsconfig.json`
- [ ] Create `nest-cli.json`
- [ ] Create `.env.example`

**Verification:**

```bash
cd services/mail-service && pnpm install
pnpm build
```

---

### Step 3: Dockerfile

**Tasks:**

- [ ] Create `services/mail-service/Dockerfile`
  - Multi-stage build (builder, production)
  - pnpm fetch + install pattern
  - Include Proto generate
  - Include Prisma generate
  - goose migration support
  - Health check config (gRPC)
  - Non-root user (node)
- [ ] Create `services/mail-service/.dockerignore`

**Verification:**

```bash
docker build -t mail-service:test -f services/mail-service/Dockerfile .
docker run --rm mail-service:test node --version
```

---

### Step 4: docker-compose.yml.example Update

**Tasks:**

- [ ] Add mail-service to `docker-compose.yml.example`
  ```yaml
  mail-service:
    build:
      context: .
      dockerfile: services/mail-service/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      GRPC_PORT: 50054
      DATABASE_URL: postgresql://...
      KAFKA_BROKERS: redpanda:9092
      AWS_REGION: ap-northeast-2
      # ...
    ports:
      - '50054:50054'
  ```
- [ ] Add Redpanda (Kafka) service (if not exists)
  ```yaml
  redpanda:
    image: redpandadata/redpanda:v24.1.1
    command:
      - redpanda start
      - --smp 1
      - --memory 512M
      - --overprovisioned
      - --kafka-addr PLAINTEXT://0.0.0.0:9092
    ports:
      - '9092:9092'
      - '8081:8081' # Schema Registry
      - '8082:8082' # REST Proxy
  ```

**Verification:**

```bash
docker compose config
docker compose up mail-service redpanda -d
docker compose logs mail-service
```

---

### Step 5: Database Design

**Tasks:**

- [ ] Create `prisma/schema.prisma`

  ```prisma
  model EmailLog {
    id            String    @id @default(uuid())
    tenantId      String    @map("tenant_id")
    accountId     String?   @map("account_id")
    sourceService String    @map("source_service")
    fromEmail     String    @map("from_email")
    toEmail       String    @map("to_email")
    template      String
    locale        String    @default("en")
    subject       String
    status        EmailStatus @default(PENDING)
    messageId     String?   @map("message_id")
    sentAt        DateTime? @map("sent_at")
    error         String?
    metadata      Json?
    createdAt     DateTime  @default(now()) @map("created_at")

    inbox         Inbox?
    @@map("email_logs")
  }

  model Inbox {
    id          String    @id @default(uuid())
    tenantId    String    @map("tenant_id")
    accountId   String    @map("account_id")
    emailLogId  String    @unique @map("email_log_id")
    emailLog    EmailLog  @relation(fields: [emailLogId], references: [id])
    readAt      DateTime? @map("read_at")
    deletedAt   DateTime? @map("deleted_at")
    createdAt   DateTime  @default(now()) @map("created_at")

    @@index([tenantId, accountId])
    @@map("inboxes")
  }

  enum EmailStatus {
    PENDING
    SENT
    FAILED
    BOUNCED
  }
  ```

- [ ] Create `migrations/` goose SQL migration
- [ ] Create `src/prisma/prisma.module.ts`
- [ ] Create `src/prisma/prisma.service.ts`

**Verification:**

```bash
pnpm prisma migrate dev --name init
pnpm prisma studio
```

---

### Step 6: mail-service Core Modules

**Tasks:**

- [ ] `src/main.ts` - gRPC server bootstrap (port: 50054)
- [ ] `src/app.module.ts` - Root module
- [ ] `src/config/configuration.ts` - Environment variable loading
- [ ] `src/config/validation.ts` - Joi validation

**Verification:**

```bash
pnpm start:dev
grpcurl -plaintext localhost:50054 list
```

---

### Step 7: i18n Template System

**Tasks:**

- [ ] `src/templates/template.module.ts`
- [ ] `src/templates/template.service.ts`
  - `loadTemplate(template: string, locale: string)` - Load template
  - `render(template: string, locale: string, variables: object)` - Render
  - Fallback: Unsupported language → `en`
- [ ] `src/templates/admin-invite/en.hbs`
  ```handlebars
  <h1>Admin Invitation</h1>
  <p>{{inviterName}} has invited you as an administrator.</p>
  <p>Invitation Link: <a href='{{inviteLink}}'>{{inviteLink}}</a></p>
  <p>Temporary Password: {{temporaryPassword}}</p>
  <p>Expires: {{expiresAt}}</p>
  ```
- [ ] `src/templates/admin-invite/ko.hbs`
- [ ] `src/templates/partner-invite/{en,ko}.hbs`
- [ ] `src/templates/password-reset/{en,ko}.hbs`
- [ ] `src/templates/welcome/{en,ko}.hbs`
- [ ] `src/templates/template.service.spec.ts`

**Verification:**

```bash
pnpm test src/templates/template.service.spec.ts
```

---

### Step 8: gRPC Controller

**Tasks:**

- [ ] `src/mail/mail.module.ts`
- [ ] `src/mail/mail.controller.ts`
  - `@GrpcMethod('MailService', 'SendEmail')`
  - `@GrpcMethod('MailService', 'SendBulkEmail')`
  - `@GrpcMethod('MailService', 'GetEmailStatus')`
  - `@GrpcMethod('MailService', 'GetInbox')`
  - `@GrpcMethod('MailService', 'MarkAsRead')`
- [ ] `src/mail/mail.service.ts`
  - `sendEmail()` - Template render + Kafka publish
  - `getEmailStatus()` - Query EmailLog
  - `getInbox()` - Query Inbox
  - `markAsRead()` - Mark as read

**Verification:**

```bash
grpcurl -plaintext -d '{
  "tenant_id": "...",
  "to_email": "test@example.com",
  "template": "EMAIL_TEMPLATE_WELCOME",
  "locale": "ko",
  "source_service": "auth-bff",
  "from_email": "noreply@example.com",
  "variables": {"userName": "Test"}
}' localhost:50054 mail.v1.MailService/SendEmail
```

---

### Step 9: Kafka Producer

**Tasks:**

- [ ] `src/kafka/kafka.module.ts`
- [ ] `src/kafka/kafka.producer.ts`
  - Publish to `mail.send` topic
  - Message schema:
    ```json
    {
      "id": "uuid",
      "tenantId": "...",
      "accountId": "...",
      "sourceService": "auth-bff",
      "fromEmail": "noreply@...",
      "toEmail": "user@...",
      "template": "ADMIN_INVITE",
      "locale": "ko",
      "subject": "...",
      "body": "...",
      "metadata": {},
      "createdAt": "..."
    }
    ```
  - SASL authentication config

**Verification:**

```bash
kafka-console-consumer --topic mail.send --bootstrap-server localhost:9092 --from-beginning
```

---

### Step 10: Kafka Consumer

**Tasks:**

- [ ] `src/kafka/kafka.consumer.ts`
  - Subscribe to `mail.send` topic
  - Call AWS SES delivery
  - Update EmailLog status (SENT/FAILED)
  - Create Inbox record (if accountId exists)
  - **Publish `mail.sent` event to audit.events topic**
  - Retry logic (3 times, exponential backoff)
  - DLQ handling: `mail.send.dlq`
- [ ] `src/kafka/kafka.consumer.spec.ts`

**Verification:**

```bash
docker logs mail-service | grep "mail.send"
kafka-console-consumer --topic mail.send.dlq --bootstrap-server localhost:9092
kafka-console-consumer --topic audit.events --bootstrap-server localhost:9092 | grep "mail.sent"
```

---

### Step 10-1: SES Webhook (Open/Click/Bounce Tracking)

**Tasks:**

- [ ] `src/webhook/webhook.module.ts`
- [ ] `src/webhook/webhook.controller.ts`
  - `POST /webhook/ses` - Receive SES SNS notification (REST endpoint)
  - Handle event types: Delivery, Open, Click, Bounce, Complaint
- [ ] `src/webhook/webhook.service.ts`
  - `handleOpen()` - Open event
    - Update EmailLog (openedAt)
    - **Publish `mail.opened` to audit.events topic**
  - `handleClick()` - Click event
    - **Publish `mail.clicked` to audit.events topic**
  - `handleBounce()` - Bounce event
    - Update EmailLog status (BOUNCED)
    - **Publish `mail.bounced` to audit.events topic**
  - `handleComplaint()` - Spam report handling
- [ ] `src/webhook/webhook.controller.spec.ts`

**audit.events message schema:**

```json
{
  "eventType": "mail.sent | mail.opened | mail.clicked | mail.bounced",
  "timestamp": "2026-01-22T12:00:00Z",
  "tenantId": "...",
  "data": {
    "emailLogId": "...",
    "senderId": "...",
    "recipientId": "...",
    "recipientEmail": "...",
    "template": "ADMIN_INVITE",
    "sourceService": "auth-bff",
    "linkUrl": "...",
    "bounceType": "...",
    "bounceReason": "..."
  }
}
```

**AWS SES Setup Required:**

- Create Configuration Set (`mail-tracking`)
- Connect SNS Topic (Open, Click, Bounce, Complaint)
- Subscribe SNS → mail-service webhook

**Verification:**

```bash
kafka-console-consumer --topic audit.events --bootstrap-server localhost:9092 | grep "mail."
```

---

### Step 11: AWS SES Integration

**Tasks:**

- [ ] `src/ses/ses.module.ts`
- [ ] `src/ses/ses.service.ts`
  - `sendEmail(params)` - SES delivery
  - Log delivery result
  - Configuration Set tracking (open, click)
- [ ] `src/ses/ses.service.spec.ts` (mocking)

**Verification:**

```bash
pnpm test src/ses/ses.service.spec.ts
# Real delivery test (AWS SES Sandbox)
```

---

### Step 12: auth-bff gRPC Client

**Tasks:**

- [ ] `packages/nest-common/src/grpc/mail.client.ts`
  ```typescript
  @Injectable()
  export class MailGrpcClient {
    sendEmail(request: SendEmailRequest): Promise<SendEmailResponse>;
    sendBulkEmail(request: SendBulkEmailRequest): Promise<SendBulkEmailResponse>;
    getEmailStatus(request: GetEmailStatusRequest): Promise<GetEmailStatusResponse>;
    getInbox(request: GetInboxRequest): Promise<GetInboxResponse>;
    markAsRead(request: MarkAsReadRequest): Promise<MarkAsReadResponse>;
  }
  ```
- [ ] Update `packages/nest-common/src/grpc/grpc-clients.module.ts`
- [ ] Add export to `packages/nest-common/src/index.ts`
- [ ] Test usage in `services/auth-bff/`

**Verification:**

```bash
cd services/auth-bff && pnpm test:e2e
```

---

### Step 13: Helm Chart

**Tasks:**

- [ ] `services/mail-service/helm/Chart.yaml`
- [ ] `services/mail-service/helm/values.yaml.example`

  ```yaml
  replicaCount: 1
  image:
    repository: mail-service
    tag: latest

  grpc:
    port: 50054

  mail:
    kafka:
      brokers: 'kafka:9092'
      # Environment topic prefix: dev., release., "" (prod)
      topicPrefix: ''
      topics:
        send: 'mail.send' # → {prefix}mail.send
        dlq: 'mail.send.dlq' # → {prefix}mail.send.dlq
        audit: 'audit.events' # → {prefix}audit.events
      consumerGroup: 'mail-service-consumer'
      sasl:
        enabled: false
        mechanism: 'scram-sha-512'
        secretName: 'kafka-credentials'

    ses:
      region: 'ap-northeast-2'
      fromAddresses:
        default: 'noreply@example.com'
        support: 'support@example.com'
      configurationSet: 'mail-tracking'

    i18n:
      defaultLocale: 'en'
      supportedLocales: ['en', 'ko', 'ja', 'zh']
      fallbackLocale: 'en'

    retry:
      maxAttempts: 3
      backoffMs: 1000
      backoffMultiplier: 2

  otel:
    enabled: true
    endpoint: 'http://otel-collector:4318'
  ```

- [ ] Create environment-specific values files
  - `values-dev.yaml` (topicPrefix: "dev.")
  - `values-staging.yaml` (topicPrefix: "release.")
  - `values-prod.yaml` (topicPrefix: "")
- [ ] `services/mail-service/helm/templates/deployment.yaml`
- [ ] `services/mail-service/helm/templates/service.yaml`
- [ ] `services/mail-service/helm/templates/sealed-secret.yaml`
- [ ] `services/mail-service/helm/templates/migration-job.yaml`
- [ ] `services/mail-service/helm/templates/configmap.yaml` (template files)

**Verification:**

```bash
helm template mail-service ./services/mail-service/helm
helm install mail-service ./services/mail-service/helm --dry-run -n my-girok
```

---

### Step 14: Environment Variables

**Tasks:**

- [ ] Complete `.env.example`

  ```bash
  # Server
  GRPC_PORT=50054

  # Database
  DATABASE_URL=postgresql://user:pass@localhost:5432/mail_db

  # Kafka (Redpanda)
  KAFKA_BROKERS=localhost:9092
  KAFKA_CLIENT_ID=mail-service
  KAFKA_TOPIC_PREFIX=dev.              # dev., release., "" (prod)
  KAFKA_CONSUMER_GROUP=mail-service-consumer
  KAFKA_TOPIC_SEND=mail.send           # → {prefix}mail.send
  KAFKA_TOPIC_DLQ=mail.send.dlq        # → {prefix}mail.send.dlq
  KAFKA_TOPIC_AUDIT=audit.events       # → {prefix}audit.events
  KAFKA_SASL_ENABLED=false
  KAFKA_SASL_USERNAME=
  KAFKA_SASL_PASSWORD=
  KAFKA_SASL_MECHANISM=scram-sha-512

  # AWS SES
  AWS_REGION=ap-northeast-2
  AWS_ACCESS_KEY_ID=
  AWS_SECRET_ACCESS_KEY=
  SES_FROM_EMAIL_DEFAULT=noreply@example.com
  SES_FROM_EMAIL_SUPPORT=support@example.com
  SES_CONFIGURATION_SET=mail-tracking

  # i18n
  I18N_DEFAULT_LOCALE=en
  I18N_SUPPORTED_LOCALES=en,ko,ja,zh
  I18N_FALLBACK_LOCALE=en

  # Retry
  RETRY_MAX_ATTEMPTS=3
  RETRY_BACKOFF_MS=1000
  RETRY_BACKOFF_MULTIPLIER=2

  # OTEL
  OTEL_EXPORTER_OTLP_ENDPOINT=
  OTEL_SERVICE_NAME=mail-service
  ```

**Verification:**

```bash
pnpm start:dev  # Joi validation pass
```

---

### Step 15: Testing

**Tasks:**

- [ ] Configure `vitest.config.ts`
- [ ] Unit Tests
  - [ ] `src/mail/mail.service.spec.ts`
  - [ ] `src/templates/template.service.spec.ts`
  - [ ] `src/kafka/kafka.producer.spec.ts`
  - [ ] `src/kafka/kafka.consumer.spec.ts`
  - [ ] `src/ses/ses.service.spec.ts`
- [ ] Integration Tests
  - [ ] gRPC endpoint tests
  - [ ] i18n template rendering tests
  - [ ] Kafka message publish/consume tests

**Verification:**

```bash
pnpm test
pnpm test:cov  # 80%+
```

---

### Step 16: CDD Documentation Update (Required on Completion)

**Tasks:**

- [ ] Create `.ai/services/mail-service.md`

  ````markdown
  # mail-service

  ```yaml
  port: N/A (no REST)
  grpc: 50054
  db: mail_db (PostgreSQL)
  cache: N/A
  events: mail.* (Redpanda)
  codebase: services/mail-service/
  ```

  ## Boundaries

  | Owns           | Not             |
  | -------------- | --------------- |
  | Email sending  | User management |
  | i18n Templates | Authentication  |
  | Send history   | -               |
  | Inbox          | -               |

  ## gRPC (50054)

  | Method         | Description  |
  | -------------- | ------------ |
  | SendEmail      | Single send  |
  | SendBulkEmail  | Bulk send    |
  | GetEmailStatus | Status query |
  | GetInbox       | Inbox query  |
  | MarkAsRead     | Mark as read |

  ## Tables

  | Table      | Purpose      |
  | ---------- | ------------ |
  | email_logs | Send history |
  | inboxes    | Inbox        |

  ## Events

  ```
  mail.send (produce)
  mail.send.dlq (produce on failure)
  ```
  ````

- [ ] Create `docs/llm/services/mail-service.md` (SSOT)
- [ ] Update `docs/llm/guides/grpc.md`

**Verification:**

```bash
ls .ai/services/mail-service.md
ls docs/llm/services/mail-service.md
grep "mail-service" docs/llm/guides/grpc.md
grep "50054" docs/llm/guides/grpc.md
```

---

## Completed

(none)

---

## Blocked

(none)

---

## Notes

- All internal communication is gRPC
- Kafka uses Redpanda (Kafka compatible)
- **Kafka environment separation**: topicPrefix for dev./release./"" distinction
- i18n: Based on user locale, fallback → en
- Service-level tracking: sourceService, fromEmail required
- Inbox: Created only when accountId exists
- On email send failure: Move to DLQ, retry 3 times
- Dockerfile follows identity-service pattern
- Helm values.yaml allows Kafka topics, i18n, retry configuration
- **audit-service integration**: Publish mail.sent/opened/clicked/bounced to `audit.events` topic
- **SES Webhook**: REST endpoint (`POST /webhook/ses`) receives SNS notifications
- Service user exposure (GetSentEmails etc.) is future spec

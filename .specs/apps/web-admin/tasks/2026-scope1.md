# Tasks: 2026-Scope1 (Mail & Notification Services)

> **HOW**: Detailed implementation plan | LLM generates, Human reviews & approves

## CDD References

Implementation patterns from CDD (Tier 1-2):

| CDD Document                    | Purpose               |
| ------------------------------- | --------------------- |
| `.ai/rules.md`                  | Core DO/DON'T rules   |
| `.ai/architecture.md`           | Architecture patterns |
| `docs/llm/guides/grpc.md`       | gRPC patterns         |
| `docs/llm/policies/database.md` | Database patterns     |
| `docs/llm/policies/testing.md`  | Testing standards     |

## Status

| Service              | Total | Completed | In Progress | Pending |
| -------------------- | ----- | --------- | ----------- | ------- |
| Phase 0 (shared)     | 5     | 0         | 0           | 5       |
| mail-service         | 16    | 8         | 0           | 8       |
| notification-service | 15    | 0         | 0           | 15      |
| Scope Completion     | 2     | 0         | 0           | 2       |

> **Note**: notification.proto (Step N1) moved to Phase 0 (Step 0-0) to resolve dependency
> **Note**: Scope Completion (F1, F2) runs after all services complete

## Common Patterns Analysis

See: `tasks/common-patterns-review.md` for detailed analysis of reusable patterns.

---

# Part 0: Shared Pre-requisites ⏳

> **BLOCKING**: Phase 3 of mail-service and all notification-service phases depend on these

## Execution Plan

### Phase 0-A (Proto Definitions) - FIRST ⏳

| Step | Task                          | Depends On | Common Pattern | Status |
| ---- | ----------------------------- | ---------- | -------------- | ------ |
| 0-0  | notification.proto definition | -          | ✅ mail.proto  | ⏳     |

### Phase 0-B (gRPC Clients) - AFTER 0-A ⏳

| Step | Task                     | Depends On       | Common Pattern     | Status |
| ---- | ------------------------ | ---------------- | ------------------ | ------ |
| 0-1  | AuditGrpcClient          | audit.proto ✅   | IdentityGrpcClient | ⏳     |
| 0-2  | MailGrpcClient           | mail.proto ✅    | IdentityGrpcClient | ⏳     |
| 0-3  | NotificationGrpcClient   | **Step 0-0**     | IdentityGrpcClient | ⏳     |
| 0-4  | Update GrpcClientsModule | Step 0-1,0-2,0-3 | -                  | ⏳     |

### Files to Create

```
packages/proto/notification/v1/
└── notification.proto        # Step 0-0

packages/nest-common/src/grpc/
├── audit-grpc.client.ts      # Step 0-1
├── mail-grpc.client.ts       # Step 0-2
├── notification-grpc.client.ts # Step 0-3
└── grpc-clients.module.ts    # Step 0-4 (update)
```

---

## Part 0 Detailed Steps

### Step 0-0: notification.proto Definition

**Tasks:**

- [ ] Create `packages/proto/notification/v1/notification.proto`

```protobuf
syntax = "proto3";

package notification.v1;

option go_package = "github.com/beegy-labs/my-girok/gen/notification/v1";

import "google/protobuf/timestamp.proto";

// NotificationService provides unified notification hub operations
service NotificationService {
  // Core Notification APIs
  rpc SendNotification(SendNotificationRequest) returns (SendNotificationResponse);
  rpc SendBulkNotification(SendBulkNotificationRequest) returns (SendBulkNotificationResponse);
  rpc GetNotifications(GetNotificationsRequest) returns (GetNotificationsResponse);
  rpc MarkAsRead(MarkAsReadRequest) returns (MarkAsReadResponse);
  rpc GetNotificationStatus(GetNotificationStatusRequest) returns (GetNotificationStatusResponse);

  // User Preferences
  rpc GetPreferences(GetPreferencesRequest) returns (GetPreferencesResponse);
  rpc UpdatePreferences(UpdatePreferencesRequest) returns (UpdatePreferencesResponse);

  // Device Token Management (for Push)
  rpc RegisterDeviceToken(RegisterDeviceTokenRequest) returns (RegisterDeviceTokenResponse);
  rpc UnregisterDeviceToken(UnregisterDeviceTokenRequest) returns (UnregisterDeviceTokenResponse);
  rpc GetDeviceTokens(GetDeviceTokensRequest) returns (GetDeviceTokensResponse);

  // Quiet Hours / DND
  rpc GetQuietHours(GetQuietHoursRequest) returns (GetQuietHoursResponse);
  rpc UpdateQuietHours(UpdateQuietHoursRequest) returns (UpdateQuietHoursResponse);
}

// ============================================================
// Enums
// ============================================================

enum NotificationChannel {
  NOTIFICATION_CHANNEL_UNSPECIFIED = 0;
  NOTIFICATION_CHANNEL_IN_APP = 1;
  NOTIFICATION_CHANNEL_PUSH = 2;
  NOTIFICATION_CHANNEL_SMS = 3;
  NOTIFICATION_CHANNEL_EMAIL = 4;
}

enum NotificationType {
  NOTIFICATION_TYPE_UNSPECIFIED = 0;
  NOTIFICATION_TYPE_SYSTEM = 1;
  NOTIFICATION_TYPE_ADMIN_INVITE = 2;
  NOTIFICATION_TYPE_PARTNER_INVITE = 3;
  NOTIFICATION_TYPE_PASSWORD_RESET = 4;
  NOTIFICATION_TYPE_SECURITY_ALERT = 5;
  NOTIFICATION_TYPE_MFA_CODE = 6;
  NOTIFICATION_TYPE_ACCOUNT_LOCKED = 7;
  NOTIFICATION_TYPE_LOGIN_ALERT = 8;
  NOTIFICATION_TYPE_MARKETING = 9;
}

enum NotificationStatus {
  NOTIFICATION_STATUS_UNSPECIFIED = 0;
  NOTIFICATION_STATUS_PENDING = 1;
  NOTIFICATION_STATUS_SENT = 2;
  NOTIFICATION_STATUS_DELIVERED = 3;
  NOTIFICATION_STATUS_FAILED = 4;
  NOTIFICATION_STATUS_READ = 5;
}

enum Priority {
  PRIORITY_UNSPECIFIED = 0;
  PRIORITY_LOW = 1;
  PRIORITY_NORMAL = 2;
  PRIORITY_HIGH = 3;
  PRIORITY_URGENT = 4;  // Bypasses Quiet Hours
}

enum Platform {
  PLATFORM_UNSPECIFIED = 0;
  PLATFORM_IOS = 1;
  PLATFORM_ANDROID = 2;
  PLATFORM_WEB = 3;
}

// ============================================================
// Core Notification Messages
// ============================================================

message SendNotificationRequest {
  string tenant_id = 1;
  string account_id = 2;
  NotificationType type = 3;
  repeated NotificationChannel channels = 4;
  string title = 5;
  string body = 6;
  string locale = 7;
  map<string, string> data = 8;
  string source_service = 9;
  Priority priority = 10;
  string idempotency_key = 11;           // Duplicate prevention
  google.protobuf.Timestamp expires_at = 12;  // TTL
}

message SendNotificationResponse {
  bool success = 1;
  string notification_id = 2;
  string message = 3;
}

message SendBulkNotificationRequest {
  string tenant_id = 1;
  repeated BulkNotificationItem notifications = 2;
  string source_service = 3;
}

message BulkNotificationItem {
  string account_id = 1;
  NotificationType type = 2;
  repeated NotificationChannel channels = 3;
  string title = 4;
  string body = 5;
  string locale = 6;
  map<string, string> data = 7;
  Priority priority = 8;
  string idempotency_key = 9;
}

message SendBulkNotificationResponse {
  bool success = 1;
  int32 total_count = 2;
  int32 sent_count = 3;
  int32 failed_count = 4;
  repeated BulkNotificationResult results = 5;
}

message BulkNotificationResult {
  string account_id = 1;
  bool success = 2;
  string notification_id = 3;
  string error = 4;
}

message GetNotificationsRequest {
  string tenant_id = 1;
  string account_id = 2;
  optional NotificationChannel channel = 3;
  optional bool unread_only = 4;
  int32 page = 5;
  int32 page_size = 6;
}

message GetNotificationsResponse {
  repeated NotificationItem notifications = 1;
  int32 total_count = 2;
  int32 unread_count = 3;
  int32 page = 4;
  int32 page_size = 5;
}

message NotificationItem {
  string id = 1;
  NotificationType type = 2;
  NotificationChannel channel = 3;
  string title = 4;
  string body = 5;
  map<string, string> data = 6;
  NotificationStatus status = 7;
  string source_service = 8;
  Priority priority = 9;
  google.protobuf.Timestamp read_at = 10;
  google.protobuf.Timestamp created_at = 11;
}

message MarkAsReadRequest {
  string tenant_id = 1;
  string account_id = 2;
  repeated string notification_ids = 3;
}

message MarkAsReadResponse {
  bool success = 1;
  int32 updated_count = 2;
}

message GetNotificationStatusRequest {
  string notification_id = 1;
}

message GetNotificationStatusResponse {
  string notification_id = 1;
  NotificationStatus status = 2;
  string channel = 3;
  string external_id = 4;  // FCM message ID, SMS ID, etc.
  google.protobuf.Timestamp sent_at = 5;
  google.protobuf.Timestamp delivered_at = 6;
  string error = 7;
  int32 retry_count = 8;
}

// ============================================================
// Preferences Messages
// ============================================================

message GetPreferencesRequest {
  string tenant_id = 1;
  string account_id = 2;
}

message GetPreferencesResponse {
  repeated ChannelPreference channel_preferences = 1;
  repeated TypePreference type_preferences = 2;
}

message ChannelPreference {
  NotificationChannel channel = 1;
  bool enabled = 2;
}

message TypePreference {
  NotificationType type = 1;
  repeated NotificationChannel enabled_channels = 2;
}

message UpdatePreferencesRequest {
  string tenant_id = 1;
  string account_id = 2;
  repeated ChannelPreference channel_preferences = 3;
  repeated TypePreference type_preferences = 4;
}

message UpdatePreferencesResponse {
  bool success = 1;
  string message = 2;
}

// ============================================================
// Device Token Messages
// ============================================================

message RegisterDeviceTokenRequest {
  string tenant_id = 1;
  string account_id = 2;
  string token = 3;
  Platform platform = 4;
  string device_id = 5;
  map<string, string> device_info = 6;  // app_version, os_version, etc.
}

message RegisterDeviceTokenResponse {
  bool success = 1;
  string device_token_id = 2;
  string message = 3;
}

message UnregisterDeviceTokenRequest {
  string tenant_id = 1;
  string account_id = 2;
  string token = 3;
}

message UnregisterDeviceTokenResponse {
  bool success = 1;
  string message = 2;
}

message GetDeviceTokensRequest {
  string tenant_id = 1;
  string account_id = 2;
}

message GetDeviceTokensResponse {
  repeated DeviceTokenItem tokens = 1;
}

message DeviceTokenItem {
  string id = 1;
  string token = 2;
  Platform platform = 3;
  string device_id = 4;
  google.protobuf.Timestamp last_used_at = 5;
  google.protobuf.Timestamp created_at = 6;
}

// ============================================================
// Quiet Hours Messages
// ============================================================

message GetQuietHoursRequest {
  string tenant_id = 1;
  string account_id = 2;
}

message GetQuietHoursResponse {
  bool enabled = 1;
  string start_time = 2;   // "22:00"
  string end_time = 3;     // "08:00"
  string timezone = 4;     // "Asia/Seoul"
}

message UpdateQuietHoursRequest {
  string tenant_id = 1;
  string account_id = 2;
  bool enabled = 3;
  string start_time = 4;
  string end_time = 5;
  string timezone = 6;
}

message UpdateQuietHoursResponse {
  bool success = 1;
  string message = 2;
}
```

- [ ] Update `packages/proto/buf.yaml`
- [ ] Run `pnpm generate`

**Verification:**

```bash
cd packages/proto && buf lint notification/v1/notification.proto
pnpm generate
ls packages/types/src/generated/proto/notification/v1/
```

---

# Part A: mail-service (Email Service)

## Execution Plan

### Phase 1 (Parallel) - Foundation Setup ✅

| Step | Task             | Status |
| ---- | ---------------- | ------ |
| 1    | Proto definition | ✅     |
| 2    | Project setup    | ✅     |
| 3    | Dockerfile       | ✅     |
| 4    | docker-compose   | ✅     |

### Phase 2 (Sequential) - Core Implementation ✅

| Step | Task            | Depends On | Status |
| ---- | --------------- | ---------- | ------ |
| 5    | Database design | Step 2     | ✅     |
| 6    | Core modules    | Step 5     | ✅     |
| 7    | i18n templates  | Step 6     | ✅     |
| 8    | gRPC Controller | Step 7     | ✅     |

### Phase 3 (Parallel) - Integration ⏳

| Step | Task              | Depends On   | Common Pattern      | Status |
| ---- | ----------------- | ------------ | ------------------- | ------ |
| 9    | Kafka Producer    | Step 8       | ✅ identity-service | ⏳     |
| 10   | Kafka Consumer    | Step 9       | ✅ identity-service | ⏳     |
| 10-1 | SES Webhook       | Step 8       | ✅ Standard NestJS  | ⏳     |
| 10-2 | Audit Integration | **Step 0-1** | ✅ AuditGrpcClient  | ⏳     |
| 11   | AWS SES           | Step 10      | ❌ New module       | ⏳     |

### Phase 4 (Sequential) - Deployment & Quality ⏳

| Step | Task                      | Depends On   | Common Pattern      | Status |
| ---- | ------------------------- | ------------ | ------------------- | ------ |
| 12   | gRPC Client (nest-common) | **Step 0-2** | ✅ Pattern exists   | ⏳     |
| 13   | Helm Chart                | Step 12      | ✅ identity-service | ✅     |
| 14   | Environment vars          | Step 13      | ✅                  | ✅     |
| 15   | Testing                   | Step 14      | ✅ vitest-config    | ⏳     |
| 16   | CDD docs                  | Step 15      | ✅                  | ⏳     |

---

# Part B: notification-service (Notification Hub)

## Execution Plan

### Phase 1 (Parallel) - Foundation Setup ⏳

| Step | Task             | Depends On     | Common Pattern  | Status  |
| ---- | ---------------- | -------------- | --------------- | ------- |
| N1   | Proto definition | **→ Step 0-0** | ✅ mail.proto   | (moved) |
| N2   | Project setup    | Step 0-0       | ✅ mail-service | ⏳      |
| N3   | Dockerfile       | Step N2        | ✅ mail-service | ⏳      |
| N4   | docker-compose   | Step N2        | ✅ mail-service | ⏳      |

### Phase 2 (Sequential) - Core Implementation ⏳

| Step | Task                | Depends On | Common Pattern  | Status |
| ---- | ------------------- | ---------- | --------------- | ------ |
| N5   | Database design     | Step N2    | ✅ Prisma       | ⏳     |
| N6   | Core modules        | Step N5    | ✅ mail-service | ⏳     |
| N7   | gRPC Controller     | Step N6    | ✅ mail-service | ⏳     |
| N8   | In-app Notification | Step N7    | ✅ Standard     | ⏳     |

### Phase 3 (Parallel) - Integration ⏳

| Step  | Task                 | Depends On   | Common Pattern     | Status |
| ----- | -------------------- | ------------ | ------------------ | ------ |
| N9    | Push (FCM/APNS)      | Step N8      | ❌ New module      | ⏳     |
| N10   | SMS Gateway          | Step N8      | ❌ New module (P1) | ⏳     |
| N11   | Mail-service routing | **Step 0-2** | ✅ MailGrpcClient  | ⏳     |
| N11-1 | Audit Integration    | **Step 0-1** | ✅ AuditGrpcClient | ⏳     |

### Phase 4 (Sequential) - Deployment & Quality ⏳

| Step | Task              | Depends On | Common Pattern   | Status |
| ---- | ----------------- | ---------- | ---------------- | ------ |
| N12  | Helm Chart        | Step N8    | ✅ mail-service  | ⏳     |
| N13  | Environment vars  | Step N12   | ✅ mail-service  | ⏳     |
| N14  | Testing           | Step N13   | ✅ vitest-config | ⏳     |
| N15  | CDD Documentation | Step N14   | ✅               | ⏳     |

### Phase 5 (Final) - Scope Completion ⏳

| Step | Task               | Depends On        | Status |
| ---- | ------------------ | ----------------- | ------ |
| F1   | Final CDD Review   | mail Step 16, N15 | ⏳     |
| F2   | Archive to History | Step F1           | ⏳     |

---

## Active

(Activated when implementation starts)

---

## Pending

### Step 1: Proto Definition

**Tasks:**

- [ ] Create `packages/proto/mail/v1/mail.proto`

  ```protobuf
  service MailService {
    rpc SendEmail(SendEmailRequest) returns (SendEmailResponse);
    rpc SendBulkEmail(SendBulkEmailRequest) returns (SendBulkEmailResponse);
    rpc GetEmailStatus(GetEmailStatusRequest) returns (GetEmailStatusResponse);
    rpc GetInbox(GetInboxRequest) returns (GetInboxResponse);
    rpc MarkAsRead(MarkAsReadRequest) returns (MarkAsReadResponse);
  }

  message SendEmailRequest {
    string tenant_id = 1;
    string account_id = 2;           // Recipient account ID (optional)
    string to_email = 3;
    EmailTemplate template = 4;
    string locale = 5;               // ko, en, ja, zh
    map<string, string> variables = 6;
    string source_service = 7;       // auth-bff, identity-service
    string from_email = 8;           // noreply@, support@
    map<string, string> metadata = 9;
  }

  enum EmailTemplate {
    EMAIL_TEMPLATE_UNSPECIFIED = 0;
    EMAIL_TEMPLATE_ADMIN_INVITE = 1;
    EMAIL_TEMPLATE_PARTNER_INVITE = 2;
    EMAIL_TEMPLATE_PASSWORD_RESET = 3;
    EMAIL_TEMPLATE_WELCOME = 4;
  }
  ```

- [ ] Update `packages/proto/buf.yaml`
- [ ] Run `pnpm generate`

**Verification:**

```bash
cd packages/proto && buf lint
pnpm generate
ls packages/types/src/generated/proto/mail/v1/
```

---

### Step 2: mail-service Project Setup

**Tasks:**

- [ ] Create `services/mail-service/` directory
- [ ] Create `package.json`
  - dependencies: @nestjs/core, @nestjs/microservices, @grpc/grpc-js
  - dependencies: @aws-sdk/client-ses, kafkajs, handlebars
  - dependencies: @prisma/client
  - devDependencies: @my-girok/vitest-config, typescript, prisma
- [ ] Create `tsconfig.json`
- [ ] Create `nest-cli.json`
- [ ] Create `.env.example`

**Verification:**

```bash
cd services/mail-service && pnpm install
pnpm build
```

---

### Step 3: Dockerfile

**Tasks:**

- [ ] Create `services/mail-service/Dockerfile`
  - Multi-stage build (builder, production)
  - pnpm fetch + install pattern
  - Include Proto generate
  - Include Prisma generate
  - goose migration support
  - Health check config (gRPC)
  - Non-root user (node)
- [ ] Create `services/mail-service/.dockerignore`

**Verification:**

```bash
docker build -t mail-service:test -f services/mail-service/Dockerfile .
docker run --rm mail-service:test node --version
```

---

### Step 4: docker-compose.yml.example Update

**Tasks:**

- [ ] Add mail-service to `docker-compose.yml.example`
  ```yaml
  mail-service:
    build:
      context: .
      dockerfile: services/mail-service/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      GRPC_PORT: 50054
      DATABASE_URL: postgresql://...
      KAFKA_BROKERS: redpanda:9092
      AWS_REGION: ap-northeast-2
      # ...
    ports:
      - '50054:50054'
  ```
- [ ] Add Redpanda (Kafka) service (if not exists)
  ```yaml
  redpanda:
    image: redpandadata/redpanda:v24.1.1
    command:
      - redpanda start
      - --smp 1
      - --memory 512M
      - --overprovisioned
      - --kafka-addr PLAINTEXT://0.0.0.0:9092
    ports:
      - '9092:9092'
      - '8081:8081' # Schema Registry
      - '8082:8082' # REST Proxy
  ```

**Verification:**

```bash
docker compose config
docker compose up mail-service redpanda -d
docker compose logs mail-service
```

---

### Step 5: Database Design

**Tasks:**

- [ ] Create `prisma/schema.prisma`

  ```prisma
  model EmailLog {
    id            String    @id @default(uuid())
    tenantId      String    @map("tenant_id")
    accountId     String?   @map("account_id")
    sourceService String    @map("source_service")
    fromEmail     String    @map("from_email")
    toEmail       String    @map("to_email")
    template      String
    locale        String    @default("en")
    subject       String
    status        EmailStatus @default(PENDING)
    messageId     String?   @map("message_id")
    sentAt        DateTime? @map("sent_at")
    error         String?
    metadata      Json?
    createdAt     DateTime  @default(now()) @map("created_at")

    inbox         Inbox?
    @@map("email_logs")
  }

  model Inbox {
    id          String    @id @default(uuid())
    tenantId    String    @map("tenant_id")
    accountId   String    @map("account_id")
    emailLogId  String    @unique @map("email_log_id")
    emailLog    EmailLog  @relation(fields: [emailLogId], references: [id])
    readAt      DateTime? @map("read_at")
    deletedAt   DateTime? @map("deleted_at")
    createdAt   DateTime  @default(now()) @map("created_at")

    @@index([tenantId, accountId])
    @@map("inboxes")
  }

  enum EmailStatus {
    PENDING
    SENT
    FAILED
    BOUNCED
  }
  ```

- [ ] Create `migrations/` goose SQL migration
- [ ] Create `src/prisma/prisma.module.ts`
- [ ] Create `src/prisma/prisma.service.ts`

**Verification:**

```bash
pnpm prisma migrate dev --name init
pnpm prisma studio
```

---

### Step 6: mail-service Core Modules

**Tasks:**

- [ ] `src/main.ts` - gRPC server bootstrap (port: 50054)
- [ ] `src/app.module.ts` - Root module
- [ ] `src/config/configuration.ts` - Environment variable loading
- [ ] `src/config/validation.ts` - Joi validation

**Verification:**

```bash
pnpm start:dev
grpcurl -plaintext localhost:50054 list
```

---

### Step 7: i18n Template System

**Tasks:**

- [ ] `src/templates/template.module.ts`
- [ ] `src/templates/template.service.ts`
  - `loadTemplate(template: string, locale: string)` - Load template
  - `render(template: string, locale: string, variables: object)` - Render
  - Fallback: Unsupported language → `en`
- [ ] `src/templates/admin-invite/en.hbs`
  ```handlebars
  <h1>Admin Invitation</h1>
  <p>{{inviterName}} has invited you as an administrator.</p>
  <p>Invitation Link: <a href='{{inviteLink}}'>{{inviteLink}}</a></p>
  <p>Temporary Password: {{temporaryPassword}}</p>
  <p>Expires: {{expiresAt}}</p>
  ```
- [ ] `src/templates/admin-invite/ko.hbs`
- [ ] `src/templates/partner-invite/{en,ko}.hbs`
- [ ] `src/templates/password-reset/{en,ko}.hbs`
- [ ] `src/templates/welcome/{en,ko}.hbs`
- [ ] `src/templates/template.service.spec.ts`

**Verification:**

```bash
pnpm test src/templates/template.service.spec.ts
```

---

### Step 8: gRPC Controller

**Tasks:**

- [ ] `src/mail/mail.module.ts`
- [ ] `src/mail/mail.controller.ts`
  - `@GrpcMethod('MailService', 'SendEmail')`
  - `@GrpcMethod('MailService', 'SendBulkEmail')`
  - `@GrpcMethod('MailService', 'GetEmailStatus')`
  - `@GrpcMethod('MailService', 'GetInbox')`
  - `@GrpcMethod('MailService', 'MarkAsRead')`
- [ ] `src/mail/mail.service.ts`
  - `sendEmail()` - Template render + Kafka publish
  - `getEmailStatus()` - Query EmailLog
  - `getInbox()` - Query Inbox
  - `markAsRead()` - Mark as read

**Verification:**

```bash
grpcurl -plaintext -d '{
  "tenant_id": "...",
  "to_email": "test@example.com",
  "template": "EMAIL_TEMPLATE_WELCOME",
  "locale": "ko",
  "source_service": "auth-bff",
  "from_email": "noreply@example.com",
  "variables": {"userName": "Test"}
}' localhost:50054 mail.v1.MailService/SendEmail
```

---

### Step 9: Kafka Producer

**Tasks:**

- [ ] `src/kafka/kafka.module.ts`
- [ ] `src/kafka/kafka.producer.ts`
  - Publish to `mail.send` topic
  - Message schema:
    ```json
    {
      "id": "uuid",
      "tenantId": "...",
      "accountId": "...",
      "sourceService": "auth-bff",
      "fromEmail": "noreply@...",
      "toEmail": "user@...",
      "template": "ADMIN_INVITE",
      "locale": "ko",
      "subject": "...",
      "body": "...",
      "metadata": {},
      "createdAt": "..."
    }
    ```
  - SASL authentication config

**Verification:**

```bash
kafka-console-consumer --topic mail.send --bootstrap-server localhost:9092 --from-beginning
```

---

### Step 10: Kafka Consumer

**Tasks:**

- [ ] `src/kafka/kafka.consumer.ts`
  - Subscribe to `mail.send` topic
  - Call AWS SES delivery
  - Update EmailLog status (SENT/FAILED)
  - Create Inbox record (if accountId exists)
  - **Call audit-service gRPC for auth-related emails** (see Audit Integration below)
  - Retry logic (3 times, exponential backoff)
  - DLQ handling: `mail.send.dlq`
- [ ] `src/kafka/kafka.consumer.spec.ts`

**Verification:**

```bash
docker logs mail-service | grep "mail.send"
kafka-console-consumer --topic mail.send.dlq --bootstrap-server localhost:9092
```

---

### Step 10-1: SES Webhook (Open/Click/Bounce Tracking)

**Tasks:**

- [ ] `src/webhook/webhook.module.ts`
- [ ] `src/webhook/webhook.controller.ts`
  - `POST /webhook/ses` - Receive SES SNS notification (REST endpoint)
  - Handle event types: Delivery, Open, Click, Bounce, Complaint
- [ ] `src/webhook/webhook.service.ts`
  - `handleOpen()` - Open event
    - Update EmailLog (openedAt)
    - **Call audit-service gRPC if auth-related**
  - `handleClick()` - Click event
    - **Call audit-service gRPC if auth-related**
  - `handleBounce()` - Bounce event
    - Update EmailLog status (BOUNCED)
    - **Call audit-service gRPC if auth-related**
  - `handleComplaint()` - Spam report handling
- [ ] `src/webhook/webhook.controller.spec.ts`

---

### Step 10-2: Audit Service Integration (CRITICAL)

**Architecture Flow:**

```
mail-service → audit-service gRPC → OTEL Collector → Kafka → ClickHouse
                    (LogAuthEvent)
```

**IMPORTANT**: Do NOT publish directly to Kafka audit.events topic. Use audit-service gRPC API.

**Tasks:**

- [ ] `src/audit/audit.module.ts`
- [ ] `src/audit/audit.service.ts`
  - Inject `AuditGrpcClient` from `@my-girok/nest-common`
  - `logMailEvent(type, emailLog)` - Log mail events via audit-service gRPC
    - Check if auth-related template
    - Call `LogAuthEvent` for auth templates
    - Call `LogSecurityEvent` for security-related (bounce, complaint)
- [ ] `src/audit/audit.service.spec.ts`

**audit-service gRPC calls:**

```typescript
// For auth-related emails (PASSWORD_RESET, MFA_CODE, etc.)
auditGrpcClient.logAuthEvent({
  tenantId,
  eventType: 'mail.sent',
  category: 'auth',
  level: 'HIGH',
  actorId: senderId,
  targetId: recipientId,
  details: {
    emailLogId,
    template,
    sourceService,
    recipientEmail,
  },
});

// For security events (bounce, complaint)
auditGrpcClient.logSecurityEvent({
  tenantId,
  eventType: 'mail.bounced',
  severity: 'MEDIUM',
  details: {
    emailLogId,
    bounceType,
    bounceReason,
  },
});
```

**Auth-Related Templates (Compliance Tracking Required):**

| Template           | Category     | Audit Level | gRPC Method  |
| ------------------ | ------------ | ----------- | ------------ |
| PASSWORD_RESET     | auth         | HIGH        | LogAuthEvent |
| EMAIL_VERIFICATION | auth         | HIGH        | LogAuthEvent |
| MFA_CODE           | auth         | HIGH        | LogAuthEvent |
| ACCOUNT_LOCKED     | auth         | HIGH        | LogAuthEvent |
| ACCOUNT_UNLOCKED   | auth         | HIGH        | LogAuthEvent |
| ADMIN_INVITE       | auth         | MEDIUM      | LogAuthEvent |
| PARTNER_INVITE     | auth         | MEDIUM      | LogAuthEvent |
| WELCOME            | notification | LOW         | (optional)   |

**Auth category events** are retained longer in audit-service (7 years) for compliance.

**AWS SES Setup Required:**

- Create Configuration Set (`mail-tracking`)
- Connect SNS Topic (Open, Click, Bounce, Complaint)
- Subscribe SNS → mail-service webhook

**Verification:**

```bash
# Verify audit-service received events (query ClickHouse via audit-service API)
curl http://localhost:3003/v1/audit/audit-logs?eventType=mail.sent
```

---

### Step 11: AWS SES Integration

**Tasks:**

- [ ] `src/ses/ses.module.ts`
- [ ] `src/ses/ses.service.ts`
  - `sendEmail(params)` - SES delivery
  - Log delivery result
  - Configuration Set tracking (open, click)
- [ ] `src/ses/ses.service.spec.ts` (mocking)

**Verification:**

```bash
pnpm test src/ses/ses.service.spec.ts
# Real delivery test (AWS SES Sandbox)
```

---

### Step 12: auth-bff gRPC Client

**Tasks:**

- [ ] `packages/nest-common/src/grpc/mail.client.ts`
  ```typescript
  @Injectable()
  export class MailGrpcClient {
    sendEmail(request: SendEmailRequest): Promise<SendEmailResponse>;
    sendBulkEmail(request: SendBulkEmailRequest): Promise<SendBulkEmailResponse>;
    getEmailStatus(request: GetEmailStatusRequest): Promise<GetEmailStatusResponse>;
    getInbox(request: GetInboxRequest): Promise<GetInboxResponse>;
    markAsRead(request: MarkAsReadRequest): Promise<MarkAsReadResponse>;
  }
  ```
- [ ] Update `packages/nest-common/src/grpc/grpc-clients.module.ts`
- [ ] Add export to `packages/nest-common/src/index.ts`
- [ ] Test usage in `services/auth-bff/`

**Verification:**

```bash
cd services/auth-bff && pnpm test:e2e
```

---

### Step 13: Helm Chart

**Tasks:**

- [ ] `services/mail-service/helm/Chart.yaml`
- [ ] `services/mail-service/helm/values.yaml.example`

  ```yaml
  replicaCount: 1
  image:
    repository: mail-service
    tag: latest

  grpc:
    port: 50054

  mail:
    kafka:
      brokers: 'kafka:9092'
      # Environment topic prefix: dev., release., "" (prod)
      topicPrefix: ''
      topics:
        send: 'mail.send' # → {prefix}mail.send
        dlq: 'mail.send.dlq' # → {prefix}mail.send.dlq
        # NOTE: audit.events is NOT used - use audit-service gRPC instead
      consumerGroup: 'mail-service-consumer'
      sasl:
        enabled: false
        mechanism: 'scram-sha-512'
        secretName: 'kafka-credentials'

    # Audit Service (gRPC) - for auth-related compliance tracking
    audit:
      enabled: true
      grpcUrl: 'audit-service:50054'

    ses:
      region: 'ap-northeast-2'
      fromAddresses:
        default: 'noreply@example.com'
        support: 'support@example.com'
      configurationSet: 'mail-tracking'

    i18n:
      defaultLocale: 'en'
      supportedLocales: ['en', 'ko', 'ja', 'zh']
      fallbackLocale: 'en'

    retry:
      maxAttempts: 3
      backoffMs: 1000
      backoffMultiplier: 2

  otel:
    enabled: true
    endpoint: 'http://otel-collector:4318'
  ```

- [ ] Create environment-specific values files
  - `values-dev.yaml` (topicPrefix: "dev.")
  - `values-staging.yaml` (topicPrefix: "release.")
  - `values-prod.yaml` (topicPrefix: "")
- [ ] `services/mail-service/helm/templates/deployment.yaml`
- [ ] `services/mail-service/helm/templates/service.yaml`
- [ ] `services/mail-service/helm/templates/sealed-secret.yaml`
- [ ] `services/mail-service/helm/templates/migration-job.yaml`
- [ ] `services/mail-service/helm/templates/configmap.yaml` (template files)

**Verification:**

```bash
helm template mail-service ./services/mail-service/helm
helm install mail-service ./services/mail-service/helm --dry-run -n my-girok
```

---

### Step 14: Environment Variables

**Tasks:**

- [ ] Complete `.env.example`

  ```bash
  # Server
  GRPC_PORT=50054

  # Database
  DATABASE_URL=postgresql://user:pass@localhost:5432/mail_db

  # Kafka (Redpanda) - for mail.send queue only
  KAFKA_BROKERS=localhost:9092
  KAFKA_CLIENT_ID=mail-service
  KAFKA_TOPIC_PREFIX=dev.              # dev., release., "" (prod)
  KAFKA_CONSUMER_GROUP=mail-service-consumer
  KAFKA_TOPIC_SEND=mail.send           # → {prefix}mail.send
  KAFKA_TOPIC_DLQ=mail.send.dlq        # → {prefix}mail.send.dlq
  # NOTE: No KAFKA_TOPIC_AUDIT - use audit-service gRPC instead
  KAFKA_SASL_ENABLED=false
  KAFKA_SASL_USERNAME=
  KAFKA_SASL_PASSWORD=
  KAFKA_SASL_MECHANISM=scram-sha-512

  # Audit Service (gRPC) - for auth-related compliance tracking
  AUDIT_SERVICE_GRPC_URL=localhost:50054
  AUDIT_SERVICE_ENABLED=true

  # AWS SES
  AWS_REGION=ap-northeast-2
  AWS_ACCESS_KEY_ID=
  AWS_SECRET_ACCESS_KEY=
  SES_FROM_EMAIL_DEFAULT=noreply@example.com
  SES_FROM_EMAIL_SUPPORT=support@example.com
  SES_CONFIGURATION_SET=mail-tracking

  # i18n
  I18N_DEFAULT_LOCALE=en
  I18N_SUPPORTED_LOCALES=en,ko,ja,zh
  I18N_FALLBACK_LOCALE=en

  # Retry
  RETRY_MAX_ATTEMPTS=3
  RETRY_BACKOFF_MS=1000
  RETRY_BACKOFF_MULTIPLIER=2

  # OTEL
  OTEL_EXPORTER_OTLP_ENDPOINT=
  OTEL_SERVICE_NAME=mail-service
  ```

**Verification:**

```bash
pnpm start:dev  # Joi validation pass
```

---

### Step 15: Testing

**Tasks:**

- [ ] Configure `vitest.config.ts`
- [ ] Unit Tests
  - [ ] `src/mail/mail.service.spec.ts`
  - [ ] `src/templates/template.service.spec.ts`
  - [ ] `src/kafka/kafka.producer.spec.ts`
  - [ ] `src/kafka/kafka.consumer.spec.ts`
  - [ ] `src/ses/ses.service.spec.ts`
- [ ] Integration Tests
  - [ ] gRPC endpoint tests
  - [ ] i18n template rendering tests
  - [ ] Kafka message publish/consume tests

**Verification:**

```bash
pnpm test
pnpm test:cov  # 80%+
```

---

### Step 16: CDD Documentation Update (Required on Completion)

**Tasks:**

- [ ] Create `.ai/services/mail-service.md`

  ````markdown
  # mail-service

  ```yaml
  port: N/A (no REST)
  grpc: 50054
  db: mail_db (PostgreSQL)
  cache: N/A
  events: mail.* (Redpanda)
  codebase: services/mail-service/
  ```

  ## Boundaries

  | Owns           | Not             |
  | -------------- | --------------- |
  | Email sending  | User management |
  | i18n Templates | Authentication  |
  | Send history   | -               |
  | Inbox          | -               |

  ## gRPC (50054)

  | Method         | Description  |
  | -------------- | ------------ |
  | SendEmail      | Single send  |
  | SendBulkEmail  | Bulk send    |
  | GetEmailStatus | Status query |
  | GetInbox       | Inbox query  |
  | MarkAsRead     | Mark as read |

  ## Tables

  | Table      | Purpose      |
  | ---------- | ------------ |
  | email_logs | Send history |
  | inboxes    | Inbox        |

  ## Events

  ```
  mail.send (produce)
  mail.send.dlq (produce on failure)
  ```
  ````

- [ ] Create `docs/llm/services/mail-service.md` (SSOT)
- [ ] Update `docs/llm/guides/grpc.md`

**Verification:**

```bash
ls .ai/services/mail-service.md
ls docs/llm/services/mail-service.md
grep "mail-service" docs/llm/guides/grpc.md
grep "50054" docs/llm/guides/grpc.md
```

---

## Completed (mail-service)

- Step 1-8: Proto, Project setup, Dockerfile, docker-compose, Database, Core modules, i18n templates, gRPC Controller
- Step 13-14: Helm Chart, Environment vars

---

## Blocked

(none)

---

## Notes (mail-service)

- All internal communication is gRPC
- Kafka uses Redpanda (Kafka compatible)
- **Kafka environment separation**: topicPrefix for dev./release./"" distinction
- i18n: Based on user locale, fallback → en
- **Solution-level tracking**: `sourceService` field tracks origin solution (my-girok, auth)
  - `my-girok`: Main B2C app/web service
  - `auth`: Authentication/Admin portal
- fromEmail required for sender identification
- Inbox: Created only when accountId exists
- On email send failure: Move to DLQ, retry 3 times
- Dockerfile follows identity-service pattern
- Helm values.yaml allows Kafka topics, i18n, retry configuration
- **audit-service integration**: Call audit-service gRPC (LogAuthEvent) for auth-related emails
  - Flow: mail-service → audit-service gRPC → OTEL Collector → Kafka → ClickHouse
  - Do NOT publish directly to Kafka audit.events topic
- **SES Webhook**: REST endpoint (`POST /webhook/ses`) receives SNS notifications
- Service user exposure (GetSentEmails etc.) is future spec

---

---

# Part B: notification-service - Detailed Steps

---

## Pending

### Step N1: Proto Definition

> **NOTE**: Proto definition moved to **Step 0-0** (Phase 0-A) to resolve dependency with NotificationGrpcClient.
> See Step 0-0 for full proto definition.

**Reference Step 0-0 for:**

- Complete NotificationService API definition
- Device Token management APIs
- Quiet Hours APIs
- Priority and idempotency support

---

### Step N2: notification-service Project Setup

**Tasks:**

- [ ] Create `services/notification-service/` directory
- [ ] Create `package.json`
  - dependencies: @nestjs/core, @nestjs/microservices, @grpc/grpc-js
  - dependencies: firebase-admin (FCM)
  - dependencies: @prisma/client
- [ ] Create `tsconfig.json`
- [ ] Create `nest-cli.json`
- [ ] Create `.env.example`

**Verification:**

```bash
cd services/notification-service && pnpm install && pnpm build
```

---

### Step N3: Dockerfile

**Tasks:**

- [ ] Create `services/notification-service/Dockerfile`
  - Multi-stage build (builder, production)
  - pnpm fetch + install pattern
  - Include Proto generate
  - Include Prisma generate
  - goose migration support
  - Health check config (gRPC)
  - Non-root user (node)

**Verification:**

```bash
docker build -t notification-service:test -f services/notification-service/Dockerfile .
```

---

### Step N4: docker-compose.yml.example Update

**Tasks:**

- [ ] Add notification-service to `docker-compose.yml.example`
  ```yaml
  notification-service:
    build:
      context: .
      dockerfile: services/notification-service/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      GRPC_PORT: 50055
      DATABASE_URL: postgresql://...
      FCM_PROJECT_ID: your-firebase-project
    ports:
      - '50055:50055'
  ```

**Verification:**

```bash
docker compose config
```

---

### Step N5: Database Design

**Tasks:**

- [ ] Create `prisma/schema.prisma`

  ```prisma
  // Notification Service - Notification DB Schema
  // Manages: notifications, preferences, device tokens, quiet hours

  generator client {
    provider        = "prisma-client-js"
    output          = "../node_modules/.prisma/notification-client"
    previewFeatures = ["relationJoins", "typedSql"]
  }

  datasource db {
    provider = "postgresql"
  }

  // ============================================================
  // NOTIFICATIONS
  // ============================================================

  model Notification {
    id            String             @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
    tenantId      String             @map("tenant_id") @db.Uuid
    accountId     String             @map("account_id") @db.Uuid
    type          String             @db.VarChar(50)
    channel       NotificationChannel
    title         String             @db.VarChar(255)
    body          String
    data          Json?              @db.JsonB
    sourceService String             @map("source_service") @db.VarChar(100)
    priority      Priority           @default(NORMAL)
    status        NotificationStatus @default(PENDING)
    externalId    String?            @map("external_id") @db.VarChar(255)  // FCM ID, SMS ID
    idempotencyKey String?           @unique @map("idempotency_key") @db.VarChar(255)
    sentAt        DateTime?          @map("sent_at") @db.Timestamptz(6)
    deliveredAt   DateTime?          @map("delivered_at") @db.Timestamptz(6)
    failedAt      DateTime?          @map("failed_at") @db.Timestamptz(6)
    readAt        DateTime?          @map("read_at") @db.Timestamptz(6)
    error         String?
    retryCount    Int                @default(0) @map("retry_count")
    expiresAt     DateTime?          @map("expires_at") @db.Timestamptz(6)
    createdAt     DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
    updatedAt     DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)

    @@index([tenantId, accountId])
    @@index([tenantId, accountId, readAt])
    @@index([tenantId, accountId, channel])
    @@index([status])
    @@index([sourceService])
    @@index([createdAt])
    @@map("notifications")
  }

  enum NotificationChannel {
    IN_APP
    PUSH
    SMS
    EMAIL

    @@map("notification_channel")
  }

  enum NotificationStatus {
    PENDING
    SENT
    DELIVERED
    FAILED
    READ

    @@map("notification_status")
  }

  enum Priority {
    LOW
    NORMAL
    HIGH
    URGENT  // Bypasses Quiet Hours

    @@map("priority")
  }

  // ============================================================
  // PREFERENCES
  // ============================================================

  model ChannelPreference {
    id        String             @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
    tenantId  String             @map("tenant_id") @db.Uuid
    accountId String             @map("account_id") @db.Uuid
    channel   NotificationChannel
    enabled   Boolean            @default(true)
    createdAt DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
    updatedAt DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)

    @@unique([tenantId, accountId, channel])
    @@map("channel_preferences")
  }

  model TypePreference {
    id              String             @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
    tenantId        String             @map("tenant_id") @db.Uuid
    accountId       String             @map("account_id") @db.Uuid
    notificationType String            @map("notification_type") @db.VarChar(50)
    enabledChannels NotificationChannel[]  @map("enabled_channels")
    createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
    updatedAt       DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)

    @@unique([tenantId, accountId, notificationType])
    @@map("type_preferences")
  }

  // ============================================================
  // DEVICE TOKENS (for Push Notifications)
  // ============================================================

  model DeviceToken {
    id         String    @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
    tenantId   String    @map("tenant_id") @db.Uuid
    accountId  String    @map("account_id") @db.Uuid
    token      String    @unique @db.VarChar(500)
    platform   Platform
    deviceId   String?   @map("device_id") @db.VarChar(255)
    deviceInfo Json?     @map("device_info") @db.JsonB  // app_version, os_version, etc.
    lastUsedAt DateTime  @default(now()) @map("last_used_at") @db.Timestamptz(6)
    createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
    updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

    @@index([tenantId, accountId])
    @@index([lastUsedAt])
    @@map("device_tokens")
  }

  enum Platform {
    IOS
    ANDROID
    WEB

    @@map("platform")
  }

  // ============================================================
  // QUIET HOURS (Do Not Disturb)
  // ============================================================

  model QuietHours {
    id        String   @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
    tenantId  String   @map("tenant_id") @db.Uuid
    accountId String   @map("account_id") @db.Uuid
    enabled   Boolean  @default(true)
    startTime String   @map("start_time") @db.VarChar(5)  // "22:00"
    endTime   String   @map("end_time") @db.VarChar(5)    // "08:00"
    timezone  String   @db.VarChar(50)                    // "Asia/Seoul"
    createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
    updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

    @@unique([tenantId, accountId])
    @@map("quiet_hours")
  }

  // ============================================================
  // GOOSE DB VERSION (for migration tracking)
  // ============================================================

  model goose_db_version {
    id         Int      @id @default(autoincrement())
    version_id BigInt
    is_applied Boolean
    tstamp     DateTime @default(now()) @db.Timestamp(6)
  }
  ```

- [ ] Create `migrations/` goose SQL migration

**Verification:**

```bash
pnpm prisma migrate dev --name init
pnpm prisma studio
```

---

### Step N6: Core Modules

**Tasks:**

- [ ] `src/main.ts` - gRPC server bootstrap (port: 50055)
- [ ] `src/app.module.ts` - Root module
- [ ] `src/config/configuration.ts` - Environment variable loading
- [ ] `src/config/validation.ts` - Joi validation
- [ ] `src/prisma/prisma.module.ts`
- [ ] `src/prisma/prisma.service.ts`

**Verification:**

```bash
pnpm start:dev
grpcurl -plaintext localhost:50055 list
```

---

### Step N7: gRPC Controller

**Tasks:**

- [ ] `src/notification/notification.module.ts`
- [ ] `src/notification/notification.controller.ts`
  - Core APIs:
    - `@GrpcMethod('NotificationService', 'SendNotification')`
    - `@GrpcMethod('NotificationService', 'SendBulkNotification')`
    - `@GrpcMethod('NotificationService', 'GetNotifications')`
    - `@GrpcMethod('NotificationService', 'MarkAsRead')`
    - `@GrpcMethod('NotificationService', 'GetNotificationStatus')`
  - Preferences:
    - `@GrpcMethod('NotificationService', 'GetPreferences')`
    - `@GrpcMethod('NotificationService', 'UpdatePreferences')`
  - Device Token:
    - `@GrpcMethod('NotificationService', 'RegisterDeviceToken')`
    - `@GrpcMethod('NotificationService', 'UnregisterDeviceToken')`
    - `@GrpcMethod('NotificationService', 'GetDeviceTokens')`
  - Quiet Hours:
    - `@GrpcMethod('NotificationService', 'GetQuietHours')`
    - `@GrpcMethod('NotificationService', 'UpdateQuietHours')`
- [ ] `src/notification/notification.service.ts`
- [ ] `src/device-token/device-token.module.ts`
- [ ] `src/device-token/device-token.service.ts`
- [ ] `src/preferences/preferences.module.ts`
- [ ] `src/preferences/preferences.service.ts`
- [ ] `src/quiet-hours/quiet-hours.module.ts`
- [ ] `src/quiet-hours/quiet-hours.service.ts`

**Verification:**

```bash
grpcurl -plaintext localhost:50055 notification.v1.NotificationService/GetNotifications
grpcurl -plaintext localhost:50055 notification.v1.NotificationService/GetDeviceTokens
grpcurl -plaintext localhost:50055 notification.v1.NotificationService/GetQuietHours
```

---

### Step N8: In-app Notification

**Tasks:**

- [ ] `src/channels/inapp/inapp.service.ts`
  - Store notification to database
  - Query notifications by accountId
  - Mark as read
- [ ] `src/channels/inapp/inapp.service.spec.ts`

**Verification:**

```bash
pnpm test src/channels/inapp
```

---

### Step N9: Push Notification (FCM/APNS)

**Tasks:**

- [ ] `src/channels/push/push.module.ts`
- [ ] `src/channels/push/push.service.ts`
  - Firebase Admin SDK integration
  - Send to device token
  - Topic subscription
- [ ] `src/channels/push/push.service.spec.ts`

**Verification:**

```bash
pnpm test src/channels/push
```

---

### Step N10: SMS Gateway

**Tasks:**

- [ ] `src/channels/sms/sms.module.ts`
- [ ] `src/channels/sms/sms.service.ts`
  - AWS SNS or Twilio integration
- [ ] `src/channels/sms/sms.service.spec.ts`

**Verification:**

```bash
pnpm test src/channels/sms
```

---

### Step N11: Mail-service Routing

**Tasks:**

- [ ] `src/channels/email/email.service.ts`
  - Call mail-service gRPC for email delivery
  - Use MailGrpcClient from nest-common
- [ ] `src/channels/email/email.service.spec.ts`

**Verification:**

```bash
pnpm test src/channels/email
```

---

### Step N12: Helm Chart

**Tasks:**

- [ ] `services/notification-service/helm/Chart.yaml`
- [ ] `services/notification-service/helm/values.yaml.example`
- [ ] `services/notification-service/helm/templates/deployment.yaml`
- [ ] `services/notification-service/helm/templates/service.yaml`
- [ ] `services/notification-service/helm/templates/sealed-secret.yaml`
- [ ] `services/notification-service/helm/templates/migration-job.yaml`

**Verification:**

```bash
helm template notification-service ./services/notification-service/helm
```

---

### Step N13: Environment Variables

**Tasks:**

- [ ] Complete `.env.example`

  ```bash
  # Server
  HTTP_PORT=3000
  GRPC_PORT=50055

  # Database
  DATABASE_URL=postgresql://user:pass@localhost:5432/notification_db

  # FCM (Firebase Cloud Messaging)
  FCM_PROJECT_ID=
  FCM_PRIVATE_KEY=
  FCM_CLIENT_EMAIL=

  # SMS Gateway (P1)
  SMS_PROVIDER=twilio  # or aws_sns
  SMS_ACCOUNT_SID=
  SMS_AUTH_TOKEN=
  SMS_FROM_NUMBER=

  # mail-service (for email routing)
  MAIL_SERVICE_GRPC_URL=localhost:50054

  # Audit Service (gRPC)
  AUDIT_SERVICE_GRPC_URL=localhost:50054
  AUDIT_SERVICE_ENABLED=true

  # CORS
  CORS_ORIGINS=http://localhost:3000

  # OTEL
  OTEL_EXPORTER_OTLP_ENDPOINT=
  OTEL_SERVICE_NAME=notification-service
  ```

**Verification:**

```bash
pnpm start:dev  # Joi validation pass
```

---

### Step N14: Testing

**Tasks:**

- [ ] Configure `vitest.config.ts`
- [ ] Unit Tests
  - [ ] `src/notification/notification.service.spec.ts`
  - [ ] `src/channels/inapp/inapp.service.spec.ts`
  - [ ] `src/channels/push/push.service.spec.ts`
  - [ ] `src/channels/sms/sms.service.spec.ts`
  - [ ] `src/channels/email/email.service.spec.ts`
  - [ ] `src/device-token/device-token.service.spec.ts`
  - [ ] `src/preferences/preferences.service.spec.ts`
  - [ ] `src/quiet-hours/quiet-hours.service.spec.ts`
- [ ] Integration Tests
  - [ ] gRPC endpoint tests
  - [ ] Channel routing tests
  - [ ] Quiet hours bypass tests (URGENT priority)

**Verification:**

```bash
pnpm test
pnpm test:cov  # 80%+
```

---

### Step N15: CDD Documentation Update (Required on Completion)

**Tasks:**

- [ ] Create `.ai/services/notification-service.md`

  ````markdown
  # notification-service

  ```yaml
  port: 3000 (health)
  grpc: 50055
  db: notification_db (PostgreSQL)
  cache: N/A
  events: N/A
  codebase: services/notification-service/
  ```

  ## Boundaries

  | Owns                 | Not             |
  | -------------------- | --------------- |
  | In-app notifications | Email sending   |
  | Push (FCM/APNS)      | User management |
  | SMS                  | Authentication  |
  | Device tokens        | -               |
  | User preferences     | -               |
  | Quiet hours          | -               |

  ## gRPC (50055)

  | Method                | Description             |
  | --------------------- | ----------------------- |
  | SendNotification      | Single notification     |
  | SendBulkNotification  | Bulk notifications      |
  | GetNotifications      | Query notifications     |
  | MarkAsRead            | Mark as read            |
  | GetNotificationStatus | Status query            |
  | GetPreferences        | Get user preferences    |
  | UpdatePreferences     | Update preferences      |
  | RegisterDeviceToken   | Register FCM/APNS token |
  | UnregisterDeviceToken | Remove token            |
  | GetDeviceTokens       | List user's tokens      |
  | GetQuietHours         | Get DND settings        |
  | UpdateQuietHours      | Update DND settings     |

  ## Tables

  | Table               | Purpose              |
  | ------------------- | -------------------- |
  | notifications       | Notification records |
  | channel_preferences | Channel on/off       |
  | type_preferences    | Type → channels      |
  | device_tokens       | FCM/APNS tokens      |
  | quiet_hours         | DND settings         |

  ## Channels

  | Channel | Provider       | Status |
  | ------- | -------------- | ------ |
  | IN_APP  | Database       | P0     |
  | PUSH    | FCM/APNS       | P0     |
  | EMAIL   | → mail-service | P0     |
  | SMS     | Twilio/SNS     | P1     |
  ````

- [ ] Create `docs/llm/services/notification-service.md` (SSOT)
- [ ] Update `docs/llm/guides/grpc.md` (add port 50055)

**Verification:**

```bash
ls .ai/services/notification-service.md
ls docs/llm/services/notification-service.md
grep "notification-service" docs/llm/guides/grpc.md
grep "50055" docs/llm/guides/grpc.md
```

---

# Part C: Scope Completion

---

### Step F1: Final CDD Review

> **Trigger**: All mail-service and notification-service tasks complete

**Tasks:**

- [ ] Review all CDD Tier 1 files created:
  - `.ai/services/mail-service.md`
  - `.ai/services/notification-service.md`
- [ ] Review all CDD Tier 2 files created:
  - `docs/llm/services/mail-service.md`
  - `docs/llm/services/notification-service.md`
- [ ] Verify `docs/llm/guides/grpc.md` updated with:
  - mail-service (port 50054)
  - notification-service (port 50055)
- [ ] Verify patterns documented if new patterns discovered
- [ ] Run `pnpm docs:generate` to update Tier 3-4 (if applicable)

**Verification:**

```bash
# All CDD files exist
ls .ai/services/mail-service.md
ls .ai/services/notification-service.md
ls docs/llm/services/mail-service.md
ls docs/llm/services/notification-service.md

# gRPC guide updated
grep -E "5005[45]" docs/llm/guides/grpc.md
```

---

### Step F2: Archive to History

> **Final step**: Merge scope + tasks into history archive

**Tasks:**

- [ ] Create history archive file with descriptive name:
  - `history/scopes/2026-01-mail-notification-services.md`
- [ ] Merge content from:
  - `scopes/2026-scope1.md` (scope definition)
  - `tasks/2026-scope1.md` (completed tasks)
- [ ] Archive format:

  ```markdown
  # Completed: 2026-Scope1 (Mail & Notification Services)

  > **Archived**: 2026-0X-XX | **Duration**: 2026-01 ~ 2026-02

  ## Summary

  - mail-service: Personal email inbox with AWS SES
  - notification-service: Unified notification hub (In-app, Push, SMS, Email routing)

  ## Deliverables

  | Service              | gRPC Port | Database        | Status |
  | -------------------- | --------- | --------------- | ------ |
  | mail-service         | 50054     | mail_db         | ✅     |
  | notification-service | 50055     | notification_db | ✅     |

  ## Key Decisions

  - [List key architectural decisions made]
  - [List pattern discoveries]

  ## CDD Updates

  - Created: `.ai/services/mail-service.md`
  - Created: `.ai/services/notification-service.md`
  - Updated: `docs/llm/guides/grpc.md`

  ## Lessons Learned

  - [Any lessons for future scopes]
  ```

- [ ] Delete active scope/task files (optional, or mark as archived)
- [ ] Update roadmap.md to mark items complete

**File Naming Convention:**

```
history/scopes/{date}-{descriptive-name}.md

Examples:
- 2026-01-mail-notification-services.md
- 2026-02-identity-platform-enhancements.md
- 2026-03-analytics-dashboard.md
```

**Verification:**

```bash
ls .specs/apps/web-admin/history/scopes/2026-01-mail-notification-services.md
```

---

## Notes (notification-service)

- gRPC port: 50055
- Channels: in-app, push (FCM), SMS, email (routes to mail-service)
- **Solution-level tracking**: `sourceService` field tracks origin solution (my-girok, auth)
  - `my-girok`: Main B2C app/web service
  - `auth`: Authentication/Admin portal
- User preferences stored per channel AND per notification type
- In-app notifications persisted to database
- Push uses Firebase Admin SDK
- Email routing calls mail-service via gRPC (not direct SES)
- **Priority levels**: LOW, NORMAL, HIGH, URGENT
  - `URGENT` bypasses Quiet Hours (DND) settings
  - Security-critical notifications (MFA, account locked) should use URGENT
- **Quiet Hours (DND)**: User-configurable do-not-disturb periods
  - Respects user timezone
  - Only affects non-URGENT notifications
- **Device Token Management**: Required for Push notifications
  - Tokens registered per account + platform (iOS, Android, Web)
  - Stale tokens cleaned up based on `lastUsedAt`
- **Idempotency**: `idempotencyKey` prevents duplicate notifications
  - Unique constraint in database
  - Important for retry scenarios
- **TTL**: `expiresAt` field for notification expiration
  - Notifications not sent after expiration
- **Retry strategy**: 3 retries with exponential backoff
  - Failed notifications tracked with `retryCount` and `error`
- **audit-service integration**: Same pattern as mail-service
  - Call audit-service gRPC for auth-related notifications

# Identity Platform Policy

> Multi-app user management platform with Zero Migration architecture (2025)

## Executive Summary

The Identity Platform enables rapid creation of multiple apps (N apps) with shared user management. Key design principles:

- **Services Combined, DBs Pre-Separated**: Single deployable unit with 3 separate databases
- **Zero Migration**: Extract services by copying module folders (no DB migration)
- **Redpanda-Ready**: Outbox pattern prepared for Debezium CDC (Kafka-compatible, no JVM)
- **UUIDv7**: All IDs use RFC 9562 UUIDv7 (time-sortable)

---

## Architecture Overview

### Current State (Limited Hardware)

```
┌──────────────────────────────────────────────────────────────────────┐
│                    Identity Service (Single Pod)                      │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐          │  │
│  │  │  Identity   │◄─►│    Auth     │◄─►│    Legal    │          │  │
│  │  │   Module    │   │   Module    │   │   Module    │          │  │
│  │  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘          │  │
│  │         │                 │                 │                  │  │
│  │    In-Process        In-Process        In-Process              │  │
│  └─────────┼─────────────────┼─────────────────┼──────────────────┘  │
│            │                 │                 │                     │
│            ▼                 ▼                 ▼                     │
│      identity_db         auth_db          legal_db                   │
│      (PostgreSQL)       (PostgreSQL)     (PostgreSQL)                │
│            │                 │                 │                     │
│            └─────────────────┼─────────────────┘                     │
│                              ▼                                       │
│                       outbox_events (per DB)                         │
│                              │                                       │
│                              ▼                                       │
│                    Polling Publisher (5s cron)                       │
└──────────────────────────────────────────────────────────────────────┘
```

### Future State (128 cores, 496GB RAM)

```
┌──────────────────────────────────────────────────────────────────────┐
│                    Separated Services (Zero Migration)                │
│                                                                       │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐        │
│  │  Identity   │       │    Auth     │       │    Legal    │        │
│  │  Service    │◄─────►│   Service   │◄─────►│   Service   │        │
│  └──────┬──────┘       └──────┬──────┘       └──────┬──────┘        │
│         │    gRPC             │    gRPC             │                │
│         ▼                     ▼                     ▼                │
│   identity_db             auth_db              legal_db              │
│         │                     │                     │                │
│         └─────────────────────┼─────────────────────┘                │
│                               ▼                                      │
│                        outbox_events                                 │
│                               │                                      │
│                               ▼                                      │
│                    Debezium CDC Connector                            │
│                               │                                      │
│                               ▼                                      │
│                         Redpanda                                     │
└──────────────────────────────────────────────────────────────────────┘
```

---

## Zero Migration Guarantee

### What Changes Between Phases

| Component            | Phase 1 (Now) | Phase 2 (Future)    | Migration      |
| -------------------- | ------------- | ------------------- | -------------- |
| Services             | 1 combined    | 3 separate          | Copy folder    |
| Databases            | 3 separate    | 3 separate (same)   | **None**       |
| Module Communication | In-Process    | gRPC                | Interface swap |
| Event Broker         | Polling       | Redpanda + Debezium | Config change  |
| Code Changes         | -             | -                   | **None**       |

### Service Extraction Steps

```bash
# Step 1: Copy module folder
cp -r services/identity-service/src/auth services/auth-service/src/

# Step 2: Copy Prisma schema
cp -r services/identity-service/prisma/auth services/auth-service/prisma/

# Step 3: Update Helm values (routing)
# services/auth-service routes to auth-service pod

# Step 4: Change module mode
AUTH_MODE=remote  # Switch from local to gRPC

# No database migration required!
```

---

## Database Schemas

> **All IDs use UUIDv7 (RFC 9562)** - Generated by application, not database

### identity_db

```sql
-- Accounts
CREATE TABLE accounts (
    id UUID PRIMARY KEY,  -- UUIDv7 from application
    email VARCHAR(255) NOT NULL UNIQUE,
    email_verified BOOLEAN DEFAULT FALSE,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    account_mode VARCHAR(20) DEFAULT 'SERVICE',
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Account Profiles
CREATE TABLE account_profiles (
    id UUID PRIMARY KEY,  -- UUIDv7
    account_id UUID NOT NULL REFERENCES accounts(id),
    name VARCHAR(100),
    avatar_url TEXT,
    phone VARCHAR(20),
    birth_date DATE,
    gender VARCHAR(20),
    UNIQUE(account_id)
);

-- Credentials
CREATE TABLE credentials (
    id UUID PRIMARY KEY,  -- UUIDv7
    account_id UUID NOT NULL REFERENCES accounts(id),
    type VARCHAR(20) NOT NULL,
    provider VARCHAR(50),
    credential_id TEXT,
    public_key TEXT,
    password_hash TEXT,
    oauth_provider_id TEXT,
    last_used_at TIMESTAMPTZ(6),
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Sessions
CREATE TABLE sessions (
    id UUID PRIMARY KEY,  -- UUIDv7
    account_id UUID NOT NULL REFERENCES accounts(id),
    device_id UUID REFERENCES devices(id),
    token_hash VARCHAR(64) NOT NULL,
    ip_address INET,
    user_agent TEXT,
    expires_at TIMESTAMPTZ(6) NOT NULL,
    revoked_at TIMESTAMPTZ(6),
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Devices
CREATE TABLE devices (
    id UUID PRIMARY KEY,  -- UUIDv7
    account_id UUID NOT NULL REFERENCES accounts(id),
    device_fingerprint VARCHAR(64) NOT NULL,
    device_name VARCHAR(100),
    device_type VARCHAR(20),
    os VARCHAR(50),
    browser VARCHAR(50),
    trusted BOOLEAN DEFAULT FALSE,
    last_seen_at TIMESTAMPTZ(6),
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- App Registry
CREATE TABLE app_registry (
    id UUID PRIMARY KEY,  -- UUIDv7
    slug VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(100) NOT NULL,
    domain VARCHAR(255) NOT NULL,
    identity_domain VARCHAR(255) NOT NULL,
    api_domain VARCHAR(255) NOT NULL,
    allowed_origins TEXT[],
    status VARCHAR(20) DEFAULT 'ACTIVE',
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Account-App Relationship
CREATE TABLE account_apps (
    id UUID PRIMARY KEY,  -- UUIDv7
    account_id UUID NOT NULL REFERENCES accounts(id),
    app_id UUID NOT NULL REFERENCES app_registry(id),
    status VARCHAR(20) DEFAULT 'ACTIVE',
    country_code CHAR(2) NOT NULL,
    joined_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    UNIQUE(account_id, app_id)
);

-- App Security Configs
CREATE TABLE app_security_configs (
    id UUID PRIMARY KEY,  -- UUIDv7
    app_id UUID NOT NULL REFERENCES app_registry(id) UNIQUE,
    security_level VARCHAR(20) DEFAULT 'STRICT',
    domain_validation_enabled BOOLEAN DEFAULT TRUE,
    allowed_domains TEXT[] DEFAULT '{}',
    jwt_validation_enabled BOOLEAN DEFAULT TRUE,
    jwt_aud_validation BOOLEAN DEFAULT TRUE,
    header_validation_enabled BOOLEAN DEFAULT TRUE,
    require_app_id BOOLEAN DEFAULT TRUE,
    require_app_secret BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    CONSTRAINT jwt_always_enabled CHECK (jwt_validation_enabled = TRUE)
);

-- App Test Modes
CREATE TABLE app_test_modes (
    id UUID PRIMARY KEY,  -- UUIDv7
    app_id UUID NOT NULL REFERENCES app_registry(id) UNIQUE,
    enabled BOOLEAN DEFAULT FALSE,
    allowed_ips CIDR[] NOT NULL DEFAULT '{}',
    expires_at TIMESTAMPTZ(6),
    disabled_layers TEXT[] DEFAULT '{}',
    enabled_by UUID,
    enabled_at TIMESTAMPTZ(6),
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    CONSTRAINT no_jwt_disable CHECK (NOT ('jwt' = ANY(disabled_layers))),
    CONSTRAINT max_duration CHECK (expires_at <= NOW() + INTERVAL '7 days')
);

-- App Service Status
CREATE TABLE app_service_status (
    id UUID PRIMARY KEY,  -- UUIDv7
    app_id UUID NOT NULL REFERENCES app_registry(id) UNIQUE,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    maintenance_enabled BOOLEAN DEFAULT FALSE,
    maintenance_message TEXT,
    maintenance_allowed_roles TEXT[] DEFAULT '{}',
    maintenance_start_at TIMESTAMPTZ(6),
    maintenance_end_at TIMESTAMPTZ(6),
    maintenance_allow_read_only BOOLEAN DEFAULT FALSE,
    shutdown_scheduled BOOLEAN DEFAULT FALSE,
    shutdown_scheduled_at TIMESTAMPTZ(6),
    shutdown_reason TEXT,
    shutdown_notify_users BOOLEAN DEFAULT TRUE,
    shutdown_data_retention_days INT DEFAULT 90,
    suspended_at TIMESTAMPTZ(6),
    suspended_by UUID,
    suspended_reason TEXT,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    CONSTRAINT valid_status CHECK (status IN ('ACTIVE', 'MAINTENANCE', 'SUSPENDED', 'TERMINATED'))
);

-- App Version Policies
CREATE TABLE app_version_policies (
    id UUID PRIMARY KEY,  -- UUIDv7
    app_id UUID NOT NULL REFERENCES app_registry(id),
    platform VARCHAR(20) NOT NULL,
    min_version VARCHAR(20) NOT NULL,
    recommended_version VARCHAR(20) NOT NULL,
    current_version VARCHAR(20) NOT NULL,
    force_update_enabled BOOLEAN DEFAULT TRUE,
    force_update_message TEXT DEFAULT 'Please update to continue using the app',
    force_update_store_url TEXT,
    soft_update_enabled BOOLEAN DEFAULT TRUE,
    soft_update_message TEXT DEFAULT 'A new version is available',
    soft_update_dismissible BOOLEAN DEFAULT TRUE,
    soft_update_remind_after_days INT DEFAULT 3,
    deprecated_versions TEXT[] DEFAULT '{}',
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    UNIQUE(app_id, platform)
);

-- Outbox Events (for Kafka-ready event publishing)
CREATE TABLE outbox_events (
    id UUID PRIMARY KEY,  -- UUIDv7 from application
    aggregate_type VARCHAR(50) NOT NULL,
    aggregate_id UUID NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    payload JSONB NOT NULL,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    published_at TIMESTAMPTZ(6)
);

CREATE INDEX idx_outbox_unpublished ON outbox_events (created_at)
    WHERE published_at IS NULL;
```

### auth_db

```sql
-- Roles
CREATE TABLE roles (
    id UUID PRIMARY KEY,  -- UUIDv7
    name VARCHAR(50) NOT NULL UNIQUE,
    display_name VARCHAR(100),
    description TEXT,
    level INT NOT NULL DEFAULT 0,
    scope VARCHAR(20) DEFAULT 'TENANT',
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Permissions
CREATE TABLE permissions (
    id UUID PRIMARY KEY,  -- UUIDv7
    code VARCHAR(100) NOT NULL UNIQUE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(50) NOT NULL,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Role-Permission Mapping
CREATE TABLE role_permissions (
    role_id UUID NOT NULL REFERENCES roles(id),
    permission_id UUID NOT NULL REFERENCES permissions(id),
    PRIMARY KEY (role_id, permission_id)
);

-- Admins
CREATE TABLE admins (
    id UUID PRIMARY KEY,  -- UUIDv7
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    name VARCHAR(100),
    scope VARCHAR(20) DEFAULT 'TENANT',
    tenant_id UUID,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    mfa_enabled BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Admin-Role Mapping
CREATE TABLE admin_roles (
    admin_id UUID NOT NULL REFERENCES admins(id),
    role_id UUID NOT NULL REFERENCES roles(id),
    PRIMARY KEY (admin_id, role_id)
);

-- Operators
CREATE TABLE operators (
    id UUID PRIMARY KEY,  -- UUIDv7
    admin_id UUID NOT NULL REFERENCES admins(id),
    app_id UUID NOT NULL,
    country_code CHAR(2) NOT NULL,
    name VARCHAR(100),
    email VARCHAR(255) NOT NULL,
    password_hash TEXT,
    status VARCHAR(20) DEFAULT 'PENDING',
    permissions TEXT[],
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Sanctions
CREATE TABLE sanctions (
    id UUID PRIMARY KEY,  -- UUIDv7
    account_id UUID NOT NULL,  -- References identity_db.accounts (no FK)
    type VARCHAR(20) NOT NULL,
    reason TEXT,
    expires_at TIMESTAMPTZ(6),
    issued_by UUID,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- API Keys
CREATE TABLE api_keys (
    id UUID PRIMARY KEY,  -- UUIDv7
    app_id UUID NOT NULL,
    name VARCHAR(100),
    key_hash VARCHAR(64) NOT NULL UNIQUE,
    key_prefix VARCHAR(10) NOT NULL,
    permissions TEXT[],
    rate_limit INT DEFAULT 1000,
    expires_at TIMESTAMPTZ(6),
    last_used_at TIMESTAMPTZ(6),
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Outbox Events
CREATE TABLE outbox_events (
    id UUID PRIMARY KEY,  -- UUIDv7
    aggregate_type VARCHAR(50) NOT NULL,
    aggregate_id UUID NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    payload JSONB NOT NULL,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    published_at TIMESTAMPTZ(6)
);

CREATE INDEX idx_outbox_unpublished ON outbox_events (created_at)
    WHERE published_at IS NULL;
```

### legal_db

```sql
-- Law Registry
CREATE TABLE laws (
    id UUID PRIMARY KEY,  -- UUIDv7
    code VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    country_code CHAR(2) NOT NULL,
    region VARCHAR(50),
    min_age INT NOT NULL,
    data_retention_days INT,
    effective_date DATE,
    description TEXT,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Law Requirements
CREATE TABLE law_requirements (
    id UUID PRIMARY KEY,  -- UUIDv7
    law_id UUID NOT NULL REFERENCES laws(id),
    consent_type VARCHAR(50) NOT NULL,
    is_required BOOLEAN DEFAULT FALSE,
    description TEXT,
    legal_basis TEXT
);

-- Countries
CREATE TABLE countries (
    code CHAR(2) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    law_id UUID REFERENCES laws(id),
    default_locale VARCHAR(10) DEFAULT 'en'
);

-- Consent Documents
CREATE TABLE consent_documents (
    id UUID PRIMARY KEY,  -- UUIDv7
    type VARCHAR(50) NOT NULL,
    version VARCHAR(20) NOT NULL,
    country_code CHAR(2) NOT NULL,
    locale VARCHAR(10) NOT NULL,
    title VARCHAR(200),
    content TEXT NOT NULL,
    effective_from TIMESTAMPTZ(6) NOT NULL,
    effective_until TIMESTAMPTZ(6),
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    UNIQUE(type, version, country_code, locale)
);

-- Account Consents
CREATE TABLE account_consents (
    id UUID PRIMARY KEY,  -- UUIDv7
    account_id UUID NOT NULL,  -- References identity_db.accounts (no FK)
    app_id UUID NOT NULL,      -- References identity_db.app_registry (no FK)
    consent_type VARCHAR(50) NOT NULL,
    document_id UUID REFERENCES consent_documents(id),
    granted BOOLEAN NOT NULL,
    granted_at TIMESTAMPTZ(6),
    revoked_at TIMESTAMPTZ(6),
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Data Subject Requests (GDPR DSR)
CREATE TABLE data_subject_requests (
    id UUID PRIMARY KEY,  -- UUIDv7
    account_id UUID NOT NULL,
    type VARCHAR(20) NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING',
    requested_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    processed_at TIMESTAMPTZ(6),
    processor_id UUID,
    notes TEXT
);

-- Consent History (Audit)
CREATE TABLE consent_history (
    id UUID PRIMARY KEY,  -- UUIDv7
    account_id UUID NOT NULL,
    consent_id UUID NOT NULL,
    action VARCHAR(20) NOT NULL,
    ip_address INET,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW()
);

-- Outbox Events
CREATE TABLE outbox_events (
    id UUID PRIMARY KEY,  -- UUIDv7
    aggregate_type VARCHAR(50) NOT NULL,
    aggregate_id UUID NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    payload JSONB NOT NULL,
    created_at TIMESTAMPTZ(6) NOT NULL DEFAULT NOW(),
    published_at TIMESTAMPTZ(6)
);

CREATE INDEX idx_outbox_unpublished ON outbox_events (created_at)
    WHERE published_at IS NULL;
```

---

## Data Isolation Patterns

### Pattern 1: Transactional Outbox

Ensures atomic database update and event publishing (no dual-write problem).

```typescript
// Same transaction: update + outbox insert
@Transactional()
async createAccount(dto: CreateAccountDto): Promise<Account> {
  const id = ID.generate(); // UUIDv7

  // Step 1: Create account
  const account = await this.prisma.accounts.create({
    data: { id, ...dto }
  });

  // Step 2: Write to outbox (same transaction)
  await this.prisma.outboxEvents.create({
    data: {
      id: ID.generate(),
      aggregateType: 'ACCOUNT',
      aggregateId: account.id,
      eventType: 'identity.account.created',
      payload: { accountId: account.id, email: account.email },
    }
  });

  return account;
}
```

### Pattern 2: Outbox Publisher

**Phase 1 (Now): Polling**

```typescript
@Injectable()
export class OutboxPollingPublisher {
  @Cron('*/5 * * * * *') // Every 5 seconds
  async publishPendingEvents() {
    const events = await this.prisma.outboxEvents.findMany({
      where: { publishedAt: null },
      orderBy: { createdAt: 'asc' },
      take: 100,
    });

    for (const event of events) {
      // Publish to NATS (or in-memory for now)
      await this.eventBus.publish(event.eventType, event.payload);

      // Mark as published
      await this.prisma.outboxEvents.update({
        where: { id: event.id },
        data: { publishedAt: new Date() },
      });
    }
  }
}
```

**Phase 2 (Future): Debezium CDC with Redpanda**

```yaml
# Redpanda + Debezium Connector Configuration
# Redpanda is Kafka API-compatible, no JVM required (C++ based)
# Benefits: Lower latency, simpler ops, perfect for homelab

apiVersion: redpanda.vectorized.io/v1alpha1
kind: Cluster
metadata:
  name: identity-redpanda
spec:
  replicas: 1 # Homelab: single node, scale later
  resources:
    requests:
      cpu: 1
      memory: 2Gi

---
# Debezium works with Redpanda via Kafka Connect
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaConnector
metadata:
  name: identity-outbox-connector
spec:
  class: io.debezium.connector.postgresql.PostgresConnector
  config:
    database.hostname: identity-db
    database.dbname: identity_db
    table.include.list: public.outbox_events
    transforms: outbox
    transforms.outbox.type: io.debezium.transforms.outbox.EventRouter
    transforms.outbox.table.field.event.id: id
    transforms.outbox.table.field.event.key: aggregate_id
    transforms.outbox.table.field.event.type: event_type
    transforms.outbox.table.field.event.payload: payload
```

### Pattern 3: Saga Orchestrator

For operations spanning multiple databases.

```typescript
// Saga State Machine
interface SagaStep {
  id: string;
  sagaId: string;
  stepName: string;
  status: 'PENDING' | 'COMPLETED' | 'COMPENSATED';
  data: Record<string, any>;
  createdAt: Date;
}

class RegistrationSaga {
  private steps: SagaStep[] = [];

  async execute(dto: RegisterDto): Promise<Account> {
    const sagaId = ID.generate();

    try {
      // Step 1: Create account (identity_db)
      const account = await this.identityModule.createAccount(dto);
      this.steps.push({
        id: ID.generate(),
        sagaId,
        stepName: 'CREATE_ACCOUNT',
        status: 'COMPLETED',
        data: { accountId: account.id },
        createdAt: new Date(),
      });

      // Step 2: Record consents (legal_db)
      await this.legalModule.recordConsents(account.id, dto.appId, dto.consents);
      this.steps.push({
        id: ID.generate(),
        sagaId,
        stepName: 'RECORD_CONSENTS',
        status: 'COMPLETED',
        data: { accountId: account.id },
        createdAt: new Date(),
      });

      return account;
    } catch (error) {
      await this.compensate();
      throw error;
    }
  }

  private async compensate(): Promise<void> {
    // Reverse order compensation
    for (const step of this.steps.reverse()) {
      if (step.status === 'COMPLETED') {
        switch (step.stepName) {
          case 'RECORD_CONSENTS':
            await this.legalModule.deleteConsents(step.data.accountId);
            break;
          case 'CREATE_ACCOUNT':
            await this.identityModule.deleteAccount(step.data.accountId);
            break;
        }
        step.status = 'COMPENSATED';
      }
    }
  }
}
```

### Pattern 4: API Composition

For queries spanning multiple modules (no cross-DB JOINs).

```typescript
@Injectable()
export class UserProfileComposer {
  constructor(
    @Inject('IIdentityModule') private identity: IIdentityModule,
    @Inject('IAuthModule') private auth: IAuthModule,
    @Inject('ILegalModule') private legal: ILegalModule,
  ) {}

  async getFullProfile(accountId: string, appId: string): Promise<UserProfile> {
    // Parallel queries to different databases
    const [account, sanctions, consents] = await Promise.all([
      this.identity.getAccount(accountId), // identity_db
      this.auth.getActiveSanctions(accountId), // auth_db
      this.legal.getConsents(accountId, appId), // legal_db
    ]);

    if (!account) {
      throw new NotFoundException('Account not found');
    }

    // Application-level composition
    return {
      id: account.id,
      email: account.email,
      status: account.status,
      isSanctioned: sanctions.length > 0,
      sanctions: sanctions.map((s) => ({
        type: s.type,
        reason: s.reason,
        expiresAt: s.expiresAt,
      })),
      consents: consents.map((c) => ({
        type: c.consentType,
        granted: c.granted,
        grantedAt: c.grantedAt,
      })),
    };
  }
}
```

---

## Module Interfaces (SSOT)

> Location: `packages/types/src/identity/interfaces.ts`

```typescript
// ============================================================
// IDENTITY MODULE INTERFACE
// ============================================================
export interface IIdentityModule {
  // Account operations
  getAccount(id: string): Promise<Account | null>;
  getAccountByEmail(email: string): Promise<Account | null>;
  createAccount(dto: CreateAccountDto): Promise<Account>;
  updateAccount(id: string, dto: UpdateAccountDto): Promise<Account>;
  deleteAccount(id: string): Promise<void>;

  // Session operations
  createSession(accountId: string, device: DeviceInfo): Promise<Session>;
  getSession(sessionId: string): Promise<Session | null>;
  revokeSession(sessionId: string): Promise<void>;
  revokeAllSessions(accountId: string): Promise<void>;

  // App Registry
  getApp(slug: string): Promise<AppRegistry | null>;
  getAppById(id: string): Promise<AppRegistry | null>;
  getAppSecurityConfig(appId: string): Promise<AppSecurityConfig | null>;
  getAppServiceStatus(appId: string): Promise<AppServiceStatus | null>;
  getAppVersionPolicy(appId: string, platform: string): Promise<AppVersionPolicy | null>;
}

// ============================================================
// AUTH MODULE INTERFACE
// ============================================================
export interface IAuthModule {
  // Sanctions
  getActiveSanctions(accountId: string): Promise<Sanction[]>;
  createSanction(dto: CreateSanctionDto): Promise<Sanction>;
  revokeSanction(sanctionId: string): Promise<void>;

  // Roles
  getAccountRoles(accountId: string, appId: string): Promise<Role[]>;
  assignRole(accountId: string, roleId: string): Promise<void>;
  revokeRole(accountId: string, roleId: string): Promise<void>;

  // Permissions
  getAccountPermissions(accountId: string, appId: string): Promise<string[]>;
}

// ============================================================
// LEGAL MODULE INTERFACE
// ============================================================
export interface ILegalModule {
  // Consents
  getRequiredConsents(appId: string, countryCode: string): Promise<ConsentRequirement[]>;
  getAccountConsents(accountId: string, appId: string): Promise<AccountConsent[]>;
  recordConsent(dto: RecordConsentDto): Promise<AccountConsent>;
  revokeConsent(consentId: string): Promise<void>;
  deleteConsents(accountId: string): Promise<void>;

  // DSR
  createDSR(dto: CreateDSRDto): Promise<DataSubjectRequest>;
  getDSRStatus(dsrId: string): Promise<DataSubjectRequest | null>;
}
```

### Implementation Strategy

```typescript
// ============================================================
// PHASE 1: IN-PROCESS IMPLEMENTATION
// ============================================================
@Injectable()
export class IdentityModuleLocal implements IIdentityModule {
  constructor(private prisma: IdentityPrismaService) {}

  async getAccount(id: string): Promise<Account | null> {
    return this.prisma.accounts.findUnique({ where: { id } });
  }

  async createAccount(dto: CreateAccountDto): Promise<Account> {
    const id = ID.generate(); // UUIDv7
    return this.prisma.accounts.create({ data: { id, ...dto } });
  }
  // ... other methods
}

// ============================================================
// PHASE 2: GRPC IMPLEMENTATION (SEPARATED)
// ============================================================
@Injectable()
export class IdentityModuleRemote implements IIdentityModule {
  constructor(private grpcClient: IdentityServiceClient) {}

  async getAccount(id: string): Promise<Account | null> {
    const response = await this.grpcClient.getAccount({ id });
    return response.account ?? null;
  }

  async createAccount(dto: CreateAccountDto): Promise<Account> {
    const response = await this.grpcClient.createAccount(dto);
    return response.account;
  }
  // ... other methods
}

// ============================================================
// MODULE CONFIGURATION (SWITCH VIA ENV)
// ============================================================
@Module({
  providers: [
    {
      provide: 'IIdentityModule',
      useFactory: (local: IdentityModuleLocal, remote: IdentityModuleRemote) => {
        return process.env.IDENTITY_MODE === 'remote' ? remote : local;
      },
      inject: [IdentityModuleLocal, IdentityModuleRemote],
    },
  ],
})
export class IdentityIntegrationModule {}
```

---

## Event Types (SSOT)

> Location: `packages/types/src/events/`

```typescript
// packages/types/src/events/identity.events.ts
export const IDENTITY_EVENTS = {
  // Account
  ACCOUNT_CREATED: 'identity.account.created',
  ACCOUNT_UPDATED: 'identity.account.updated',
  ACCOUNT_DELETED: 'identity.account.deleted',
  ACCOUNT_EMAIL_VERIFIED: 'identity.account.email_verified',

  // Session
  SESSION_CREATED: 'identity.session.created',
  SESSION_REVOKED: 'identity.session.revoked',

  // App
  APP_REGISTERED: 'identity.app.registered',
  APP_STATUS_CHANGED: 'identity.app.status_changed',
} as const;

export interface AccountCreatedEvent {
  type: typeof IDENTITY_EVENTS.ACCOUNT_CREATED;
  payload: {
    accountId: string;
    email: string;
    appId: string;
    countryCode: string;
    timestamp: string;
  };
}

// packages/types/src/events/auth.events.ts
export const AUTH_EVENTS = {
  SANCTION_CREATED: 'auth.sanction.created',
  SANCTION_REVOKED: 'auth.sanction.revoked',
  ROLE_ASSIGNED: 'auth.role.assigned',
  ROLE_REVOKED: 'auth.role.revoked',
} as const;

// packages/types/src/events/legal.events.ts
export const LEGAL_EVENTS = {
  CONSENT_GRANTED: 'legal.consent.granted',
  CONSENT_REVOKED: 'legal.consent.revoked',
  DSR_REQUESTED: 'legal.dsr.requested',
  DSR_COMPLETED: 'legal.dsr.completed',
} as const;
```

---

## Security Configuration

### Triple-Layer Access Control

```
Request → [Version Check] → [Service Status] → [Domain] → [JWT] → [Header] → Access
              │                    │               │          │         │
              ▼                    ▼               ▼          ▼         ▼
         426 or OK            503 or OK      Configurable  ALWAYS  Configurable
```

### Security Levels

| Level    | Domain | JWT | Header | Use Case              |
| -------- | ------ | --- | ------ | --------------------- |
| STRICT   | ✅     | ✅  | ✅     | Production (default)  |
| STANDARD | ❌     | ✅  | ✅     | Staging, internal API |
| RELAXED  | ❌     | ✅  | ❌     | Development, testing  |

> **CRITICAL**: JWT validation (Layer 2) is ALWAYS required and cannot be disabled.

### Test Mode

| Constraint     | Value     | Reason                         |
| -------------- | --------- | ------------------------------ |
| Max Duration   | 7 days    | Prevent forgotten test configs |
| IP Whitelist   | Required  | No public test access          |
| JWT Validation | Always ON | Security baseline              |
| Audit Logging  | Always ON | Compliance & debugging         |

---

## App Check API

### Endpoint

```
GET /v1/apps/{appSlug}/check
```

**No authentication required** - Called before login on app launch.

### Request

```http
GET /v1/apps/my-girok/check HTTP/1.1
Host: api.girok.dev
X-App-Platform: IOS
X-App-Version: 2.3.0
X-Device-ID: abc123 (optional)
```

### Response

```typescript
interface AppCheckResponse {
  version: {
    status: 'UP_TO_DATE' | 'UPDATE_AVAILABLE' | 'UPDATE_REQUIRED' | 'DEPRECATED';
    current: string;
    latest: string;
    minimum: string;
  };
  update?: {
    required: boolean;
    message: string;
    storeUrl: string;
  };
  service: {
    status: 'ACTIVE' | 'MAINTENANCE' | 'SUSPENDED';
    message?: string;
    estimatedEndAt?: string;
  };
  announcement?: {
    id: string;
    type: 'INFO' | 'WARNING' | 'CRITICAL';
    title: string;
    message: string;
    dismissible: boolean;
  };
  serverTime: string;
}
```

### HTTP Status Codes

| Status | Condition             | Client Action            |
| ------ | --------------------- | ------------------------ |
| 200    | Normal or soft update | Continue to app          |
| 426    | Force update required | Block, redirect to store |
| 503    | Maintenance mode      | Show maintenance screen  |
| 410    | App terminated        | Show termination notice  |

---

## Migration Roadmap

| Phase | Trigger  | Services  | Communication | Events       | Infra      |
| ----- | -------- | --------- | ------------- | ------------ | ---------- |
| 1     | Initial  | Combined  | In-Process    | Polling      | Minimal    |
| 2     | Hardware | Separated | gRPC          | Polling      | + gRPC     |
| 3     | Scale    | Separated | gRPC          | Redpanda CDC | + Redpanda |

### Phase 1 → Phase 2 (Service Separation)

```bash
# No code changes required, only:
1. Copy module folder to new service
2. Deploy new service
3. Update Gateway routing
4. Set MODULE_MODE=remote
```

### Phase 2 → Phase 3 (Redpanda Introduction)

```bash
# No code changes required, only:
1. Deploy Redpanda cluster (single node for homelab)
2. Deploy Debezium connectors (Kafka Connect)
3. Stop polling publishers
4. Set REDPANDA_ENABLED=true
```

### Why Redpanda over Kafka?

| Aspect    | Kafka               | Redpanda         |
| --------- | ------------------- | ---------------- |
| Runtime   | JVM (Java)          | Native (C++)     |
| Memory    | 6GB+ heap           | 1-2GB            |
| Latency   | ~10ms p99           | ~1ms p99         |
| Zookeeper | Required (or KRaft) | Not required     |
| Homelab   | Complex             | **Simple**       |
| API       | Kafka               | Kafka-compatible |

---

## 2025 Best Practices Compliance

| Standard                      | Status | Implementation          |
| ----------------------------- | ------ | ----------------------- |
| RFC 9562 (UUIDv7)             | ✅     | All IDs                 |
| RFC 9700 (OAuth 2.0 Security) | ✅     | PKCE, no implicit flow  |
| RFC 9068 (JWT Access Token)   | ✅     | `aud` claim, RS256      |
| RFC 9449 (DPoP)               | Ready  | Prepared for future     |
| NIST 800-207 (Zero Trust)     | ✅     | 3-Layer verification    |
| Transactional Outbox          | ✅     | Redpanda-ready          |
| Saga Pattern                  | ✅     | In-process, extractable |
| API Composition               | ✅     | No cross-DB JOIN        |
| GitOps                        | ✅     | Git as SSOT, ArgoCD     |

---

**LLM Reference**: `.ai/services/identity-service.md`

name: Reusable Service CI

on:
  workflow_call:
    inputs:
      service_name:
        description: 'Service name (e.g., auth-bff, identity-service)'
        required: true
        type: string
      service_path:
        description: 'Service directory path relative to repo root (e.g., services/auth-bff)'
        required: true
        type: string
      image_name:
        description: 'Docker image name (e.g., beegy-labs/auth-bff)'
        required: true
        type: string
      gitops_file_prefix:
        description: 'GitOps file prefix (e.g., my-girok-auth-bff, platform-identity-service)'
        required: true
        type: string
      needs_prisma:
        description: 'Whether service needs Prisma generation'
        required: false
        type: boolean
        default: false
      pnpm_filter:
        description: 'pnpm filter name (e.g., @my-girok/auth-bff)'
        required: true
        type: string
      force_build:
        description: 'Force build even if image exists'
        required: false
        type: boolean
        default: false
    secrets:
      GITEA_USERNAME:
        required: true
      GITEA_TOKEN:
        required: true
      GITOPS_PAT:
        required: true

env:
  REGISTRY: gitea.girok.dev

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ inputs.service_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    name: Check
    # Only run on PR (push to protected branches already passed PR checks)
    if: github.event_name == 'pull_request'
    runs-on: [self-hosted, kubernetes, gitops]
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '24' }
      - uses: pnpm/action-setup@v4
      - uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/pnpm/store
            node_modules
            ${{ inputs.service_path }}/node_modules
            packages/types/node_modules
            packages/nest-common/node_modules
          key: ${{ runner.os }}-pnpm-${{ inputs.service_name }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-${{ inputs.service_name }}-
            ${{ runner.os }}-pnpm-
      - run: pnpm install --frozen-lockfile --prefer-offline

      # Download pre-built proto files from Gitea (REQUIRED - no fallback)
      - name: Download proto files
        id: download-proto
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          # Calculate proto hash (same logic as build-proto.yml)
          HASH=$(find packages/proto -type f \( -name "*.proto" -o -name "buf.gen.yaml" -o -name "buf.yaml" \) -exec sha256sum {} \; | sort | sha256sum | cut -c1-12)
          echo "ðŸ“¦ Proto hash: ${HASH}"
          echo "hash=${HASH}" >> $GITHUB_OUTPUT

          # Download from Gitea generic package
          mkdir -p packages/types/src/generated
          START_TIME=$(date +%s)

          # Download tarball with clear error message
          if ! curl -f -L \
            -H "Authorization: token ${GITEA_TOKEN}" \
            "https://${{ env.REGISTRY }}/api/packages/beegy-labs/generic/proto-generated/${HASH}/proto-generated.tar.gz" \
            -o /tmp/proto-generated.tar.gz; then
            echo ""
            echo "âŒ Proto package not found in Gitea registry"
            echo ""
            echo "Expected hash: ${HASH}"
            echo "Package URL: https://${{ env.REGISTRY }}/beegy-labs/-/packages/generic/proto-generated/${HASH}"
            echo ""
            echo "ðŸ”§ To fix this issue:"
            echo "1. Manually trigger the 'Build Proto' workflow:"
            echo "   GitHub UI â†’ Actions â†’ Build Proto â†’ Run workflow â†’ Run on: ${{ github.ref_name }}"
            echo ""
            echo "2. Or push a change to packages/proto/ to trigger automatic build"
            echo ""
            echo "âš ï¸  Fallback to local generation is NOT available (Buf rate limit)"
            echo ""
            exit 1
          fi

          # Download checksum (optional, for verification)
          if ! curl -f -L \
            -H "Authorization: token ${GITEA_TOKEN}" \
            "https://${{ env.REGISTRY }}/api/packages/beegy-labs/generic/proto-generated/${HASH}/proto-generated.sha256" \
            -o /tmp/proto-generated.sha256; then
            echo "âš ï¸  Checksum file not found, skipping verification"
            echo "   This is expected for packages uploaded before checksum was implemented"
          else
            # Verify checksum
            EXPECTED_CHECKSUM=$(cat /tmp/proto-generated.sha256)
            ACTUAL_CHECKSUM=$(sha256sum /tmp/proto-generated.tar.gz | cut -d' ' -f1)

            if [ "${EXPECTED_CHECKSUM}" != "${ACTUAL_CHECKSUM}" ]; then
              echo "âš ï¸  Checksum mismatch (non-fatal, package may be from before checksum implementation)"
              echo "   Expected: ${EXPECTED_CHECKSUM}"
              echo "   Actual:   ${ACTUAL_CHECKSUM}"
              echo "   Continuing with download (tarball hash matches proto source hash: ${HASH})"
            else
              echo "ðŸ”’ Checksum verified: ${ACTUAL_CHECKSUM}"
            fi
          fi

          # Extract
          tar -xzf /tmp/proto-generated.tar.gz -C packages/types/src/generated/

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          PACKAGE_SIZE=$(du -h /tmp/proto-generated.tar.gz | cut -f1)

          echo "âœ… Downloaded and extracted proto files (${HASH})"
          echo "â±ï¸  Download time: ${DURATION}s"
          echo "ðŸ“¦ Package size: ${PACKAGE_SIZE}"

          # Save metrics for summary
          echo "duration=${DURATION}" >> $GITHUB_OUTPUT
          echo "size=${PACKAGE_SIZE}" >> $GITHUB_OUTPUT

      # Proto cache summary
      - name: Proto cache summary
        if: always() && steps.download-proto.outcome == 'success'
        run: |
          echo "## Proto Cache Metrics ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: Gitea package registry (cache hit âœ…)" >> $GITHUB_STEP_SUMMARY
          echo "- **Hash**: \`${{ steps.download-proto.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Download time**: ${{ steps.download-proto.outputs.duration }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **Package size**: ${{ steps.download-proto.outputs.size }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Checksum verified**: âœ…" >> $GITHUB_STEP_SUMMARY

      - run: pnpm --filter @my-girok/types build

      - name: Generate Prisma client
        if: inputs.needs_prisma
        run: pnpm --filter ${{ inputs.pnpm_filter }} prisma:generate

      - run: pnpm --filter @my-girok/nest-common build

      # Build service to ensure compiled code is valid
      - name: Build service
        working-directory: ${{ inputs.service_path }}
        run: pnpm build

      - name: Test and lint
        working-directory: ${{ inputs.service_path }}
        run: pnpm test && pnpm lint:check

  build:
    name: Build
    # Run on push or workflow_dispatch to protected branches
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && contains(fromJSON('["develop", "release", "main"]'), github.ref_name)
    runs-on: [self-hosted, kubernetes, gitops]
    timeout-minutes: 60
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      skipped: ${{ steps.check_image.outputs.exists }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GITEA_USERNAME }}
          password: ${{ secrets.GITEA_TOKEN }}
      - name: Meta
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          case "${{ github.ref_name }}" in
            main) TAG="${SHORT_SHA}"; TAGS="${{ env.REGISTRY }}/${{ inputs.image_name }}:${TAG},${{ env.REGISTRY }}/${{ inputs.image_name }}:latest" ;;
            develop) TAG="develop-${SHORT_SHA}"; TAGS="${{ env.REGISTRY }}/${{ inputs.image_name }}:${TAG},${{ env.REGISTRY }}/${{ inputs.image_name }}:develop" ;;
            release) TAG="release-${SHORT_SHA}"; TAGS="${{ env.REGISTRY }}/${{ inputs.image_name }}:${TAG},${{ env.REGISTRY }}/${{ inputs.image_name }}:release" ;;
            *) TAG="develop-${SHORT_SHA}"; TAGS="${{ env.REGISTRY }}/${{ inputs.image_name }}:${TAG}" ;;
          esac
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
      - name: Check if image exists
        id: check_image
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          if [ "${{ inputs.force_build }}" = "true" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ Force build requested, skipping image check"
            exit 0
          fi
          TAG="${{ steps.meta.outputs.tag }}"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${GITEA_TOKEN}" \
            "${{ env.REGISTRY }}/api/v1/packages/beegy-labs/container/${{ inputs.service_name }}/${TAG}")
          if [ "$RESPONSE" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Image ${TAG} already exists, skipping build"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ Image ${TAG} not found, proceeding with build"
          fi
      - uses: docker/build-push-action@v5
        if: steps.check_image.outputs.exists != 'true'
        with:
          context: .
          file: ./${{ inputs.service_path }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ inputs.image_name }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ inputs.image_name }}:buildcache,mode=max

  deploy:
    name: Deploy
    if: always() && needs.build.result == 'success'
    needs: build
    runs-on: [self-hosted, kubernetes, gitops]
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          repository: beegy-labs/platform-gitops
          token: ${{ secrets.GITOPS_PAT }}
          path: gitops
      - name: Update & Push
        run: |
          cd gitops && git pull --rebase
          case "${{ github.ref_name }}" in
            main) FILE="clusters/home/values/${{ inputs.gitops_file_prefix }}-prod.yaml"; ENV="production" ;;
            develop) FILE="clusters/home/values/${{ inputs.gitops_file_prefix }}-dev.yaml"; ENV="development" ;;
            release) FILE="clusters/home/values/${{ inputs.gitops_file_prefix }}-staging.yaml"; ENV="staging" ;;
            *) FILE="clusters/home/values/${{ inputs.gitops_file_prefix }}-dev.yaml"; ENV="development" ;;
          esac
          # Only update the service image tag (under top-level image:), not migration image tags
          # Use awk to update only the first tag: after image: section starts
          awk -v newtag="${{ needs.build.outputs.tag }}" '
            /^image:/ { in_image=1 }
            in_image && /^[a-z]/ && !/^image:/ { in_image=0 }
            in_image && /tag:/ { sub(/tag: ".*"/, "tag: \"" newtag "\""); in_image=0 }
            { print }
          ' ${FILE} > ${FILE}.tmp && mv ${FILE}.tmp ${FILE}
          git config user.name "GitHub Actions Bot"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${FILE}
          git diff --staged --quiet || git commit -m "chore(${ENV}): update ${{ inputs.service_name }} to ${{ needs.build.outputs.tag }}"
          for i in 1 2 3; do git push && break || { sleep 3; git pull --rebase; }; done
      - name: Cleanup
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          case "${{ github.ref_name }}" in
            main) P="" ;;
            develop) P="develop-" ;;
            release) P="release-" ;;
            *) P="develop-" ;;
          esac
          curl -s -H "Authorization: token ${GITEA_TOKEN}" "https://gitea.girok.dev/api/v1/packages/beegy-labs/container/${{ inputs.service_name }}" | \
            jq -r ".[] | select(.version | startswith(\"${P}\")) | \"\(.created_at)|\(.version)\"" | sort -r | tail -n +11 | \
            while IFS='|' read -r _ v; do curl -sX DELETE -H "Authorization: token ${GITEA_TOKEN}" "https://gitea.girok.dev/api/v1/packages/beegy-labs/container/${{ inputs.service_name }}/${v}"; done

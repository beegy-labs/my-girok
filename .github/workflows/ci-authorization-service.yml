name: CI - Authorization Service

on:
  push:
    branches: [develop, release, main]
    paths:
      - 'services/authorization-service/**'
      - 'packages/**'
      - 'pnpm-lock.yaml'
  pull_request:
    branches: [develop, release, main]
    paths:
      - 'services/authorization-service/**'
      - 'packages/**'
      - 'pnpm-lock.yaml'
  workflow_dispatch:
    inputs:
      deploy_env:
        description: 'Deploy environment'
        required: false
        default: 'develop'
        type: choice
        options:
          - develop
          - release
          - main

env:
  REGISTRY: gitea.girok.dev
  IMAGE_NAME: beegy-labs/authorization-service

jobs:
  check:
    name: Check
    runs-on: [self-hosted, kubernetes, gitops]
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '22' }
      - uses: pnpm/action-setup@v4
      - uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/pnpm/store
            node_modules
            services/authorization-service/node_modules
            packages/types/node_modules
            packages/nest-common/node_modules
          key: ${{ runner.os }}-pnpm-authorization-${{ hashFiles('**/pnpm-lock.yaml') }}
      - run: pnpm install --frozen-lockfile --prefer-offline
      - run: pnpm --filter @my-girok/types build
      - run: pnpm --filter @my-girok/authorization-service prisma:generate
      - run: pnpm --filter @my-girok/nest-common build
      - run: cd services/authorization-service && pnpm test && pnpm lint

  build:
    needs: check
    name: Build
    runs-on: [self-hosted, kubernetes, gitops]
    timeout-minutes: 10
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.GITEA_USERNAME }}
          password: ${{ secrets.GITEA_TOKEN }}
      - name: Meta
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          DEPLOY_ENV="${{ inputs.deploy_env || 'develop' }}"
          case "${DEPLOY_ENV}" in
            main) TAG="${SHORT_SHA}"; TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" ;;
            develop) TAG="develop-${SHORT_SHA}"; TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop" ;;
            release) TAG="release-${SHORT_SHA}"; TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:release" ;;
            *) TAG="develop-${SHORT_SHA}"; TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}" ;;
          esac
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "deploy_env=${DEPLOY_ENV}" >> $GITHUB_OUTPUT
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/authorization-service/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    name: Deploy
    needs: build
    runs-on: [self-hosted, kubernetes, gitops]
    timeout-minutes: 5
    steps:
      - name: Update image tag
        run: |
          DEPLOY_ENV="${{ inputs.deploy_env || 'develop' }}"
          VALUES_FILE=""
          case "${DEPLOY_ENV}" in
            develop) VALUES_FILE="my-girok-authorization-service-dev.yaml" ;;
            release) VALUES_FILE="my-girok-authorization-service-release.yaml" ;;
            main) VALUES_FILE="my-girok-authorization-service-prod.yaml" ;;
          esac

          if [ -n "${VALUES_FILE}" ]; then
            cd /workspace/platform-gitops
            git pull origin develop

            # Update image tag in values file
            sed -i "s|tag: .*|tag: \"${{ needs.build.outputs.tag }}\"|g" clusters/home/values/${VALUES_FILE}

            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add clusters/home/values/${VALUES_FILE}
            git commit -m "chore(development): update authorization-service to ${DEPLOY_ENV}-${{ needs.build.outputs.tag }}" || echo "No changes to commit"
            git push origin develop
          fi

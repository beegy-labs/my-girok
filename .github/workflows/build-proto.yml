name: Build Proto

on:
  push:
    branches: [develop, release, main]
    paths:
      - 'packages/proto/**'
      - '.github/workflows/build-proto.yml'
  pull_request:
    branches: [develop, release, main]
    paths:
      - 'packages/proto/**'
      - '.github/workflows/build-proto.yml'
  workflow_dispatch:

# Prevent duplicate builds
concurrency:
  group: proto-build
  cancel-in-progress: false # Allow existing build to complete

env:
  REGISTRY: gitea.girok.dev

jobs:
  build:
    name: Build and Upload Proto
    runs-on: [self-hosted, kubernetes, gitops]
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: '24' }

      - uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --filter @my-girok/proto

      # Calculate hash of proto source files (for versioning)
      - name: Calculate proto hash
        id: proto-hash
        run: |
          HASH=$(find packages/proto -type f \( -name "*.proto" -o -name "buf.gen.yaml" -o -name "buf.yaml" \) -exec sha256sum {} \; | sort | sha256sum | cut -c1-12)
          echo "hash=${HASH}" >> $GITHUB_OUTPUT
          echo "üì¶ Proto hash: ${HASH}"

      # Check if package already exists
      - name: Check if proto package exists
        id: check-package
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          HASH="${{ steps.proto-hash.outputs.hash }}"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${GITEA_TOKEN}" \
            "https://${{ env.REGISTRY }}/api/packages/beegy-labs/generic/proto-generated/${HASH}")

          if [ "$RESPONSE" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Proto package ${HASH} already exists, skipping build"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "üî® Proto package ${HASH} not found, proceeding with build"
          fi

      # Generate proto files
      - name: Generate proto files
        if: steps.check-package.outputs.exists != 'true'
        run: pnpm --filter @my-girok/proto generate

      # Package generated files
      - name: Package proto files
        if: steps.check-package.outputs.exists != 'true'
        run: |
          cd packages/types/src/generated
          tar -czf /tmp/proto-generated.tar.gz proto/

          # Calculate checksum for verification
          sha256sum /tmp/proto-generated.tar.gz | cut -d' ' -f1 > /tmp/proto-generated.sha256

          PACKAGE_SIZE=$(du -h /tmp/proto-generated.tar.gz | cut -f1)
          CHECKSUM=$(cat /tmp/proto-generated.sha256)
          echo "üì¶ Packaged ${PACKAGE_SIZE} proto files"
          echo "üîí SHA256: ${CHECKSUM}"

      # Upload to Gitea generic package registry
      - name: Upload to Gitea
        if: steps.check-package.outputs.exists != 'true'
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          HASH="${{ steps.proto-hash.outputs.hash }}"

          # Upload tarball
          curl -X PUT \
            -H "Authorization: token ${GITEA_TOKEN}" \
            --upload-file /tmp/proto-generated.tar.gz \
            "https://${{ env.REGISTRY }}/api/packages/beegy-labs/generic/proto-generated/${HASH}/proto-generated.tar.gz"

          # Upload checksum
          curl -X PUT \
            -H "Authorization: token ${GITEA_TOKEN}" \
            --upload-file /tmp/proto-generated.sha256 \
            "https://${{ env.REGISTRY }}/api/packages/beegy-labs/generic/proto-generated/${HASH}/proto-generated.sha256"

          echo "‚úÖ Uploaded proto package: ${HASH}"
          echo "üìç URL: https://${{ env.REGISTRY }}/beegy-labs/-/packages/generic/proto-generated/${HASH}"

      # Job summary
      - name: Build summary
        if: steps.check-package.outputs.exists != 'true'
        run: |
          echo "## Proto Build Summary üì¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Hash**: \`${{ steps.proto-hash.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Package size**: $(du -h /tmp/proto-generated.tar.gz | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Checksum**: \`$(cat /tmp/proto-generated.sha256)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ env.REGISTRY }}/beegy-labs/-/packages/generic/proto-generated/${{ steps.proto-hash.outputs.hash }}" >> $GITHUB_STEP_SUMMARY

      # Cleanup old packages (keep last 20)
      - name: Cleanup old packages
        if: steps.check-package.outputs.exists != 'true' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
        env:
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
        run: |
          echo "üóëÔ∏è  Cleaning up old proto packages (keeping last 20)..."

          # Get all versions, sort by creation date, keep last 20, delete rest
          curl -s -H "Authorization: token ${GITEA_TOKEN}" \
            "https://${{ env.REGISTRY }}/api/packages/beegy-labs/generic/proto-generated" | \
            jq -r '.[] | "\(.created_at)|\(.version)"' | sort -r | tail -n +21 | \
            while IFS='|' read -r created version; do
              echo "  Deleting ${version} (created: ${created})"
              curl -sX DELETE \
                -H "Authorization: token ${GITEA_TOKEN}" \
                "https://${{ env.REGISTRY }}/api/packages/beegy-labs/generic/proto-generated/${version}"
            done

          echo "‚úÖ Cleanup complete"

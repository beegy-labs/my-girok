version: '3.9'

# My-Girok Docker Compose Configuration Example
#
# USAGE:
#   1. Copy this file: cp docker-compose.yml.example docker-compose.yml
#   2. Edit docker-compose.yml with your settings
#   3. Start services: docker compose up -d
#
# IMPORTANT:
#   - docker-compose.yml is gitignored - never commit your actual configuration
#   - Customize for your environment (development, staging, production)

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: my-girok-postgres
    restart: unless-stopped
    environment:
      # CHANGE THESE VALUES
      POSTGRES_USER: ${DB_USER:-your_db_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change-this-password}
      POSTGRES_DB: ${DB_NAME:-your_db_name}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-your_db_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - my-girok-network

  # Redpanda (Kafka-compatible message broker)
  redpanda:
    image: redpandadata/redpanda:v24.1.1
    container_name: my-girok-redpanda
    restart: unless-stopped
    command:
      - redpanda start
      - --smp 1
      - --memory 512M
      - --overprovisioned
      - --kafka-addr PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr PLAINTEXT://redpanda:9092
    ports:
      - "${KAFKA_PORT:-9092}:9092"
      - "${SCHEMA_REGISTRY_PORT:-8081}:8081"
      - "${KAFKA_REST_PORT:-8082}:8082"
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD", "rpk", "cluster", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - my-girok-network

  # Redis Cache (Optional)
  redis:
    image: redis:7-alpine
    container_name: my-girok-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - my-girok-network

  # ClickHouse - Analytics and Audit Database
  clickhouse:
    image: clickhouse/clickhouse-server:24.3-alpine
    container_name: my-girok-clickhouse
    restart: unless-stopped
    environment:
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-change-this-password}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_NATIVE_PORT:-9000}:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./infrastructure/clickhouse/schemas:/docker-entrypoint-initdb.d
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - my-girok-network

  # Identity Service - Core user management platform
  identity-service:
    build:
      context: .
      dockerfile: services/identity-service/Dockerfile
    container_name: my-girok-identity-service
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3000
      DATABASE_URL: postgresql://${DB_USER:-your_db_user}:${DB_PASSWORD:-change-this-password}@postgres:5432/${DB_IDENTITY_NAME:-identity_dev}?schema=public
      JWT_SECRET: ${JWT_SECRET:-change-this-to-secure-secret-min-32-chars}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-change-this-to-secure-refresh-secret}
      JWT_ACCESS_EXPIRATION: ${JWT_ACCESS_EXPIRATION:-15m}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-14d}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - my-girok-network

  # Auth Service - Authentication and authorization
  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    container_name: my-girok-auth-service
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      identity-service:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3001
      DATABASE_URL: postgresql://${DB_USER:-your_db_user}:${DB_PASSWORD:-change-this-password}@postgres:5432/${DB_AUTH_NAME:-auth_dev}?schema=public
      JWT_SECRET: ${JWT_SECRET:-change-this-to-secure-secret-min-32-chars}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-change-this-to-secure-refresh-secret}
      JWT_ACCESS_EXPIRATION: ${JWT_ACCESS_EXPIRATION:-15m}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-7d}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      IDENTITY_SERVICE_URL: http://identity-service:3000
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # OAuth Credentials (Optional)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL:-http://localhost:3001/api/v1/auth/google/callback}
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID:-}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET:-}
      KAKAO_CALLBACK_URL: ${KAKAO_CALLBACK_URL:-http://localhost:3001/api/v1/auth/kakao/callback}
      NAVER_CLIENT_ID: ${NAVER_CLIENT_ID:-}
      NAVER_CLIENT_SECRET: ${NAVER_CLIENT_SECRET:-}
      NAVER_CALLBACK_URL: ${NAVER_CALLBACK_URL:-http://localhost:3001/api/v1/auth/naver/callback}
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - my-girok-network

  # Legal Service - GDPR, Consent, DSR management
  legal-service:
    build:
      context: .
      dockerfile: services/legal-service/Dockerfile
    container_name: my-girok-legal-service
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      identity-service:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3005
      DATABASE_URL: postgresql://${DB_USER:-your_db_user}:${DB_PASSWORD:-change-this-password}@postgres:5432/${DB_LEGAL_NAME:-legal_dev}?schema=public
      JWT_SECRET: ${JWT_SECRET:-change-this-to-secure-secret-min-32-chars}
      IDENTITY_SERVICE_URL: http://identity-service:3000
    ports:
      - "3005:3005"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3005/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - my-girok-network

  # Personal Service
  personal-service:
    build:
      context: .
      dockerfile: services/personal-service/Dockerfile
    container_name: my-girok-personal-service
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3002
      DATABASE_URL: postgresql://${DB_USER:-your_db_user}:${DB_PASSWORD:-change-this-password}@postgres:5432/${DB_PERSONAL_NAME:-girok_personal}?schema=public
      JWT_SECRET: ${JWT_SECRET:-change-this-to-secure-secret-min-32-chars}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "3002:3002"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3002/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - my-girok-network

  # Audit Service - Compliance and Logging (ClickHouse)
  audit-service:
    build:
      context: .
      dockerfile: services/audit-service/Dockerfile
    container_name: my-girok-audit-service
    restart: unless-stopped
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3003
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 8123
      CLICKHOUSE_DATABASE: audit_db
      CLICKHOUSE_USERNAME: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-change-this-password}
      JWT_SECRET: ${JWT_SECRET:-change-this-to-secure-secret-min-32-chars}
    ports:
      - "3003:3003"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - my-girok-network

  # Analytics Service - Business Intelligence (ClickHouse)
  analytics-service:
    build:
      context: .
      dockerfile: services/analytics-service/Dockerfile
    container_name: my-girok-analytics-service
    restart: unless-stopped
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3004
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 8123
      CLICKHOUSE_DATABASE: analytics_db
      CLICKHOUSE_USERNAME: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-change-this-password}
      JWT_SECRET: ${JWT_SECRET:-change-this-to-secure-secret-min-32-chars}
    ports:
      - "3004:3004"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3004/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - my-girok-network

  # Web Main Application
  web-girok:
    build:
      context: .
      dockerfile: apps/web-girok/Dockerfile
    container_name: my-girok-web-girok
    restart: unless-stopped
    depends_on:
      auth-service:
        condition: service_healthy
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:3001}
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - my-girok-network

  # Mail Service - Email sending and tracking (gRPC)
  mail-service:
    build:
      context: .
      dockerfile: services/mail-service/Dockerfile
    container_name: my-girok-mail-service
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      # Ports
      HTTP_PORT: 3000
      GRPC_PORT: 50054
      # CORS (for HTTP health endpoints)
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
      # Database
      DATABASE_URL: postgresql://${DB_USER:-your_db_user}:${DB_PASSWORD:-change-this-password}@postgres:5432/${DB_MAIL_NAME:-mail_dev}?schema=public
      # Kafka (for mail.send queue only)
      KAFKA_BROKERS: redpanda:9092
      KAFKA_CLIENT_ID: mail-service
      KAFKA_TOPIC_PREFIX: ${KAFKA_TOPIC_PREFIX:-}
      KAFKA_CONSUMER_GROUP: mail-service-consumer
      # Audit Service (gRPC) - for auth-related compliance tracking
      # Flow: mail-service → audit-service gRPC → OTEL Collector → Kafka → ClickHouse
      AUDIT_SERVICE_ENABLED: "true"
      AUDIT_SERVICE_GRPC_URL: audit-service:50054
      # AWS SES
      AWS_REGION: ${AWS_REGION:-ap-northeast-2}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      SES_FROM_EMAIL_DEFAULT: ${SES_FROM_EMAIL_DEFAULT:-noreply@example.com}
      SES_FROM_EMAIL_SUPPORT: ${SES_FROM_EMAIL_SUPPORT:-support@example.com}
      SES_CONFIGURATION_SET: ${SES_CONFIGURATION_SET:-mail-tracking}
      # i18n
      I18N_DEFAULT_LOCALE: en
      I18N_FALLBACK_LOCALE: en
      # OpenTelemetry
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-}
      OTEL_SERVICE_NAME: mail-service
    ports:
      # HTTP health check (internal only in production)
      - "3054:3000"
      # gRPC server
      - "50054:50054"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - my-girok-network

  # Notification Service - Push notifications and SMS (gRPC)
  notification-service:
    build:
      context: .
      dockerfile: services/notification-service/Dockerfile
    container_name: my-girok-notification-service
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      # Ports
      HTTP_PORT: 3000
      GRPC_PORT: 50055
      # CORS (for HTTP health endpoints)
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
      # Database
      DATABASE_URL: postgresql://${DB_USER:-your_db_user}:${DB_PASSWORD:-change-this-password}@postgres:5432/${DB_NOTIFICATION_NAME:-notification_dev}?schema=public
      # Kafka
      KAFKA_BROKERS: redpanda:9092
      KAFKA_CLIENT_ID: notification-service
      KAFKA_TOPIC_PREFIX: ${KAFKA_TOPIC_PREFIX:-}
      KAFKA_CONSUMER_GROUP: notification-service-consumer
      # Firebase Cloud Messaging (FCM)
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID:-}
      FIREBASE_CLIENT_EMAIL: ${FIREBASE_CLIENT_EMAIL:-}
      FIREBASE_PRIVATE_KEY: ${FIREBASE_PRIVATE_KEY:-}
      # SMS Provider (Twilio)
      SMS_PROVIDER: ${SMS_PROVIDER:-twilio}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER:-}
      # AWS (for SNS SMS - alternative)
      AWS_REGION: ${AWS_REGION:-ap-northeast-2}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      # Audit Service
      AUDIT_SERVICE_ENABLED: "true"
      AUDIT_SERVICE_GRPC_URL: audit-service:50053
      # OpenTelemetry
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-}
      OTEL_SERVICE_NAME: notification-service
    ports:
      # HTTP health check (internal only in production)
      - "3055:3000"
      # gRPC server
      - "50055:50055"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - my-girok-network

  # Storybook - Design System Documentation
  storybook:
    build:
      context: .
      dockerfile: apps/storybook/Dockerfile
    container_name: my-girok-storybook
    restart: unless-stopped
    ports:
      - "6006:6006"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6006/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - my-girok-network

# Persistent Volumes
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  clickhouse_data:
    driver: local
  redpanda_data:
    driver: local

# Network
networks:
  my-girok-network:
    driver: bridge

# ==============================================================================
# ENVIRONMENT-SPECIFIC CONFIGURATIONS
# ==============================================================================
#
# DEVELOPMENT:
#   - Use local PostgreSQL and Redis
#   - Enable source code volumes for hot reload
#   - Use development secrets
#   - Set NODE_ENV=development
#
# STAGING:
#   - May use external database
#   - Production-like configuration
#   - Set NODE_ENV=staging
#   - Use proper secrets
#
# PRODUCTION:
#   - MUST use external managed database (RDS, Cloud SQL)
#   - MUST use external Redis (ElastiCache, Memorystore)
#   - MUST use strong secrets
#   - MUST enable HTTPS
#   - Set NODE_ENV=production
#   - Consider using Docker Swarm or Kubernetes for scaling
#
# ==============================================================================
# DEPLOYMENT TIPS
# ==============================================================================
#
# For production:
# 1. Remove postgres and redis services (use managed services)
# 2. Update DATABASE_URL to point to external database
# 3. Use docker-compose.override.yml for local customizations
# 4. Enable resource limits:
#
#    deploy:
#      resources:
#        limits:
#          cpus: '1.0'
#          memory: 512M
#        reservations:
#          cpus: '0.25'
#          memory: 256M
#
# 5. Enable replicas for high availability:
#
#    deploy:
#      replicas: 3
#
# 6. Add logging:
#
#    logging:
#      driver: "json-file"
#      options:
#        max-size: "10m"
#        max-file: "3"
#
# ==============================================================================

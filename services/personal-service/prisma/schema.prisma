// Personal Service Database Schema
// Korean Developer Resume + Budget + Share

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/personal-client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== Resume Models ==========

model Resume {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String  @map("user_id") @db.Uuid // Multiple resumes per user

  // Resume Metadata
  title       String // "회사용", "프리랜서용", "스타트업용", etc.
  description String? // Brief description of resume purpose
  isDefault   Boolean @default(false) @map("is_default") // Default resume to show
  paperSize   PaperSize @default(A4) @map("paper_size") // Preferred paper size for PDF export

  // Basic Info
  name      String
  email     String
  phone     String?
  address   String? // Address (City/District level, e.g., "서울특별시 강남구")
  github    String?
  blog      String?
  linkedin  String?
  portfolio String?

  // Summary
  summary String?

  // Key Achievements (주요 성과)
  keyAchievements String[] @default([]) @map("key_achievements") // 3-5 major accomplishments

  // Profile Image (URL to MinIO)
  profileImage String? @map("profile_image")

  // Birth Date and Gender
  birthDate String? @map("birth_date") // Full birth date (YYYY-MM-DD format) for accurate age calculation
  gender    Gender? // Gender (MALE, FEMALE, OTHER, PREFER_NOT_TO_SAY)

  // Korean-specific fields
  militaryService           MilitaryService? @map("military_service") // Military service status
  militaryDischarge         String?          @map("military_discharge") // Example: "Sergeant Discharge", "2020.01 - 2021.10"
  // Detailed military service information
  militaryRank              String?          @map("military_rank") // Rank (e.g., "Sergeant", "Corporal")
  militaryDischargeType     String?          @map("military_discharge_type") // Discharge type (e.g., "Honorable Discharge", "Medical Discharge")
  militaryServiceStartDate  String?          @map("military_service_start_date") // Service start date (YYYY-MM format)
  militaryServiceEndDate    String?          @map("military_service_end_date") // Service end date (YYYY-MM format)
  coverLetter               String?          @map("cover_letter") @db.Text // Cover letter
  applicationReason         String?          @map("application_reason") @db.Text // Application reason

  // Copy status for async file operations (when copying resume with attachments)
  copyStatus       CopyStatus? @map("copy_status") // null = not a copy, or copy without attachments
  copyJobId        String?     @map("copy_job_id") // BullMQ job ID for tracking
  copyCompletedAt  DateTime?   @map("copy_completed_at") @db.Timestamptz(6)

  // Attachments
  attachments ResumeAttachment[]

  // Sections (ordered and toggleable)
  sections ResumeSection[]

  // Skills
  skills Skill[]

  // Experiences
  experiences Experience[]

  // Education
  educations Education[]

  // Certificates
  certificates Certificate[]

  // Share Links
  shares ShareLink[] @relation("ResumeShares")

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6) // Soft delete for GDPR compliance

  @@index([userId])
  @@index([userId, isDefault])
  @@map("resumes")
}

// Section visibility and ordering
model ResumeSection {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId String  @map("resume_id") @db.Uuid
  resume   Resume  @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  type    SectionType // SKILLS, EXPERIENCE, PROJECT, EDUCATION, CERTIFICATE
  order   Int         @default(0) // Display order
  visible Boolean     @default(true) // Show/hide toggle

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([resumeId, type])
  @@index([resumeId, order])
  @@map("resume_sections")
}

enum SectionType {
  SKILLS
  EXPERIENCE
  PROJECT
  EDUCATION
  CERTIFICATE
}

enum PaperSize {
  A4
  LETTER
}

enum Gender {
  MALE              // Male
  FEMALE            // Female
  OTHER             // Other
  PREFER_NOT_TO_SAY // Prefer not to say
}

enum MilitaryService {
  COMPLETED       // Completed
  EXEMPTED        // Exempted
  NOT_APPLICABLE  // Not Applicable
}

enum DegreeType {
  HIGH_SCHOOL  // High school graduate
  ASSOCIATE_2  // Associate degree (2-year)
  ASSOCIATE_3  // Associate degree (3-year, Korea-specific)
  BACHELOR     // Bachelor's degree (4-year)
  MASTER       // Master's degree
  DOCTORATE    // Doctorate/PhD
}

enum GpaFormat {
  SCALE_4_0   // 4.0 scale (US: 3.8/4.0)
  SCALE_4_5   // 4.5 scale (KR: 4.2/4.5)
  SCALE_100   // 100-point scale (JP: 85/100)
}

// Copy status for async file operations
enum CopyStatus {
  PENDING     // Copy job queued
  IN_PROGRESS // Copy job processing
  COMPLETED   // All attachments copied successfully
  PARTIAL     // Some attachments failed to copy
  FAILED      // All attachments failed to copy
}

// Resume File Attachments (profile photos, portfolios, certificates)
model ResumeAttachment {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId String @map("resume_id") @db.Uuid
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  // File metadata
  type         AttachmentType // PROFILE_PHOTO, PORTFOLIO, CERTIFICATE, OTHER
  fileName     String         @map("file_name") // Original filename
  fileKey      String         @map("file_key") // MinIO object key (UUID-based)
  fileUrl      String         @map("file_url") // Full MinIO URL
  fileSize     Int            @map("file_size") // Size in bytes
  mimeType     String         @map("mime_type") // image/jpeg, application/pdf, etc.

  // Processing metadata
  isProcessed  Boolean        @default(false) @map("is_processed") // Grayscale conversion done
  originalUrl  String?        @map("original_url") // Original color image URL (before grayscale)

  // Display metadata
  title        String? // User-defined title (e.g., "Portfolio 2024")
  description  String? // Description
  order        Int     @default(0) // Display order
  visible      Boolean @default(true) // Show/hide toggle

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([resumeId, type])
  @@index([resumeId, order])
  @@index([fileKey])
  @@map("resume_attachments")
}

enum AttachmentType {
  PROFILE_PHOTO  // Interview photo (will be converted to grayscale)
  PORTFOLIO      // Portfolio documents (PDF, images)
  CERTIFICATE    // Certificate images
  OTHER          // Other attachments
}

// Skills (Frontend, Backend, DevOps, etc.)
model Skill {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId String @map("resume_id") @db.Uuid
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  category String // Frontend, Backend, DevOps, Database, Tools, etc.
  items    Json   // [{ name: "React", level: "상", description: "3년 실무 경험" }]
  order    Int    @default(0)
  visible  Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([resumeId, order])
  @@map("skills")
}

// Work Experience (unified with projects)
model Experience {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId String @map("resume_id") @db.Uuid
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  company   String
  startDate String  @map("start_date") // "2023-01" format
  endDate   String? @map("end_date") // null or empty if currently working
  isCurrentlyWorking Boolean @default(false) @map("is_currently_working") // 재직중

  // Final position and job title at this company
  finalPosition String  @map("final_position") // 최종 직책 (e.g., "Backend Team Lead")
  jobTitle      String  @map("job_title")      // 직급 (e.g., "Senior Developer")

  // Salary information (optional, per company)
  salary     Int?     // Salary amount at this company
  salaryUnit String?  @map("salary_unit") // e.g., "만원", "USD", "EUR", "JPY"
  showSalary Boolean? @default(false) @map("show_salary") // Show in preview

  // Projects at this company
  projects ExperienceProject[]

  order   Int     @default(0)
  visible Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([resumeId, order])
  @@map("experiences")
}

// Projects within a company experience
model ExperienceProject {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  experienceId String     @map("experience_id") @db.Uuid
  experience   Experience @relation(fields: [experienceId], references: [id], onDelete: Cascade)

  name        String       // Project name
  startDate   String       @map("start_date") // "2023-01" format
  endDate     String?      @map("end_date")   // null = ongoing
  description String       @db.Text           // Project description
  role        String?      // Role in this project (e.g., "Lead Developer")

  // Hierarchical achievements (4 depth levels)
  achievements ProjectAchievement[]

  techStack  String[] @map("tech_stack") // Technologies used
  url        String?                     // Project URL
  githubUrl  String?  @map("github_url") // GitHub repository URL

  order Int @default(0)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([experienceId, order])
  @@map("experience_projects")
}

// Hierarchical achievements structure (supports up to 4 levels of depth)
model ProjectAchievement {
  id        String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId String            @map("project_id") @db.Uuid
  project   ExperienceProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  content String // Achievement content
  depth   Int    // Indentation level (1-4)
  order   Int    @default(0)

  // Self-referencing relation for parent-child hierarchy
  parentId String?              @map("parent_id") @db.Uuid
  parent   ProjectAchievement?  @relation("AchievementHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children ProjectAchievement[] @relation("AchievementHierarchy")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([projectId, order])
  @@index([parentId])
  @@map("project_achievements")
}

// NOTE: Independent Project model removed - projects are now only handled as ExperienceProject within experiences

// Education
model Education {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId String @map("resume_id") @db.Uuid
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  school    String
  major     String
  degree    DegreeType?  // Enum: HIGH_SCHOOL, ASSOCIATE_2, ASSOCIATE_3, BACHELOR, MASTER, DOCTORATE (nullable for backward compatibility)
  startDate String  @map("start_date") // "2015-03" format
  endDate   String? @map("end_date") // null = ongoing
  gpa       String?
  gpaFormat GpaFormat? @default(SCALE_4_0) @map("gpa_format") // GPA scale format

  order   Int     @default(0)
  visible Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([resumeId, order])
  @@map("educations")
}

// Certificates and Awards
model Certificate {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resumeId String @map("resume_id") @db.Uuid
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  name          String
  issuer        String  // Issuing organization
  issueDate     String  @map("issue_date") // "2023-01" format
  expiryDate    String? @map("expiry_date") // null = no expiry
  credentialId  String? @map("credential_id")
  credentialUrl String? @map("credential_url")

  order   Int     @default(0)
  visible Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([resumeId, order])
  @@map("certificates")
}

// ========== Share Link Models ==========

model ShareLink {
  id    String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token String @unique // Generated by application using UUIDv7

  // Resource
  resourceType ResourceType @map("resource_type")
  resourceId   String       @map("resource_id") @db.Uuid
  userId       String       @map("user_id") @db.Uuid

  // Share settings
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)
  isActive  Boolean   @default(true) @map("is_active")

  // Analytics
  viewCount    Int       @default(0) @map("view_count")
  lastViewedAt DateTime? @map("last_viewed_at") @db.Timestamptz(6)

  // Relations
  resume Resume? @relation("ResumeShares", fields: [resourceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([token])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([expiresAt])
  @@map("share_links")
}

enum ResourceType {
  RESUME
  BUDGET_SUMMARY
}

// ========== Budget Models (Future) ==========

model Transaction {
  id     String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String          @map("user_id") @db.Uuid
  type   TransactionType

  amount      Decimal  @db.Decimal(12, 2)
  category    String
  description String?
  date        DateTime @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([userId, date(sort: Desc)])
  @@index([userId, category])
  @@map("transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Budget {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String  @map("user_id") @db.Uuid
  category String
  amount   Decimal @db.Decimal(12, 2)
  period   Period  @default(MONTHLY)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([userId, category, period])
  @@index([userId])
  @@map("budgets")
}

enum Period {
  MONTHLY
  YEARLY
}

// ========== User Preferences Models ==========

model UserPreferences {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Theme settings
  theme Theme @default(LIGHT)

  // Home section settings (JSON)
  // Structure: [{ type: "SKILLS", order: 0, visible: true }, ...]
  sectionOrder Json? @map("section_order")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([userId])
  @@map("user_preferences")
}

enum Theme {
  LIGHT
  DARK
}

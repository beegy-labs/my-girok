// Personal Service Database Schema
// Korean Developer Resume + Budget + Share

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== Resume Models ==========

model Resume {
  id          String  @id @default(uuid())
  userId      String  @map("user_id") // Multiple resumes per user

  // Resume Metadata
  title       String // "회사용", "프리랜서용", "스타트업용", etc.
  description String? // Brief description of resume purpose
  isDefault   Boolean @default(false) @map("is_default") // Default resume to show
  paperSize   PaperSize @default(A4) @map("paper_size") // Preferred paper size for PDF export

  // Basic Info
  name      String
  email     String
  phone     String?
  github    String?
  blog      String?
  linkedin  String?
  portfolio String?

  // Summary
  summary String?

  // Profile Image (URL to MinIO)
  profileImage String? @map("profile_image")

  // Attachments
  attachments ResumeAttachment[]

  // Sections (ordered and toggleable)
  sections ResumeSection[]

  // Skills
  skills Skill[]

  // Experiences
  experiences Experience[]

  // Projects
  projects Project[]

  // Education
  educations Education[]

  // Certificates
  certificates Certificate[]

  // Share Links
  shares ShareLink[] @relation("ResumeShares")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, isDefault])
  @@map("resumes")
}

// Section visibility and ordering
model ResumeSection {
  id       String  @id @default(uuid())
  resumeId String  @map("resume_id")
  resume   Resume  @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  type    SectionType // SKILLS, EXPERIENCE, PROJECT, EDUCATION, CERTIFICATE
  order   Int         @default(0) // Display order
  visible Boolean     @default(true) // Show/hide toggle

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([resumeId, type])
  @@index([resumeId, order])
  @@map("resume_sections")
}

enum SectionType {
  SKILLS
  EXPERIENCE
  PROJECT
  EDUCATION
  CERTIFICATE
}

enum PaperSize {
  A4
  LETTER
}

// Resume File Attachments (profile photos, portfolios, certificates)
model ResumeAttachment {
  id       String @id @default(uuid())
  resumeId String @map("resume_id")
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  // File metadata
  type         AttachmentType // PROFILE_PHOTO, PORTFOLIO, CERTIFICATE, OTHER
  fileName     String         @map("file_name") // Original filename
  fileKey      String         @map("file_key") // MinIO object key (UUID-based)
  fileUrl      String         @map("file_url") // Full MinIO URL
  fileSize     Int            @map("file_size") // Size in bytes
  mimeType     String         @map("mime_type") // image/jpeg, application/pdf, etc.

  // Processing metadata
  isProcessed  Boolean        @default(false) @map("is_processed") // Grayscale conversion done
  originalUrl  String?        @map("original_url") // Original color image URL (before grayscale)

  // Display metadata
  title        String? // User-defined title (e.g., "Portfolio 2024")
  description  String? // Description
  order        Int     @default(0) // Display order
  visible      Boolean @default(true) // Show/hide toggle

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([resumeId, type])
  @@index([resumeId, order])
  @@index([fileKey])
  @@map("resume_attachments")
}

enum AttachmentType {
  PROFILE_PHOTO  // Interview photo (will be converted to grayscale)
  PORTFOLIO      // Portfolio documents (PDF, images)
  CERTIFICATE    // Certificate images
  OTHER          // Other attachments
}

// Skills (Frontend, Backend, DevOps, etc.)
model Skill {
  id       String @id @default(uuid())
  resumeId String @map("resume_id")
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  category String   // Frontend, Backend, DevOps, Database, Tools, etc.
  items    String[] // ["React", "TypeScript", "Next.js"]
  order    Int      @default(0)
  visible  Boolean  @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([resumeId, order])
  @@map("skills")
}

// Work Experience
model Experience {
  id       String @id @default(uuid())
  resumeId String @map("resume_id")
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  company     String
  position    String
  startDate   String   @map("start_date") // "2023-01" format
  endDate     String?  @map("end_date") // null = current
  description String   // Job description

  achievements String[] // Key achievements
  techStack    String[] @map("tech_stack") // Technologies used

  order   Int     @default(0)
  visible Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([resumeId, order])
  @@map("experiences")
}

// Projects
model Project {
  id       String @id @default(uuid())
  resumeId String @map("resume_id")
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  name        String
  startDate   String   @map("start_date") // "2023-01" format
  endDate     String?  @map("end_date") // null = ongoing
  description String

  role         String?  // Your role in project
  achievements String[] // Key achievements
  techStack    String[] @map("tech_stack") // Technologies used

  url       String? // Project URL
  githubUrl String? @map("github_url") // GitHub repository

  order   Int     @default(0)
  visible Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([resumeId, order])
  @@map("projects")
}

// Education
model Education {
  id       String @id @default(uuid())
  resumeId String @map("resume_id")
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  school    String
  major     String
  degree    String  // Bachelor, Master, PhD
  startDate String  @map("start_date") // "2015-03" format
  endDate   String? @map("end_date") // null = ongoing
  gpa       String?

  order   Int     @default(0)
  visible Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([resumeId, order])
  @@map("educations")
}

// Certificates and Awards
model Certificate {
  id       String @id @default(uuid())
  resumeId String @map("resume_id")
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  name          String
  issuer        String  // Issuing organization
  issueDate     String  @map("issue_date") // "2023-01" format
  expiryDate    String? @map("expiry_date") // null = no expiry
  credentialId  String? @map("credential_id")
  credentialUrl String? @map("credential_url")

  order   Int     @default(0)
  visible Boolean @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([resumeId, order])
  @@map("certificates")
}

// ========== Share Link Models ==========

model ShareLink {
  id    String @id @default(uuid())
  token String @unique @default(cuid())

  // Resource
  resourceType ResourceType @map("resource_type")
  resourceId   String       @map("resource_id")
  userId       String       @map("user_id")

  // Share settings
  expiresAt DateTime? @map("expires_at")
  isActive  Boolean   @default(true) @map("is_active")

  // Analytics
  viewCount    Int       @default(0) @map("view_count")
  lastViewedAt DateTime? @map("last_viewed_at")

  // Relations
  resume Resume? @relation("ResumeShares", fields: [resourceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([token])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([expiresAt])
  @@map("share_links")
}

enum ResourceType {
  RESUME
  BUDGET_SUMMARY
}

// ========== Budget Models (Future) ==========

model Transaction {
  id     String          @id @default(uuid())
  userId String          @map("user_id")
  type   TransactionType

  amount      Decimal  @db.Decimal(12, 2)
  category    String
  description String?
  date        DateTime

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId, date(sort: Desc)])
  @@index([userId, category])
  @@map("transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Budget {
  id       String  @id @default(uuid())
  userId   String  @map("user_id")
  category String
  amount   Decimal @db.Decimal(12, 2)
  period   Period  @default(MONTHLY)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, category, period])
  @@index([userId])
  @@map("budgets")
}

enum Period {
  MONTHLY
  YEARLY
}

// Personal Service Database Schema
// Korean Developer Resume + Budget + Share

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== Resume Models ==========

model Resume {
  id      String @id @default(uuid())
  user_id String @map("user_id") // Multiple resumes per user

  // Resume Metadata
  title       String // "회사용", "프리랜서용", "스타트업용", etc.
  description String? // Brief description of resume purpose
  is_default  Boolean @default(false) @map("is_default") // Default resume to show

  // Basic Info
  name      String
  email     String
  phone     String?
  github    String?
  blog      String?
  linkedin  String?
  portfolio String?

  // Summary
  summary String?

  // Profile Image
  profile_image String? @map("profile_image")

  // Sections (ordered and toggleable)
  sections ResumeSection[]

  // Skills
  skills Skill[]

  // Experiences
  experiences Experience[]

  // Projects
  projects Project[]

  // Education
  educations Education[]

  // Certificates
  certificates Certificate[]

  // Share Links
  shares ShareLink[] @relation("ResumeShares")

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@index([user_id])
  @@index([user_id, is_default])
  @@map("resumes")
}

// Section visibility and ordering
model ResumeSection {
  id        String  @id @default(uuid())
  resume_id String  @map("resume_id")
  resume    Resume  @relation(fields: [resume_id], references: [id], onDelete: Cascade)

  type    SectionType // SKILLS, EXPERIENCE, PROJECT, EDUCATION, CERTIFICATE
  order   Int         @default(0) // Display order
  visible Boolean     @default(true) // Show/hide toggle

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@unique([resume_id, type])
  @@index([resume_id, order])
  @@map("resume_sections")
}

enum SectionType {
  SKILLS
  EXPERIENCE
  PROJECT
  EDUCATION
  CERTIFICATE
}

// Skills (Frontend, Backend, DevOps, etc.)
model Skill {
  id        String @id @default(uuid())
  resume_id String @map("resume_id")
  resume    Resume @relation(fields: [resume_id], references: [id], onDelete: Cascade)

  category String   // Frontend, Backend, DevOps, Database, Tools, etc.
  items    String[] // ["React", "TypeScript", "Next.js"]
  order    Int      @default(0)
  visible  Boolean  @default(true)

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@index([resume_id, order])
  @@map("skills")
}

// Work Experience
model Experience {
  id        String @id @default(uuid())
  resume_id String @map("resume_id")
  resume    Resume @relation(fields: [resume_id], references: [id], onDelete: Cascade)

  company     String
  position    String
  start_date  String   @map("start_date") // "2023-01" format
  end_date    String?  @map("end_date") // null = current
  description String   // Job description

  achievements String[] // Key achievements
  tech_stack   String[] @map("tech_stack") // Technologies used

  order   Int     @default(0)
  visible Boolean @default(true)

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@index([resume_id, order])
  @@map("experiences")
}

// Projects
model Project {
  id        String @id @default(uuid())
  resume_id String @map("resume_id")
  resume    Resume @relation(fields: [resume_id], references: [id], onDelete: Cascade)

  name        String
  start_date  String   @map("start_date") // "2023-01" format
  end_date    String?  @map("end_date") // null = ongoing
  description String

  role         String?  // Your role in project
  achievements String[] // Key achievements
  tech_stack   String[] @map("tech_stack") // Technologies used

  url        String? // Project URL
  github_url String? @map("github_url") // GitHub repository

  order   Int     @default(0)
  visible Boolean @default(true)

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@index([resume_id, order])
  @@map("projects")
}

// Education
model Education {
  id        String @id @default(uuid())
  resume_id String @map("resume_id")
  resume    Resume @relation(fields: [resume_id], references: [id], onDelete: Cascade)

  school     String
  major      String
  degree     String  // Bachelor, Master, PhD
  start_date String  @map("start_date") // "2015-03" format
  end_date   String? @map("end_date") // null = ongoing
  gpa        String?

  order   Int     @default(0)
  visible Boolean @default(true)

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@index([resume_id, order])
  @@map("educations")
}

// Certificates and Awards
model Certificate {
  id        String @id @default(uuid())
  resume_id String @map("resume_id")
  resume    Resume @relation(fields: [resume_id], references: [id], onDelete: Cascade)

  name           String
  issuer         String  // Issuing organization
  issue_date     String  @map("issue_date") // "2023-01" format
  expiry_date    String? @map("expiry_date") // null = no expiry
  credential_id  String? @map("credential_id")
  credential_url String? @map("credential_url")

  order   Int     @default(0)
  visible Boolean @default(true)

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@index([resume_id, order])
  @@map("certificates")
}

// ========== Share Link Models ==========

model ShareLink {
  id    String @id @default(uuid())
  token String @unique @default(cuid())

  // Resource
  resource_type ResourceType @map("resource_type")
  resource_id   String       @map("resource_id")
  user_id       String       @map("user_id")

  // Share settings
  expires_at DateTime? @map("expires_at")
  is_active  Boolean   @default(true) @map("is_active")

  // Analytics
  view_count     Int       @default(0) @map("view_count")
  last_viewed_at DateTime? @map("last_viewed_at")

  // Relations
  resume Resume? @relation("ResumeShares", fields: [resource_id], references: [id], onDelete: Cascade)

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@index([token])
  @@index([user_id])
  @@index([resource_type, resource_id])
  @@index([expires_at])
  @@map("share_links")
}

enum ResourceType {
  RESUME
  BUDGET_SUMMARY
}

// ========== Budget Models (Future) ==========

model Transaction {
  id      String          @id @default(uuid())
  user_id String          @map("user_id")
  type    TransactionType

  amount      Decimal  @db.Decimal(12, 2)
  category    String
  description String?
  date        DateTime

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@index([user_id, date(sort: Desc)])
  @@index([user_id, category])
  @@map("transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

model Budget {
  id       String  @id @default(uuid())
  user_id  String  @map("user_id")
  category String
  amount   Decimal @db.Decimal(12, 2)
  period   Period  @default(MONTHLY)

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  @@unique([user_id, category, period])
  @@index([user_id])
  @@map("budgets")
}

enum Period {
  MONTHLY
  YEARLY
}

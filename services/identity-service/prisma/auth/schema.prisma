// Auth Database Schema
// Contains: roles, permissions, operators, sanctions

generator client {
  provider      = "prisma-client-js"
  output        = "../../node_modules/.prisma/identity-auth-client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("AUTH_DATABASE_URL")
}

// ============================================================================
// Role-Based Access Control
// ============================================================================

model Role {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique @db.VarChar(100)
  displayName String   @map("display_name") @db.VarChar(255)
  description String?  @db.Text
  scope       String   @default("SERVICE") @db.VarChar(50) // PLATFORM, SERVICE, OPERATOR
  level       Int      @default(0)
  serviceId   String?  @map("service_id") @db.Uuid
  countryCode String?  @map("country_code") @db.VarChar(2)
  parentId    String?  @map("parent_id") @db.Uuid
  isSystem    Boolean  @default(false) @map("is_system")
  isActive    Boolean  @default(true) @map("is_active")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  parent          Role?            @relation("RoleHierarchy", fields: [parentId], references: [id])
  children        Role[]           @relation("RoleHierarchy")
  rolePermissions RolePermission[]
  operators       Operator[]

  @@index([scope])
  @@index([serviceId])
  @@index([countryCode])
  @@index([level])
  @@index([isActive])
  @@map("roles")
}

model Permission {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resource    String   @db.VarChar(100)
  action      String   @db.VarChar(100)
  displayName String   @map("display_name") @db.VarChar(255)
  description String?  @db.Text
  category    String   @default("GENERAL") @db.VarChar(100)
  scope       String   @default("SERVICE") @db.VarChar(50) // PLATFORM, SERVICE
  serviceId   String?  @map("service_id") @db.Uuid
  conditions  Json     @default("{}")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  rolePermissions     RolePermission[]
  operatorPermissions OperatorPermission[]

  @@unique([resource, action, serviceId])
  @@index([resource])
  @@index([category])
  @@index([scope])
  @@index([serviceId])
  @@index([isActive])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleId       String   @map("role_id") @db.Uuid
  permissionId String   @map("permission_id") @db.Uuid
  grantedAt    DateTime @default(now()) @map("granted_at") @db.Timestamptz(6)
  grantedBy    String?  @map("granted_by") @db.Uuid

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================================================
// Operator Management
// ============================================================================

model Operator {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId    String?   @map("account_id") @db.Uuid
  serviceId    String    @map("service_id") @db.Uuid
  roleId       String    @map("role_id") @db.Uuid
  email        String    @db.VarChar(255)
  name         String?   @db.VarChar(255)
  countryCode  String?   @map("country_code") @db.VarChar(2)
  isActive     Boolean   @default(true) @map("is_active")
  invitationId String?   @map("invitation_id") @db.Uuid
  invitedBy    String?   @map("invited_by") @db.Uuid
  invitedAt    DateTime  @default(now()) @map("invited_at") @db.Timestamptz(6)
  acceptedAt   DateTime? @map("accepted_at") @db.Timestamptz(6)
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  role        Role                 @relation(fields: [roleId], references: [id])
  permissions OperatorPermission[]

  @@unique([serviceId, email])
  @@index([accountId])
  @@index([serviceId])
  @@index([countryCode])
  @@index([isActive])
  @@map("operators")
}

model OperatorInvitation {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email       String    @db.VarChar(255)
  name        String?   @db.VarChar(255)
  serviceId   String    @map("service_id") @db.Uuid
  countryCode String?   @map("country_code") @db.VarChar(2)
  roleId      String    @map("role_id") @db.Uuid
  permissions Json      @default("[]")
  type        String    @default("EMAIL") @db.VarChar(50) // EMAIL, DIRECT
  status      String    @default("PENDING") @db.VarChar(50) // PENDING, ACCEPTED, CANCELLED, EXPIRED
  token       String?   @unique @db.VarChar(255)
  invitedBy   String    @map("invited_by") @db.Uuid
  expiresAt   DateTime  @map("expires_at") @db.Timestamptz(6)
  acceptedAt  DateTime? @map("accepted_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([email])
  @@index([token])
  @@index([serviceId])
  @@index([status])
  @@map("operator_invitations")
}

model OperatorPermission {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  operatorId   String   @map("operator_id") @db.Uuid
  permissionId String   @map("permission_id") @db.Uuid
  grantedAt    DateTime @default(now()) @map("granted_at") @db.Timestamptz(6)
  grantedBy    String?  @map("granted_by") @db.Uuid

  operator   Operator   @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([operatorId, permissionId])
  @@map("operator_permissions")
}

// ============================================================================
// Sanctions
// ============================================================================

model Sanction {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subjectId          String    @map("subject_id") @db.Uuid
  subjectType        String    @map("subject_type") @db.VarChar(50) // ACCOUNT, OPERATOR
  serviceId          String?   @map("service_id") @db.Uuid
  scope              String    @default("SERVICE") @db.VarChar(50) // PLATFORM, SERVICE
  type               String    @db.VarChar(50) // WARNING, TEMPORARY_BAN, PERMANENT_BAN, FEATURE_RESTRICTION
  status             String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, EXPIRED, REVOKED
  severity           String    @default("MEDIUM") @db.VarChar(50) // LOW, MEDIUM, HIGH, CRITICAL
  restrictedFeatures String[]  @map("restricted_features")
  reason             String    @db.Text
  internalNote       String?   @map("internal_note") @db.Text
  evidenceUrls       String[]  @map("evidence_urls")
  relatedSanctionId  String?   @map("related_sanction_id") @db.Uuid
  issuedBy           String    @map("issued_by") @db.Uuid
  issuedByType       String    @default("ADMIN") @map("issued_by_type") @db.VarChar(50)
  startAt            DateTime  @map("start_at") @db.Timestamptz(6)
  endAt              DateTime? @map("end_at") @db.Timestamptz(6)
  revokedAt          DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedBy          String?   @map("revoked_by") @db.Uuid
  revokeReason       String?   @map("revoke_reason") @db.Text
  appealStatus       String?   @map("appeal_status") @db.VarChar(50)
  appealedAt         DateTime? @map("appealed_at") @db.Timestamptz(6)
  appealReason       String?   @map("appeal_reason") @db.Text
  appealReviewedBy   String?   @map("appeal_reviewed_by") @db.Uuid
  appealReviewedAt   DateTime? @map("appeal_reviewed_at") @db.Timestamptz(6)
  appealResponse     String?   @map("appeal_response") @db.Text
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  notifications SanctionNotification[]

  @@index([subjectId])
  @@index([subjectType])
  @@index([serviceId])
  @@index([status])
  @@index([startAt])
  @@index([endAt])
  @@map("sanctions")
}

model SanctionNotification {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sanctionId String    @map("sanction_id") @db.Uuid
  channel    String    @db.VarChar(50) // EMAIL, PUSH, SMS, IN_APP
  status     String    @default("PENDING") @db.VarChar(50)
  sentAt     DateTime? @map("sent_at") @db.Timestamptz(6)
  readAt     DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  sanction Sanction @relation(fields: [sanctionId], references: [id], onDelete: Cascade)

  @@index([sanctionId])
  @@index([status])
  @@map("sanction_notifications")
}

// ============================================================================
// Outbox Pattern
// ============================================================================

model OutboxEvent {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @map("aggregate_type") @db.VarChar(50)
  aggregateId   String    @map("aggregate_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json
  status        String    @default("PENDING") @db.VarChar(50) // PENDING, PROCESSING, COMPLETED, FAILED
  retryCount    Int       @default(0) @map("retry_count")
  lastError     String?   @map("last_error") @db.Text
  processedAt   DateTime? @map("processed_at") @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([status])
  @@index([createdAt])
  @@map("outbox_events")
}

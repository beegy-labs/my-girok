// Identity Service - Auth DB Schema
// Manages: roles, permissions, sanctions, operators

generator client {
  provider        = "prisma-client-js"
  output          = "../../node_modules/.prisma/identity-auth-client"
  previewFeatures = ["relationJoins", "typedSql"]
}

datasource db {
  provider = "postgresql"
  url      = env("IDENTITY_AUTH_DATABASE_URL")
}

// ============================================================
// ROLES
// ============================================================

model Role {
  id          String    @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  name        String    @db.VarChar(100)
  displayName String    @map("display_name") @db.VarChar(100)
  description String?
  scope       RoleScope
  level       Int       @default(0)
  parentId    String?   @map("parent_id") @db.Uuid
  isSystem    Boolean   @default(false) @map("is_system")
  isActive    Boolean   @default(true) @map("is_active")
  metadata    Json      @default("{}") // Role-specific metadata

  // Scope-specific
  serviceId   String? @map("service_id") @db.Uuid
  countryCode String? @map("country_code") @db.VarChar(2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  parent          Role?            @relation("RoleHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children        Role[]           @relation("RoleHierarchy")
  rolePermissions RolePermission[]
  operators       Operator[]

  @@unique([name, scope, serviceId, countryCode])
  @@index([parentId])
  @@index([scope])
  @@index([serviceId])
  @@index([countryCode])
  @@index([isActive])
  @@map("roles")
}

enum RoleScope {
  PLATFORM
  SERVICE
  OPERATOR

  @@map("role_scope")
}

// ============================================================
// PERMISSIONS
// ============================================================

model Permission {
  id          String          @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  resource    String          @db.VarChar(100)
  action      String          @db.VarChar(50)
  displayName String          @map("display_name") @db.VarChar(100)
  description String?
  category    String          @db.VarChar(50)
  scope       PermissionScope
  conditions  Json            @default("{}") // ABAC conditions

  // Scope-specific
  serviceId String? @map("service_id") @db.Uuid

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  rolePermissions     RolePermission[]
  operatorPermissions OperatorPermission[]

  @@unique([resource, action, serviceId])
  @@index([resource])
  @@index([scope, category])
  @@index([serviceId])
  @@map("permissions")
}

enum PermissionScope {
  PLATFORM
  SERVICE

  @@map("permission_scope")
}

// ============================================================
// ROLE PERMISSIONS (Junction Table)
// ============================================================

model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid
  conditions   Json?

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ============================================================
// OPERATORS
// ============================================================

model Operator {
  id          String  @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  accountId   String  @map("account_id") @db.Uuid
  email       String  @db.VarChar(255)
  name        String  @db.VarChar(100)
  serviceId   String  @map("service_id") @db.Uuid
  countryCode String  @map("country_code") @db.VarChar(2)
  roleId      String  @map("role_id") @db.Uuid
  isActive    Boolean @default(true) @map("is_active")

  // Invitation
  invitationId String?   @map("invitation_id") @db.Uuid
  invitedBy    String?   @map("invited_by") @db.Uuid
  invitedAt    DateTime? @map("invited_at") @db.Timestamptz(6)
  acceptedAt   DateTime? @map("accepted_at") @db.Timestamptz(6)

  // Activity
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamptz(6)

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  role        Role                 @relation(fields: [roleId], references: [id])
  permissions OperatorPermission[]
  invitation  OperatorInvitation?  @relation(fields: [invitationId], references: [id])

  @@unique([accountId, serviceId])
  @@unique([email, serviceId])
  @@index([accountId])
  @@index([serviceId])
  @@index([countryCode])
  @@index([roleId])
  @@index([isActive])
  @@map("operators")
}

// ============================================================
// OPERATOR PERMISSIONS (Direct Permission Assignment)
// ============================================================

model OperatorPermission {
  id           String   @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  operatorId   String   @map("operator_id") @db.Uuid
  permissionId String   @map("permission_id") @db.Uuid
  grantedBy    String   @map("granted_by") @db.Uuid
  grantedAt    DateTime @default(now()) @map("granted_at") @db.Timestamptz(6)

  // Relations
  operator   Operator   @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([operatorId, permissionId])
  @@index([operatorId])
  @@index([permissionId])
  @@map("operator_permissions")
}

// ============================================================
// OPERATOR INVITATIONS
// ============================================================

model OperatorInvitation {
  id          String           @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  email       String           @db.VarChar(255)
  name        String           @db.VarChar(100)
  serviceId   String           @map("service_id") @db.Uuid
  countryCode String           @map("country_code") @db.VarChar(2)
  roleId      String           @map("role_id") @db.Uuid
  permissions Json             @default("[]")
  invitedBy   String           @map("invited_by") @db.Uuid
  type        InvitationType
  status      InvitationStatus @default(PENDING)
  token       String?          @unique @db.VarChar(255)
  expiresAt   DateTime         @map("expires_at") @db.Timestamptz(6)
  acceptedAt  DateTime?        @map("accepted_at") @db.Timestamptz(6)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  operators Operator[]

  @@index([email])
  @@index([serviceId])
  @@index([token])
  @@index([status])
  @@map("operator_invitations")
}

enum InvitationType {
  EMAIL
  DIRECT

  @@map("invitation_type")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED

  @@map("invitation_status")
}

// ============================================================
// SANCTIONS
// ============================================================

model Sanction {
  id          String              @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  subjectId   String              @map("subject_id") @db.Uuid
  subjectType SanctionSubjectType @map("subject_type")

  // Scope
  serviceId String?       @map("service_id") @db.Uuid
  scope     SanctionScope @default(SERVICE)

  // Type & Status
  type     SanctionType
  status   SanctionStatus   @default(ACTIVE)
  severity SanctionSeverity @default(MEDIUM)

  // Feature Restrictions
  restrictedFeatures String[] @default([]) @map("restricted_features")

  // Details
  reason            String
  internalNote      String?  @map("internal_note")
  evidenceUrls      String[] @default([]) @map("evidence_urls")
  relatedSanctionId String?  @map("related_sanction_id") @db.Uuid

  // Issuer
  issuedBy     String     @map("issued_by") @db.Uuid
  issuedByType IssuerType @default(ADMIN) @map("issued_by_type")

  // Timing
  startAt DateTime  @map("start_at") @db.Timestamptz(6)
  endAt   DateTime? @map("end_at") @db.Timestamptz(6)

  // Revocation
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedBy    String?   @map("revoked_by") @db.Uuid
  revokeReason String?   @map("revoke_reason")

  // Appeal
  appealStatus     AppealStatus? @map("appeal_status")
  appealedAt       DateTime?     @map("appealed_at") @db.Timestamptz(6)
  appealReason     String?       @map("appeal_reason")
  appealReviewedBy String?       @map("appeal_reviewed_by") @db.Uuid
  appealReviewedAt DateTime?     @map("appeal_reviewed_at") @db.Timestamptz(6)
  appealResponse   String?       @map("appeal_response")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Self-relation for sanction chains
  relatedSanction Sanction?              @relation("SanctionChain", fields: [relatedSanctionId], references: [id])
  followUps       Sanction[]             @relation("SanctionChain")
  notifications   SanctionNotification[]

  @@index([subjectId, subjectType])
  @@index([serviceId])
  @@index([status])
  @@index([type])
  @@index([severity])
  @@index([scope])
  @@index([appealStatus])
  @@index([relatedSanctionId])
  @@map("sanctions")
}

enum SanctionSubjectType {
  ACCOUNT
  OPERATOR

  @@map("sanction_subject_type")
}

enum SanctionScope {
  PLATFORM
  SERVICE

  @@map("sanction_scope")
}

enum SanctionType {
  WARNING
  TEMPORARY_BAN
  PERMANENT_BAN
  FEATURE_RESTRICTION

  @@map("sanction_type")
}

enum SanctionStatus {
  ACTIVE
  EXPIRED
  REVOKED

  @@map("sanction_status")
}

enum SanctionSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("sanction_severity")
}

enum IssuerType {
  ADMIN
  OPERATOR
  SYSTEM

  @@map("issuer_type")
}

enum AppealStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  ESCALATED

  @@map("appeal_status")
}

// ============================================================
// SANCTION NOTIFICATIONS
// ============================================================

model SanctionNotification {
  id         String @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  sanctionId String @map("sanction_id") @db.Uuid

  channel NotificationChannel
  status  NotificationStatus  @default(PENDING)

  sentAt DateTime? @map("sent_at") @db.Timestamptz(6)
  readAt DateTime? @map("read_at") @db.Timestamptz(6)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  sanction Sanction @relation(fields: [sanctionId], references: [id], onDelete: Cascade)

  @@index([sanctionId])
  @@index([status])
  @@map("sanction_notifications")
}

enum NotificationChannel {
  EMAIL
  PUSH
  SMS
  IN_APP

  @@map("notification_channel")
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED

  @@map("notification_status")
}

// ============================================================
// OUTBOX EVENTS (Transactional Outbox Pattern)
// ============================================================

model OutboxEvent {
  id            String @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  aggregateType String @map("aggregate_type") @db.VarChar(100)
  aggregateId   String @map("aggregate_id") @db.Uuid
  eventType     String @map("event_type") @db.VarChar(100)
  payload       Json

  // Processing status
  status      OutboxStatus @default(PENDING)
  retryCount  Int          @default(0) @map("retry_count")
  maxRetries  Int          @default(5) @map("max_retries")
  lastError   String?      @map("last_error")
  processedAt DateTime?    @map("processed_at") @db.Timestamptz(6)
  retryAfter  DateTime?    @map("retry_after") @db.Timestamptz(6)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([status, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("outbox_events")
}

enum OutboxStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@map("outbox_status")
}

// ============================================================
// GOOSE DB VERSION (for migration tracking)
// ============================================================

model goose_db_version {
  id         Int      @id @default(autoincrement())
  version_id BigInt
  is_applied Boolean
  tstamp     DateTime @default(now()) @db.Timestamp(6)
}

// Identity Service - Identity DB Schema
// Manages: accounts, sessions, devices, profiles

generator client {
  provider        = "prisma-client-js"
  output          = "../../node_modules/.prisma/identity-client"
  previewFeatures = ["relationJoins", "typedSql"]
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ACCOUNTS
// ============================================================

model Account {
  id          String        @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  externalId  String        @unique @map("external_id") @db.VarChar(20)
  email       String        @unique
  password    String?
  username    String        @unique
  provider    AuthProvider  @default(LOCAL)
  providerId  String?       @map("provider_id")
  status      AccountStatus @default(ACTIVE)
  mode        AccountMode   @default(SERVICE)

  // Verification
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at") @db.Timestamptz(6)
  phoneVerified   Boolean   @default(false) @map("phone_verified")
  phoneVerifiedAt DateTime? @map("phone_verified_at") @db.Timestamptz(6)

  // Security
  mfaEnabled          Boolean   @default(false) @map("mfa_enabled")
  mfaSecret           String?   @map("mfa_secret")
  mfaBackupCodes      String[]  @default([]) @map("mfa_backup_codes")
  lastPasswordChange  DateTime? @map("last_password_change") @db.Timestamptz(6)
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until") @db.Timestamptz(6)

  // Preferences
  region      String? @db.VarChar(50)
  locale      String? @db.VarChar(10)
  timezone    String? @db.VarChar(50)
  countryCode String? @map("country_code") @db.VarChar(2)

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Audit tracking
  lastFailedLoginAt  DateTime? @map("last_failed_login_at") @db.Timestamptz(6)
  lastSuccessLoginAt DateTime? @map("last_success_login_at") @db.Timestamptz(6)

  // Relations
  profile               Profile?
  sessions              Session[]
  devices               Device[]
  revokedTokens         RevokedToken[]
  mfaBackupCodeRecords  MfaBackupCode[]
  passwordHistory       PasswordHistory[]

  @@index([externalId])
  @@index([email])
  @@index([username])
  @@index([provider, providerId])
  @@index([status])
  @@index([countryCode])
  @@map("accounts")
}

enum AccountStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  DEACTIVATED
  DELETED

  @@map("account_status")
}

enum AccountMode {
  SERVICE
  UNIFIED

  @@map("account_mode")
}

enum AuthProvider {
  LOCAL
  GOOGLE
  KAKAO
  NAVER
  APPLE
  MICROSOFT
  GITHUB

  @@map("auth_provider")
}

// ============================================================
// SESSIONS
// ============================================================

model Session {
  id                       String  @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  accountId                String  @map("account_id") @db.Uuid
  tokenHash                String  @unique @map("token_hash") @db.VarChar(64)
  refreshTokenHash         String? @unique @map("refresh_token_hash") @db.VarChar(128)
  previousRefreshTokenHash String? @map("previous_refresh_token_hash") @db.VarChar(128)

  // Session context (USER or OPERATOR)
  sessionContext         SessionContext @default(USER) @map("session_context")
  serviceId              String?        @map("service_id") @db.Uuid // External ref to auth_db.services
  operatorAssignmentId   String?        @map("operator_assignment_id") @db.Uuid // External ref to auth_db.operator_assignments

  // Session metadata
  deviceId  String? @map("device_id") @db.Uuid
  ipAddress String? @map("ip_address") @db.VarChar(45)
  userAgent String? @map("user_agent")

  // Session state
  isActive      Boolean   @default(true) @map("is_active")
  expiresAt     DateTime  @map("expires_at") @db.Timestamptz(6)
  revokedAt     DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedReason String?   @map("revoked_reason") @db.VarChar(100)

  // Activity tracking
  lastActivityAt DateTime? @map("last_activity_at") @db.Timestamptz(6)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  device  Device? @relation(fields: [deviceId], references: [id], onDelete: SetNull)

  @@index([accountId])
  @@index([tokenHash])
  @@index([refreshTokenHash])
  @@index([previousRefreshTokenHash])
  @@index([deviceId])
  @@index([expiresAt])
  @@index([isActive])
  @@index([accountId, isActive, expiresAt])
  @@index([sessionContext])
  @@index([serviceId])
  @@index([operatorAssignmentId])
  @@index([accountId, sessionContext, serviceId])
  @@map("sessions")
}

enum SessionContext {
  USER
  OPERATOR

  @@map("session_context")
}

// ============================================================
// DEVICES
// ============================================================

model Device {
  id        String @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  accountId String @map("account_id") @db.Uuid

  // Device identification
  fingerprint String     @map("fingerprint") @db.VarChar(64)
  name        String?    @db.VarChar(100)
  deviceType  DeviceType @map("device_type")

  // Device info
  platform       String? @db.VarChar(50)
  osVersion      String? @map("os_version") @db.VarChar(50)
  appVersion     String? @map("app_version") @db.VarChar(20)
  browserName    String? @map("browser_name") @db.VarChar(50)
  browserVersion String? @map("browser_version") @db.VarChar(20)

  // Push notification
  pushToken     String?       @map("push_token")
  pushTokenHash String?       @map("push_token_hash") @db.VarChar(64)
  pushPlatform  PushPlatform? @map("push_platform")

  // Trust level
  isTrusted Boolean   @default(false) @map("is_trusted")
  trustedAt DateTime? @map("trusted_at") @db.Timestamptz(6)

  // Activity
  lastActiveAt  DateTime? @map("last_active_at") @db.Timestamptz(6)
  lastIpAddress String?   @map("last_ip_address") @db.VarChar(45)

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@unique([accountId, fingerprint])
  @@index([accountId])
  @@index([fingerprint])
  @@index([deviceType])
  @@map("devices")
}

enum DeviceType {
  WEB
  IOS
  ANDROID
  DESKTOP
  OTHER

  @@map("device_type")
}

enum PushPlatform {
  FCM
  APNS
  WEB_PUSH

  @@map("push_platform")
}

// ============================================================
// PROFILES
// ============================================================

model Profile {
  id        String @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  accountId String @unique @map("account_id") @db.Uuid

  // Basic info
  displayName String?   @map("display_name") @db.VarChar(100)
  firstName   String?   @map("first_name") @db.VarChar(50)
  lastName    String?   @map("last_name") @db.VarChar(50)
  avatar      String?
  bio         String?   @db.VarChar(500)

  // Personal info
  birthDate DateTime? @map("birth_date") @db.Date
  gender    Gender?

  // Contact
  phoneCountryCode String? @map("phone_country_code") @db.VarChar(5)
  phoneNumber      String? @map("phone_number") @db.VarChar(20)

  // Address
  countryCode String? @map("country_code") @db.VarChar(2)
  region      String? @db.VarChar(100)
  city        String? @db.VarChar(100)
  address     String? @db.VarChar(500)
  postalCode  String? @map("postal_code") @db.VarChar(20)

  // Extensible metadata (JSONB)
  metadata Json? @db.JsonB

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([deletedAt])
  @@map("profiles")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY

  @@map("gender")
}

// ============================================================
// OUTBOX EVENTS (Transactional Outbox Pattern)
// ============================================================

model OutboxEvent {
  id            String @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  aggregateType String @map("aggregate_type") @db.VarChar(100)
  aggregateId   String @map("aggregate_id") @db.Uuid
  eventType     String @map("event_type") @db.VarChar(100)
  payload       Json

  // Processing status
  status         OutboxStatus @default(PENDING)
  retryCount     Int          @default(0) @map("retry_count")
  lastError      String?      @map("last_error")
  processedAt    DateTime?    @map("processed_at") @db.Timestamptz(6)
  nextRetryAt    DateTime?    @map("next_retry_at") @db.Timestamptz(6)
  idempotencyKey String?      @map("idempotency_key") @db.VarChar(255)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([status, createdAt])
  @@index([status, nextRetryAt])
  @@index([aggregateType, aggregateId])
  @@index([idempotencyKey])
  @@map("outbox_events")
}

enum OutboxStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@map("outbox_status")
}

enum DlqStatus {
  PENDING
  RETRIED
  RESOLVED
  IGNORED

  @@map("dlq_status")
}

// ============================================================
// REVOKED TOKENS (JWT Blacklist - RFC 9068)
// ============================================================

model RevokedToken {
  id        String   @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  jti       String   @unique @db.VarChar(64)
  accountId String   @map("account_id") @db.Uuid
  reason    String   @db.VarChar(100)
  revokedAt DateTime @default(now()) @map("revoked_at") @db.Timestamptz(6)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([jti])
  @@index([accountId])
  @@index([expiresAt])
  @@map("revoked_tokens")
}

// ============================================================
// MFA BACKUP CODES (Separate table for security)
// ============================================================

model MfaBackupCode {
  id        String    @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  accountId String    @map("account_id") @db.Uuid
  codeHash  String    @map("code_hash") @db.VarChar(128)
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, codeHash])
  @@index([accountId])
  @@map("mfa_backup_codes")
}

// ============================================================
// PASSWORD HISTORY (Prevent reuse - OWASP 2024)
// ============================================================

model PasswordHistory {
  id           String   @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  accountId    String   @map("account_id") @db.Uuid
  passwordHash String   @map("password_hash") @db.VarChar(255)
  changedAt    DateTime @default(now()) @map("changed_at") @db.Timestamptz(6)

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, passwordHash])
  @@index([accountId])
  @@map("password_history")
}

// ============================================================
// IDEMPOTENCY RECORDS (IETF draft-ietf-httpapi-idempotency-key-header)
// ============================================================

model IdempotencyRecord {
  id                 String   @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  idempotencyKey     String   @map("idempotency_key") @db.VarChar(64)
  requestFingerprint String   @map("request_fingerprint") @db.VarChar(128)
  responseStatus     Int      @map("response_status")
  responseBody       Json     @map("response_body")
  responseHeaders    Json     @map("response_headers")
  expiresAt          DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([idempotencyKey, requestFingerprint])
  @@index([idempotencyKey])
  @@index([expiresAt])
  @@map("idempotency_records")
}

// ============================================================
// SAGA STATE (Distributed transaction orchestration)
// ============================================================

model SagaState {
  id             String     @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  sagaName       String     @map("saga_name") @db.VarChar(100)
  correlationId  String     @unique @map("correlation_id") @db.VarChar(64)
  status         SagaStatus @default(PENDING)
  currentStep    Int        @default(0) @map("current_step")
  totalSteps     Int        @map("total_steps")
  context        Json
  completedSteps String[]   @default([]) @map("completed_steps")
  error          String?
  startedAt      DateTime   @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime?  @map("completed_at") @db.Timestamptz(6)
  timeoutAt      DateTime   @map("timeout_at") @db.Timestamptz(6)
  updatedAt      DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([sagaName])
  @@index([status])
  @@index([correlationId])
  @@index([timeoutAt])
  @@map("saga_states")
}

enum SagaStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  COMPENSATING
  COMPENSATED
  TIMED_OUT

  @@map("saga_status")
}

// ============================================================
// DEAD LETTER EVENTS (Failed event handling)
// ============================================================

model DeadLetterEvent {
  id              String    @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  originalEventId String    @map("original_event_id") @db.Uuid
  aggregateType   String    @map("aggregate_type") @db.VarChar(100)
  aggregateId     String    @map("aggregate_id") @db.Uuid
  eventType       String    @map("event_type") @db.VarChar(100)
  payload         Json
  failureReason   String    @map("failure_reason")
  retryCount      Int       @default(0) @map("retry_count")
  originalTopic   String    @map("original_topic") @db.VarChar(255)
  status          DlqStatus @default(PENDING)
  processedAt     DateTime? @map("processed_at") @db.Timestamptz(6)
  processedBy     String?   @map("processed_by") @db.VarChar(255)
  resolution      String?
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([status])
  @@index([status, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("dead_letter_events")
}

// ============================================================
// GOOSE DB VERSION (for migration tracking)
// ============================================================

model goose_db_version {
  id         Int      @id @default(autoincrement())
  version_id BigInt
  is_applied Boolean
  tstamp     DateTime @default(now()) @db.Timestamp(6)
}

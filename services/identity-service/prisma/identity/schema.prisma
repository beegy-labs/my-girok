// Identity Database Schema
// Contains: accounts, sessions, devices, profiles, app_registry

generator client {
  provider      = "prisma-client-js"
  output        = "../../node_modules/.prisma/identity-client"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("IDENTITY_DATABASE_URL")
}

// ============================================================================
// Account Management
// ============================================================================

model Account {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  externalId          String    @unique @map("external_id") @db.VarChar(50)
  email               String    @unique @db.VarChar(255)
  username            String?   @unique @db.VarChar(100)
  emailVerified       Boolean   @default(false) @map("email_verified")
  emailVerifiedAt     DateTime? @map("email_verified_at") @db.Timestamptz(6)
  phoneNumber         String?   @map("phone_number") @db.VarChar(20)
  phoneVerified       Boolean   @default(false) @map("phone_verified")
  phoneVerifiedAt     DateTime? @map("phone_verified_at") @db.Timestamptz(6)
  status              String    @default("PENDING_VERIFICATION") @db.VarChar(50)
  mode                String    @default("SERVICE") @db.VarChar(50) // SERVICE, OPERATOR, ADMIN
  provider            String    @default("LOCAL") @db.VarChar(50)
  providerId          String?   @map("provider_id") @db.VarChar(255)
  password            String?   @db.VarChar(255)
  mfaEnabled          Boolean   @default(false) @map("mfa_enabled")
  mfaMethod           String?   @map("mfa_method") @db.VarChar(50)
  mfaSecret           String?   @map("mfa_secret") @db.VarChar(255)
  mfaBackupCodes      String[]  @map("mfa_backup_codes")
  region              String?   @db.VarChar(50)
  locale              String?   @db.VarChar(10)
  timezone            String?   @db.VarChar(50)
  countryCode         String?   @map("country_code") @db.VarChar(2)
  lastPasswordChange  DateTime? @map("last_password_change") @db.Timestamptz(6)
  lastLoginAt         DateTime? @map("last_login_at") @db.Timestamptz(6)
  lastLoginIp         String?   @map("last_login_ip") @db.VarChar(45)
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until") @db.Timestamptz(6)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt           DateTime? @map("deleted_at") @db.Timestamptz(6)

  sessions Session[]
  devices  Device[]
  profile  Profile?

  @@index([email])
  @@index([username])
  @@index([externalId])
  @@index([status])
  @@index([provider])
  @@index([createdAt])
  @@map("accounts")
}

model Session {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId       String    @map("account_id") @db.Uuid
  deviceId        String?   @map("device_id") @db.Uuid
  tokenHash       String    @unique @map("token_hash") @db.VarChar(255)
  status          String    @default("ACTIVE") @db.VarChar(50)
  isActive        Boolean   @default(true) @map("is_active")
  refreshToken    String    @unique @map("refresh_token") @db.VarChar(512)
  accessTokenHash String?   @map("access_token_hash") @db.VarChar(255)
  ipAddress       String    @map("ip_address") @db.VarChar(45)
  userAgent       String    @map("user_agent") @db.VarChar(512)
  location        String?   @db.VarChar(255)
  expiresAt       DateTime  @map("expires_at") @db.Timestamptz(6)
  lastActivityAt  DateTime  @default(now()) @map("last_activity_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  revokedAt       DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedReason   String?   @map("revoked_reason") @db.VarChar(255)

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  device  Device? @relation(fields: [deviceId], references: [id])

  @@index([accountId])
  @@index([deviceId])
  @@index([tokenHash])
  @@index([status])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sessions")
}

model Device {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId      String    @map("account_id") @db.Uuid
  fingerprint    String    @db.VarChar(255)
  name           String?   @db.VarChar(255)
  deviceType     String    @map("device_type") @db.VarChar(50)
  platform       String?   @db.VarChar(50)
  osVersion      String?   @map("os_version") @db.VarChar(50)
  appVersion     String?   @map("app_version") @db.VarChar(50)
  browserName    String?   @map("browser_name") @db.VarChar(100)
  browserVersion String?   @map("browser_version") @db.VarChar(50)
  pushToken      String?   @map("push_token") @db.VarChar(512)
  pushPlatform   String?   @map("push_platform") @db.VarChar(50)
  isTrusted      Boolean   @default(false) @map("is_trusted")
  trustedAt      DateTime? @map("trusted_at") @db.Timestamptz(6)
  lastActiveAt   DateTime? @map("last_active_at") @db.Timestamptz(6)
  lastIpAddress  String?   @map("last_ip_address") @db.VarChar(45)
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@unique([accountId, fingerprint], name: "accountId_fingerprint")
  @@index([accountId])
  @@index([fingerprint])
  @@index([deviceType])
  @@index([isTrusted])
  @@map("devices")
}

model Profile {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId   String    @unique @map("account_id") @db.Uuid
  displayName String    @map("display_name") @db.VarChar(100)
  firstName   String?   @map("first_name") @db.VarChar(100)
  lastName    String?   @map("last_name") @db.VarChar(100)
  avatar      String?   @db.VarChar(512)
  bio         String?   @db.Text
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  gender      String?   @db.VarChar(20)
  locale      String    @default("en") @db.VarChar(10)
  timezone    String    @default("UTC") @db.VarChar(50)
  countryCode String?   @map("country_code") @db.VarChar(2)
  visibility  String    @default("PRIVATE") @db.VarChar(50)
  metadata    Json      @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([displayName])
  @@index([visibility])
  @@map("profiles")
}

// ============================================================================
// Outbox Pattern (Event Publishing)
// ============================================================================

model OutboxEvent {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @map("aggregate_type") @db.VarChar(50)
  aggregateId   String    @map("aggregate_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json
  status        String    @default("PENDING") @db.VarChar(50) // PENDING, PROCESSING, COMPLETED, FAILED
  retryCount    Int       @default(0) @map("retry_count")
  lastError     String?   @map("last_error") @db.Text
  processedAt   DateTime? @map("processed_at") @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([status])
  @@index([createdAt])
  @@map("outbox_events")
}

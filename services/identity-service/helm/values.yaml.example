# My-Girok Identity Service Helm Values Example
#
# USAGE:
#   1. Copy this file: cp values.yaml.example values.yaml
#   2. Edit values.yaml with your settings
#   3. Install: helm install my-girok-identity . -f values.yaml
#
# IMPORTANT:
#   - values.yaml is gitignored - never commit your actual configuration
#   - Customize for your environment (development, staging, production)
#   - Use Sealed Secrets for sensitive data in production

# Number of replicas
# Development: 1, Staging: 2, Production: 3+
replicaCount: 2

image:
  repository: your-registry.io/my-girok/identity-service
  pullPolicy: IfNotPresent
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations: {}

podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true
  runAsUser: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true

# ============================================================================
# Service Configuration (HTTP + gRPC)
# ============================================================================

service:
  type: ClusterIP
  # HTTP REST API
  httpPort: 3005
  httpTargetPort: 3005
  # gRPC Server
  grpcPort: 50051
  grpcTargetPort: 50051

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/limit-rps: "100"
  hosts:
    - host: identity-api.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: identity-api-tls
      hosts:
        - identity-api.example.com

# gRPC Ingress (optional - for external gRPC access)
grpcIngress:
  enabled: false
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "GRPC"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: identity-grpc.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: identity-grpc-tls
      hosts:
        - identity-grpc.example.com

# Resource limits
resources:
  limits:
    cpu: 1000m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

# Auto-scaling
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - identity-service
          topologyKey: kubernetes.io/hostname

# ============================================================================
# Database Migration (goose) - 3 Databases
# ============================================================================

migration:
  enabled: true  # Enable ArgoCD PreSync migration hook
  # Order: identity -> auth -> legal (dependency order)

# ============================================================================
# Application Configuration
# ============================================================================

app:
  nodeEnv: production
  httpPort: 3005
  grpcPort: 50051

  # Frontend URL
  frontendUrl: "https://example.com"

  # CORS Origins
  corsOrigins: "https://example.com,https://admin.example.com"

  # ============================================================================
  # CQRS Configuration (Read/Write Separation)
  # ============================================================================
  # Enable CQRS for read replica support
  # When enabled, read operations use read replicas, writes use primary
  cqrs:
    enabled: false
    # Read replica configuration (only used when cqrs.enabled=true)
    readReplica:
      # Connection pool settings for read replicas
      poolSize: 10
      idleTimeout: 30000  # 30 seconds

  # ============================================================================
  # Module Mode Configuration
  # ============================================================================
  # local: In-process module communication (current)
  # remote: gRPC-based service communication (future)
  moduleMode:
    identity: local
    auth: local
    legal: local

  # ============================================================================
  # Outbox Configuration
  # ============================================================================
  outbox:
    # Polling interval for outbox events (when Redpanda is not enabled)
    pollingIntervalMs: 5000
    # Batch size for processing outbox events
    batchSize: 100
    # Max retry count before marking as failed
    maxRetries: 5

  # ============================================================================
  # Redpanda Configuration (Future - Kafka-compatible)
  # ============================================================================
  redpanda:
    enabled: false
    brokers: ""
    # When enabled, Debezium CDC replaces polling

  # ============================================================================
  # JWT Configuration
  # ============================================================================
  jwt:
    accessExpiration: "15m"
    refreshExpiration: "7d"
    # Token rotation grace period (seconds)
    rotationGracePeriod: 60

  # ============================================================================
  # Valkey (Redis-compatible) Configuration
  # ============================================================================
  valkey:
    host: valkey.default.svc.cluster.local
    port: 6379
    db: 0

  # ============================================================================
  # OpenTelemetry Configuration
  # ============================================================================
  otel:
    enabled: true
    endpoint: "http://otel-collector.observability.svc.cluster.local:4318"
    serviceName: "identity-service"

# ============================================================================
# Sealed Secrets Configuration
# ============================================================================
# Use kubeseal to encrypt secrets before committing
#
# Example:
#   kubectl create secret generic my-girok-identity-service-secret \
#     --from-literal=identity-database-url="postgresql://user:pass@host:5432/identity_db" \
#     --from-literal=auth-database-url="postgresql://user:pass@host:5432/auth_db" \
#     --from-literal=legal-database-url="postgresql://user:pass@host:5432/legal_db" \
#     --from-literal=identity-read-database-url="postgresql://user:pass@read-host:5432/identity_db" \
#     --from-literal=auth-read-database-url="postgresql://user:pass@read-host:5432/auth_db" \
#     --from-literal=legal-read-database-url="postgresql://user:pass@read-host:5432/legal_db" \
#     --from-literal=jwt-private-key="..." \
#     --from-literal=jwt-public-key="..." \
#     --from-literal=valkey-password="..." \
#     --dry-run=client -o yaml | \
#   kubeseal --format yaml > sealed-secret.yaml

sealedSecrets:
  enabled: true
  annotations:
    sealedsecrets.bitnami.com/managed: "true"

# Health checks
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# ============================================================================
# ENVIRONMENT-SPECIFIC CONFIGURATIONS
# ============================================================================
#
# DEVELOPMENT:
#   replicaCount: 1
#   image.tag: "dev"
#   autoscaling.enabled: false
#   app.nodeEnv: development
#   app.cqrs.enabled: false
#   ingress.hosts[0].host: identity-api-dev.example.com
#
# STAGING:
#   replicaCount: 2
#   image.tag: "staging"
#   autoscaling.enabled: true
#   app.nodeEnv: staging
#   app.cqrs.enabled: true  # Test CQRS in staging
#   ingress.hosts[0].host: identity-api-staging.example.com
#
# PRODUCTION:
#   replicaCount: 3
#   image.tag: "latest" or "v1.0.0"
#   autoscaling.enabled: true
#   app.nodeEnv: production
#   app.cqrs.enabled: true  # Enable read replicas
#   ingress.hosts[0].host: identity-api.example.com
#
# ============================================================================

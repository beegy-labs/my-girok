generator client {
  provider        = "prisma-client-js"
  output          = "../node_modules/.prisma/auth-client"
  previewFeatures = ["relationJoins", "typedSql"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email               String              @unique
  password            String?
  name                String?
  avatar              String?
  role                Role                @default(USER)
  provider            AuthProvider        @default(LOCAL)
  username            String              @unique
  createdAt           DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  emailVerified       Boolean             @default(false) @map("email_verified")
  providerId          String?             @map("provider_id")
  externalId          String?             @unique @map("external_id") @db.VarChar(10)
  region              String?             @db.VarChar(50)
  locale              String?             @db.VarChar(10)
  timezone            String?             @db.VarChar(50)
  accountMode         AccountMode         @default(SERVICE) @map("account_mode")
  countryCode         String?             @map("country_code") @db.VarChar(2)
  deletedAt           DateTime?           @map("deleted_at") @db.Timestamptz(6)
  domainAccess        DomainAccessToken[]
  consents            Consent[]
  userServices        UserService[]
  personalInfo        PersonalInfo?
  primaryAccountLinks AccountLink[]       @relation("PrimaryUser")
  linkedAccountLinks  AccountLink[]       @relation("LinkedUser")
  operatorUserLinks   OperatorUserLink[]
  testerServices      ServiceTesterUser[]

  @@index([externalId])
  @@index([email])
  @@index([username])
  @@index([provider, providerId])
  @@index([accountMode])
  @@index([countryCode])
  @@map("users")
}

model Session {
  id           String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subjectId    String             @map("subject_id") @db.Uuid
  subjectType  SessionSubjectType @map("subject_type")
  tokenHash    String             @unique @map("token_hash") @db.VarChar(64)
  refreshToken String?            @map("refresh_token") // Deprecated: will be removed in future
  expiresAt    DateTime           @map("expires_at") @db.Timestamptz(6)
  revokedAt    DateTime?          @map("revoked_at") @db.Timestamptz(6)
  ipAddress    String?            @map("ip_address") @db.VarChar(45)
  userAgent    String?            @map("user_agent")
  createdAt    DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([subjectId, subjectType])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

enum SessionSubjectType {
  USER
  ADMIN
  OPERATOR

  @@map("session_subject_type")
}

model DomainAccessToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  domain    String
  token     String   @unique
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  userId    String   @map("user_id") @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([domain])
  @@index([token])
  @@map("domain_access_tokens")
}

model OAuthProviderConfig {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider     AuthProvider @unique
  enabled      Boolean      @default(true)
  description  String?
  callbackUrl  String?      @map("callback_url")
  clientId     String?      @map("client_id")
  clientSecret String?      @map("client_secret")
  displayName  String       @map("display_name")
  updatedAt    DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy    String?      @map("updated_by") @db.Uuid

  @@map("oauth_provider_configs")
}

model LegalDocument {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type          LegalDocumentType
  version       String            @db.VarChar(50)
  locale        String            @default("ko") @db.VarChar(10)
  title         String            @db.VarChar(255)
  content       String
  summary       String?
  effectiveDate DateTime          @map("effective_date") @db.Timestamptz(6)
  isActive      Boolean           @default(true) @map("is_active")
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  created_by    String?           @db.Uuid
  updated_by    String?           @db.Uuid
  serviceId     String?           @map("service_id") @db.Uuid
  countryCode   String?           @map("country_code") @db.VarChar(2)

  admins_legal_documents_created_byToadmins admins?   @relation("legal_documents_created_byToadmins", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  admins_legal_documents_updated_byToadmins admins?   @relation("legal_documents_updated_byToadmins", fields: [updated_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  service                                   Service?  @relation(fields: [serviceId], references: [id])
  consents                                  Consent[]

  @@unique([type, version, locale, serviceId, countryCode])
  @@index([type, locale, isActive], map: "idx_legal_documents_type_locale_active")
  @@index([serviceId])
  @@index([countryCode])
  @@map("legal_documents")
}

model Consent {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String       @map("user_id") @db.Uuid
  consentType     ConsentType  @map("consent_type")
  scope           ConsentScope @default(SERVICE)
  serviceId       String?      @map("service_id") @db.Uuid
  countryCode     String       @map("country_code") @db.VarChar(2)
  documentId      String?      @map("document_id") @db.Uuid
  documentVersion String?      @map("document_version") @db.VarChar(50)
  agreed          Boolean      @default(true)
  agreedAt        DateTime     @map("agreed_at") @db.Timestamptz(6)
  withdrawnAt     DateTime?    @map("withdrawn_at") @db.Timestamptz(6)
  ipAddress       String?      @map("ip_address") @db.VarChar(45)
  userAgent       String?      @map("user_agent")
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  document LegalDocument? @relation(fields: [documentId], references: [id])
  service  Service?       @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([serviceId])
  @@index([countryCode])
  @@index([consentType])
  @@index([scope])
  @@index([agreedAt])
  @@map("consents")
}

enum ConsentScope {
  SERVICE
  PLATFORM

  @@map("consent_scope")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model admins {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String      @unique
  password      String
  name          String
  scope         admin_scope @default(TENANT)
  tenant_id     String?     @db.Uuid
  parent_id     String?     @db.Uuid
  role_id       String      @db.Uuid
  is_active     Boolean     @default(true)
  last_login_at DateTime?   @db.Timestamptz(6)
  created_at    DateTime    @default(now()) @db.Timestamptz(6)
  updated_at    DateTime    @default(now()) @db.Timestamptz(6)
  account_mode  AccountMode @default(SERVICE) @map("account_mode")
  country_code  String?     @map("country_code") @db.VarChar(2)
  deleted_at    DateTime?   @db.Timestamptz(6)

  admins                                             admins?              @relation("adminsToadmins", fields: [parent_id], references: [id], onUpdate: NoAction)
  other_admins                                       admins[]             @relation("adminsToadmins")
  roles                                              roles                @relation(fields: [role_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tenants                                            tenants?             @relation(fields: [tenant_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  legal_documents_legal_documents_created_byToadmins LegalDocument[]      @relation("legal_documents_created_byToadmins")
  legal_documents_legal_documents_updated_byToadmins LegalDocument[]      @relation("legal_documents_updated_byToadmins")
  operators                                          Operator[]
  operatorInvitations                                OperatorInvitation[]
  operatorPermissions                                OperatorPermission[]
  adminServices                                      AdminService[]
  testerServices                                     ServiceTesterAdmin[]

  @@index([email], map: "idx_admins_email")
  @@index([parent_id], map: "idx_admins_parent_id")
  @@index([role_id], map: "idx_admins_role_id")
  @@index([scope, tenant_id], map: "idx_admins_scope_tenant_id")
  @@index([account_mode])
  @@index([country_code])
}

model goose_db_version {
  id         Int      @id @default(autoincrement())
  version_id BigInt
  is_applied Boolean
  tstamp     DateTime @default(now()) @db.Timestamp(6)
}

model permissions {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resource     String
  action       String
  scope        admin_scope?
  display_name String
  description  String?
  category     String
  tenant_type  tenant_type?
  service_id   String?      @map("service_id") @db.Uuid

  role_permissions    role_permissions[]
  operatorPermissions OperatorPermission[]
  service             Service?             @relation(fields: [service_id], references: [id])

  @@unique([resource, action, service_id])
  @@index([resource], map: "idx_permissions_resource")
  @@index([scope, category], map: "idx_permissions_scope_category")
  @@index([service_id])
}

model role_permissions {
  role_id       String      @db.Uuid
  permission_id String      @db.Uuid
  conditions    Json?
  permissions   permissions @relation(fields: [permission_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  roles         roles       @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([role_id, permission_id])
  @@index([permission_id], map: "idx_role_permissions_permission_id")
}

model roles {
  id           String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  display_name String
  description  String?
  scope        admin_scope
  tenant_type  tenant_type?
  level        Int          @default(0)
  parent_id    String?      @db.Uuid
  is_system    Boolean      @default(false)
  created_at   DateTime     @default(now()) @db.Timestamptz(6)
  updated_at   DateTime     @default(now()) @db.Timestamptz(6)
  service_id   String?      @map("service_id") @db.Uuid
  country_code String?      @map("country_code") @db.VarChar(2)

  admins           admins[]
  role_permissions role_permissions[]
  roles            roles?             @relation("rolesToroles", fields: [parent_id], references: [id], onUpdate: NoAction)
  other_roles      roles[]            @relation("rolesToroles")
  service          Service?           @relation(fields: [service_id], references: [id])
  adminServices    AdminService[]

  @@unique([name, scope, service_id, country_code])
  @@index([parent_id], map: "idx_roles_parent_id")
  @@index([scope, tenant_type], map: "idx_roles_scope_tenant_type")
  @@index([service_id])
  @@index([country_code])
}

model tenants {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  type        tenant_type   @default(INTERNAL)
  slug        String        @unique
  status      tenant_status @default(PENDING)
  settings    Json?
  approved_at DateTime?     @db.Timestamptz(6)
  approved_by String?       @db.Uuid
  created_at  DateTime      @default(now()) @db.Timestamptz(6)
  updated_at  DateTime      @default(now()) @db.Timestamptz(6)
  admins      admins[]

  @@index([slug], map: "idx_tenants_slug")
  @@index([type, status], map: "idx_tenants_type_status")
}

model Service {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug             String   @unique @db.VarChar(50)
  name             String   @db.VarChar(100)
  description      String?
  isActive         Boolean  @default(true) @map("is_active")
  settings         Json?
  requiredConsents Json?    @map("required_consents")
  domains          String[] @default([])
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  userServices           UserService[]
  consents               Consent[]
  legalDocuments         LegalDocument[]
  consentRequirements    ServiceConsentRequirement[]
  personalInfoAccessLogs PersonalInfoAccessLog[]
  operators              Operator[]
  operatorInvitations    OperatorInvitation[]
  roles                  roles[]
  permissions            permissions[]
  adminServices          AdminService[]
  accountLinks           AccountLink[]
  tiers                  Tier[]
  sanctions              Sanction[]
  supportedCountries     ServiceSupportedCountry[]
  supportedLocales       ServiceSupportedLocale[]
  config                 ServiceConfig?
  features               ServiceFeature[]
  featurePermissions     ServiceFeaturePermission[]
  testerUsers            ServiceTesterUser[]
  testerAdmins           ServiceTesterAdmin[]

  @@index([slug])
  @@index([isActive])
  @@map("services")
}

// ============================================================
// GLOBAL SETTINGS (SSOT - Master Lists)
// ============================================================

model SupportedCountry {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String   @unique @db.VarChar(2) // ISO 3166-1 alpha-2
  name         String   @db.VarChar(100)
  nativeName   String?  @map("native_name") @db.VarChar(100)
  flagEmoji    String?  @map("flag_emoji") @db.VarChar(10)
  isActive     Boolean  @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive])
  @@index([displayOrder])
  @@map("supported_countries")
}

model SupportedLocale {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String   @unique @db.VarChar(10) // e.g., 'ko', 'en', 'ja', 'ko-KR'
  name         String   @db.VarChar(100) // English name
  nativeName   String?  @map("native_name") @db.VarChar(100) // Native name (한국어, English, etc.)
  flagEmoji    String?  @map("flag_emoji") @db.VarChar(10)
  isActive     Boolean  @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive])
  @@index([displayOrder])
  @@map("supported_locales")
}

// ============================================================
// PER-SERVICE SETTINGS (References Global Master Lists)
// ============================================================

model ServiceSupportedCountry {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  serviceId   String   @map("service_id") @db.Uuid
  countryCode String   @map("country_code") @db.VarChar(2)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, countryCode])
  @@index([serviceId])
  @@index([countryCode])
  @@map("service_supported_countries")
}

model ServiceSupportedLocale {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  serviceId String   @map("service_id") @db.Uuid
  locale    String   @db.VarChar(10) // e.g., 'ko', 'en', 'ja', 'ko-KR'
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, locale])
  @@index([serviceId])
  @@index([locale])
  @@map("service_supported_locales")
}

model ServiceConsentRequirement {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  serviceId      String            @map("service_id") @db.Uuid
  countryCode    String            @map("country_code") @db.VarChar(2)
  consentType    ConsentType       @map("consent_type")
  isRequired     Boolean           @default(false) @map("is_required")
  documentType   LegalDocumentType @map("document_type")
  displayOrder   Int               @default(0) @map("display_order")
  labelKey       String            @map("label_key") @db.VarChar(100)
  descriptionKey String            @map("description_key") @db.VarChar(100)
  createdAt      DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, countryCode, consentType])
  @@index([serviceId, countryCode])
  @@map("service_consent_requirements")
}

model LawRegistry {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String   @unique @db.VarChar(20)
  countryCode  String   @map("country_code") @db.VarChar(2)
  name         String   @db.VarChar(100)
  requirements Json
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([countryCode])
  @@index([code])
  @@map("law_registry")
}

model UserService {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String            @map("user_id") @db.Uuid
  serviceId   String            @map("service_id") @db.Uuid
  status      UserServiceStatus @default(ACTIVE)
  tierId      String?           @map("tier_id") @db.Uuid
  countryCode String            @map("country_code") @db.VarChar(2)
  joinedAt    DateTime          @default(now()) @map("joined_at") @db.Timestamptz(6)
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  tier    Tier?   @relation(fields: [tierId], references: [id], onDelete: SetNull)

  @@unique([userId, serviceId, countryCode])
  @@index([userId])
  @@index([serviceId])
  @@index([status])
  @@index([countryCode])
  @@index([tierId])
  @@map("user_services")
}

model PersonalInfo {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String    @unique @map("user_id") @db.Uuid
  name             String?   @db.VarChar(100)
  birthDate        DateTime? @map("birth_date") @db.Date
  gender           Gender?
  phoneCountryCode String?   @map("phone_country_code") @db.VarChar(5)
  phoneNumber      String?   @map("phone_number") @db.VarChar(20)
  countryCode      String?   @map("country_code") @db.VarChar(2)
  region           String?   @db.VarChar(100)
  city             String?   @db.VarChar(100)
  address          String?   @db.VarChar(500)
  postalCode       String?   @map("postal_code") @db.VarChar(20)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  user       User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessLogs PersonalInfoAccessLog[]

  @@index([userId])
  @@map("personal_info")
}

model PersonalInfoAccessLog {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  personalInfoId String       @map("personal_info_id") @db.Uuid
  serviceId      String?      @map("service_id") @db.Uuid
  accessorType   AccessorType @map("accessor_type")
  accessorId     String       @map("accessor_id") @db.Uuid
  action         AccessAction
  fields         String[]
  ipAddress      String?      @map("ip_address") @db.VarChar(45)
  userAgent      String?      @map("user_agent")
  accessedAt     DateTime     @default(now()) @map("accessed_at") @db.Timestamptz(6)

  personalInfo PersonalInfo @relation(fields: [personalInfoId], references: [id], onDelete: Cascade)
  service      Service?     @relation(fields: [serviceId], references: [id])

  @@index([personalInfoId])
  @@index([serviceId])
  @@index([accessorType, accessorId])
  @@index([accessedAt])
  @@map("personal_info_access_logs")
}

model OperatorInvitation {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminId      String           @map("admin_id") @db.Uuid
  serviceId    String           @map("service_id") @db.Uuid
  countryCode  String           @map("country_code") @db.VarChar(2)
  email        String           @db.VarChar(255)
  name         String           @db.VarChar(100)
  type         InvitationType
  status       InvitationStatus @default(PENDING)
  token        String?          @unique
  tempPassword String?          @map("temp_password")
  permissions  Json
  expiresAt    DateTime         @map("expires_at") @db.Timestamptz(6)
  acceptedAt   DateTime?        @map("accepted_at") @db.Timestamptz(6)
  createdAt    DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)

  admin     admins     @relation(fields: [adminId], references: [id])
  service   Service    @relation(fields: [serviceId], references: [id])
  operators Operator[]

  @@index([adminId])
  @@index([serviceId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("operator_invitations")
}

model Operator {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String    @db.VarChar(255)
  password     String
  name         String    @db.VarChar(100)
  adminId      String    @map("admin_id") @db.Uuid
  serviceId    String    @map("service_id") @db.Uuid
  countryCode  String    @map("country_code") @db.VarChar(2)
  isActive     Boolean   @default(true) @map("is_active")
  invitationId String?   @map("invitation_id") @db.Uuid
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt    DateTime? @map("deleted_at") @db.Timestamptz(6)

  admin       admins               @relation(fields: [adminId], references: [id], onDelete: Cascade)
  service     Service              @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  invitation  OperatorInvitation?  @relation(fields: [invitationId], references: [id])
  permissions OperatorPermission[]
  userLinks   OperatorUserLink[]

  @@unique([email, serviceId])
  @@index([adminId])
  @@index([serviceId])
  @@index([countryCode])
  @@index([isActive])
  @@map("operators")
}

model OperatorPermission {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  operatorId   String   @map("operator_id") @db.Uuid
  permissionId String   @map("permission_id") @db.Uuid
  grantedBy    String   @map("granted_by") @db.Uuid
  grantedAt    DateTime @default(now()) @map("granted_at") @db.Timestamptz(6)

  operator   Operator    @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  permission permissions @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  admin      admins      @relation(fields: [grantedBy], references: [id])

  @@unique([operatorId, permissionId])
  @@index([operatorId])
  @@index([permissionId])
  @@map("operator_permissions")
}

model AdminService {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminId     String   @map("admin_id") @db.Uuid
  serviceId   String   @map("service_id") @db.Uuid
  countryCode String?  @map("country_code") @db.VarChar(2)
  roleId      String   @map("role_id") @db.Uuid
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  admin   admins  @relation(fields: [adminId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  role    roles   @relation(fields: [roleId], references: [id])

  @@unique([adminId, serviceId, countryCode])
  @@index([adminId])
  @@index([serviceId])
  @@index([roleId])
  @@map("admin_services")
}

model AccountLink {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  primaryUserId   String            @map("primary_user_id") @db.Uuid
  linkedUserId    String            @map("linked_user_id") @db.Uuid
  linkedServiceId String            @map("linked_service_id") @db.Uuid
  status          AccountLinkStatus @default(PENDING)
  linkedAt        DateTime?         @map("linked_at") @db.Timestamptz(6)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)

  primaryUser   User    @relation("PrimaryUser", fields: [primaryUserId], references: [id], onDelete: Cascade)
  linkedUser    User    @relation("LinkedUser", fields: [linkedUserId], references: [id], onDelete: Cascade)
  linkedService Service @relation(fields: [linkedServiceId], references: [id], onDelete: Cascade)

  @@unique([primaryUserId, linkedUserId])
  @@index([primaryUserId])
  @@index([linkedUserId])
  @@index([linkedServiceId])
  @@index([status])
  @@map("account_links")
}

// ============================================================
// SERVICE CONFIGURATION & FEATURES (#399, #400)
// ============================================================

model ServiceConfig {
  id        String @id @db.Uuid
  serviceId String @unique @map("service_id") @db.Uuid

  // Validation Settings
  jwtValidation      Boolean  @default(true) @map("jwt_validation")
  domainValidation   Boolean  @default(true) @map("domain_validation")
  ipWhitelistEnabled Boolean  @default(false) @map("ip_whitelist_enabled")
  ipWhitelist        String[] @default([]) @map("ip_whitelist")

  // Rate Limiting
  rateLimitEnabled  Boolean @default(true) @map("rate_limit_enabled")
  rateLimitRequests Int     @default(1000) @map("rate_limit_requests")
  rateLimitWindow   Int     @default(60) @map("rate_limit_window")

  // Feature Flags
  maintenanceMode    Boolean @default(false) @map("maintenance_mode")
  maintenanceMessage String? @map("maintenance_message")

  // Audit Settings
  auditLevel AuditLevel @default(STANDARD) @map("audit_level")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy String?  @map("updated_by") @db.Uuid

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@map("service_configs")
}

model ServiceFeature {
  id          String  @id @db.Uuid
  serviceId   String  @map("service_id") @db.Uuid
  code        String  @db.VarChar(50)
  name        String  @db.VarChar(100)
  description String?
  category    String  @db.VarChar(50)

  // Hierarchy
  parentId String? @map("parent_id") @db.Uuid
  path     String  @db.VarChar(500)
  depth    Int     @default(1)

  // Settings
  displayOrder Int     @default(0) @map("display_order")
  isActive     Boolean @default(true) @map("is_active")
  isDefault    Boolean @default(true) @map("is_default")

  // Metadata
  icon  String? @db.VarChar(50)
  color String? @db.VarChar(20)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  service     Service                    @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  parent      ServiceFeature?            @relation("FeatureHierarchy", fields: [parentId], references: [id])
  children    ServiceFeature[]           @relation("FeatureHierarchy")
  permissions ServiceFeaturePermission[]

  @@unique([serviceId, code])
  @@index([serviceId, category])
  @@index([parentId])
  @@index([path])
  @@index([isActive])
  @@map("service_features")
}

model ServiceFeaturePermission {
  id        String @id @db.Uuid
  featureId String @map("feature_id") @db.Uuid
  serviceId String @map("service_id") @db.Uuid

  // Target
  targetType PermissionTargetType @map("target_type")
  targetId   String?              @map("target_id") @db.Uuid

  // Permission
  action    FeatureAction
  isAllowed Boolean       @default(true) @map("is_allowed")

  // Conditions
  conditions Json?

  // Validity
  validFrom  DateTime? @map("valid_from") @db.Timestamptz(6)
  validUntil DateTime? @map("valid_until") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String   @map("created_by") @db.Uuid

  feature ServiceFeature @relation(fields: [featureId], references: [id], onDelete: Cascade)
  service Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([featureId])
  @@index([serviceId, targetType, targetId])
  @@index([validFrom, validUntil])
  @@map("service_feature_permissions")
}

// ============================================================
// SERVICE TESTERS (#401)
// ============================================================

model ServiceTesterUser {
  id        String @id @db.Uuid
  serviceId String @map("service_id") @db.Uuid
  userId    String @map("user_id") @db.Uuid

  // Bypass Settings
  bypassAll    Boolean @default(false) @map("bypass_all")
  bypassDomain Boolean @default(true) @map("bypass_domain")
  bypassIP     Boolean @default(true) @map("bypass_ip")
  bypassRate   Boolean @default(false) @map("bypass_rate")

  // Metadata
  note      String?
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String   @map("created_by") @db.Uuid
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([serviceId, userId])
  @@index([serviceId])
  @@index([userId])
  @@index([expiresAt])
  @@map("service_tester_users")
}

model ServiceTesterAdmin {
  id        String @id @db.Uuid
  serviceId String @map("service_id") @db.Uuid
  adminId   String @map("admin_id") @db.Uuid

  // Bypass Settings
  bypassAll    Boolean @default(false) @map("bypass_all")
  bypassDomain Boolean @default(true) @map("bypass_domain")

  // Metadata
  note      String?
  expiresAt DateTime? @map("expires_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String   @map("created_by") @db.Uuid

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  admin   admins  @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([serviceId, adminId])
  @@index([serviceId])
  @@index([adminId])
  @@index([expiresAt])
  @@map("service_tester_admins")
}

// ============================================================
// TIERS
// ============================================================

model Tier {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  serviceId    String   @map("service_id") @db.Uuid
  name         String   @db.VarChar(50)
  level        Int      @default(0)
  benefits     Json?
  requirements Json?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  service      Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  userServices UserService[]

  @@unique([serviceId, name])
  @@index([serviceId])
  @@index([level])
  @@map("tiers")
}

model Sanction {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Subject
  subjectId   String              @map("subject_id") @db.Uuid
  subjectType SanctionSubjectType @map("subject_type")

  // Scope (#402)
  serviceId String?       @map("service_id") @db.Uuid
  scope     SanctionScope @default(SERVICE)

  // Type & Status
  type     SanctionType
  status   SanctionStatus   @default(ACTIVE)
  severity SanctionSeverity @default(MEDIUM)

  // Feature Restrictions (#402)
  restrictedFeatures String[] @default([]) @map("restricted_features")

  // Details
  reason            String
  internalNote      String?  @map("internal_note")
  evidenceUrls      String[] @default([]) @map("evidence_urls")
  relatedSanctionId String?  @map("related_sanction_id") @db.Uuid

  // Issuer
  issuedBy     String     @map("issued_by") @db.Uuid
  issuedByType IssuerType @default(ADMIN) @map("issued_by_type")

  // Timing
  startAt DateTime  @map("start_at") @db.Timestamptz(6)
  endAt   DateTime? @map("end_at") @db.Timestamptz(6)

  // Revocation
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedBy    String?   @map("revoked_by") @db.Uuid
  revokeReason String?   @map("revoke_reason")

  // Appeal (#402)
  appealStatus     AppealStatus? @map("appeal_status")
  appealedAt       DateTime?     @map("appealed_at") @db.Timestamptz(6)
  appealReason     String?       @map("appeal_reason")
  appealReviewedBy String?       @map("appeal_reviewed_by") @db.Uuid
  appealReviewedAt DateTime?     @map("appeal_reviewed_at") @db.Timestamptz(6)
  appealResponse   String?       @map("appeal_response")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  service         Service?               @relation(fields: [serviceId], references: [id])
  relatedSanction Sanction?              @relation("SanctionChain", fields: [relatedSanctionId], references: [id])
  followUps       Sanction[]             @relation("SanctionChain")
  notifications   SanctionNotification[]

  @@index([subjectId, subjectType])
  @@index([serviceId])
  @@index([status])
  @@index([type])
  @@index([severity])
  @@index([scope])
  @@index([appealStatus])
  @@index([relatedSanctionId])
  @@map("sanctions")
}

model SanctionNotification {
  id         String @id @db.Uuid
  sanctionId String @map("sanction_id") @db.Uuid

  channel NotificationChannel
  status  NotificationStatus  @default(PENDING)

  sentAt DateTime? @map("sent_at") @db.Timestamptz(6)
  readAt DateTime? @map("read_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  sanction Sanction @relation(fields: [sanctionId], references: [id], onDelete: Cascade)

  @@index([sanctionId])
  @@index([status])
  @@map("sanction_notifications")
}

enum SanctionSubjectType {
  USER
  ADMIN
  OPERATOR

  @@map("sanction_subject_type")
}

model OperatorUserLink {
  id         String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  operatorId String           @map("operator_id") @db.Uuid
  userId     String           @map("user_id") @db.Uuid
  type       OperatorLinkType
  assignedBy String?          @map("assigned_by") @db.Uuid
  note       String?
  isActive   Boolean          @default(true) @map("is_active")
  createdAt  DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  operator Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([operatorId, userId])
  @@index([operatorId])
  @@index([userId])
  @@index([isActive])
  @@map("operator_user_links")
}

enum Role {
  GUEST
  USER
  MANAGER
  MASTER
}

enum AccountMode {
  SERVICE // Per-service independent account (default)
  UNIFIED // Integrated account

  @@map("account_mode")
}

enum UserServiceStatus {
  ACTIVE
  SUSPENDED
  WITHDRAWN

  @@map("user_service_status")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY

  @@map("gender")
}

enum AccessorType {
  USER
  ADMIN
  OPERATOR
  SYSTEM

  @@map("accessor_type")
}

enum AccessAction {
  READ
  UPDATE
  DELETE

  @@map("access_action")
}

enum InvitationType {
  EMAIL
  DIRECT

  @@map("invitation_type")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED

  @@map("invitation_status")
}

enum AccountLinkStatus {
  PENDING
  ACTIVE
  UNLINKED

  @@map("account_link_status")
}

enum SanctionType {
  WARNING
  TEMPORARY_BAN
  PERMANENT_BAN
  FEATURE_RESTRICTION

  @@map("sanction_type")
}

enum SanctionStatus {
  ACTIVE
  EXPIRED
  REVOKED

  @@map("sanction_status")
}

// ============================================================
// NEW ENUMS (#399-#402)
// ============================================================

enum AuditLevel {
  MINIMAL
  STANDARD
  VERBOSE
  DEBUG

  @@map("audit_level")
}

enum PermissionTargetType {
  ALL_USERS
  USER
  TIER
  COUNTRY
  ROLE

  @@map("permission_target_type")
}

enum FeatureAction {
  USE
  CREATE
  READ
  UPDATE
  DELETE
  ADMIN

  @@map("feature_action")
}

enum SanctionScope {
  PLATFORM
  SERVICE

  @@map("sanction_scope")
}

enum SanctionSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("sanction_severity")
}

enum IssuerType {
  ADMIN
  OPERATOR
  SYSTEM

  @@map("issuer_type")
}

enum AppealStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  ESCALATED

  @@map("appeal_status")
}

enum NotificationChannel {
  EMAIL
  PUSH
  SMS
  IN_APP

  @@map("notification_channel")
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED

  @@map("notification_status")
}

enum OperatorLinkType {
  ASSIGNED
  SELF_CLAIMED

  @@map("operator_link_type")
}

enum AuthProvider {
  LOCAL
  GOOGLE
  KAKAO
  NAVER
  APPLE
}

enum admin_scope {
  SYSTEM
  TENANT
}

enum ConsentType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  MARKETING_EMAIL
  MARKETING_PUSH
  MARKETING_PUSH_NIGHT
  MARKETING_SMS
  PERSONALIZED_ADS
  THIRD_PARTY_SHARING
  CROSS_BORDER_TRANSFER
  CROSS_SERVICE_SHARING

  @@map("consent_type")
}

enum LegalDocumentType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  MARKETING_POLICY
  PERSONALIZED_ADS

  @@map("legal_document_type")
}

enum tenant_status {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum tenant_type {
  INTERNAL
}

// ============================================================
// TRANSACTIONAL OUTBOX (#461)
// ============================================================

model OutboxEvent {
  id           String             @id @default(dbgenerated("uuid_generate_v7()")) @db.Uuid
  eventType    String             @map("event_type") @db.VarChar(100)
  aggregateId  String             @map("aggregate_id") @db.Uuid
  payload      Json
  status       OutboxEventStatus  @default(PENDING)
  retryCount   Int                @default(0) @map("retry_count")
  createdAt    DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  publishedAt  DateTime?          @map("published_at") @db.Timestamptz(6)
  errorMessage String?            @map("error_message")

  @@index([status, createdAt])
  @@index([aggregateId])
  @@map("outbox_events")
}

enum OutboxEventStatus {
  PENDING
  PUBLISHED
  FAILED

  @@map("outbox_event_status")
}

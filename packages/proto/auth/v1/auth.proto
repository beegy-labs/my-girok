syntax = "proto3";

package auth.v1;

option go_package = "github.com/beegy-labs/my-girok/gen/auth/v1";

import "google/protobuf/timestamp.proto";
import "common/v1/common.proto";

// AuthService provides authentication, authorization, and sanction operations
service AuthService {
  // Permission operations
  rpc CheckPermission(CheckPermissionRequest) returns (CheckPermissionResponse);
  rpc CheckPermissions(CheckPermissionsRequest) returns (CheckPermissionsResponse);
  rpc GetOperatorPermissions(GetOperatorPermissionsRequest) returns (GetOperatorPermissionsResponse);

  // Role operations
  rpc GetRole(GetRoleRequest) returns (GetRoleResponse);
  rpc GetRolesByOperator(GetRolesByOperatorRequest) returns (GetRolesByOperatorResponse);

  // Operator operations (legacy - use OperatorAssignment for new implementations)
  rpc GetOperator(GetOperatorRequest) returns (GetOperatorResponse);
  rpc ValidateOperator(ValidateOperatorRequest) returns (ValidateOperatorResponse);

  // Sanction operations
  rpc CheckSanction(CheckSanctionRequest) returns (CheckSanctionResponse);
  rpc GetActiveSanctions(GetActiveSanctionsRequest) returns (GetActiveSanctionsResponse);

  // ============================================================
  // Admin Authentication (Enterprise Auth)
  // ============================================================

  // Admin login - Step 1: Validate credentials (MFA challenge returned if enabled)
  rpc AdminLogin(AdminLoginRequest) returns (AdminLoginResponse);

  // Admin login - Step 2: Verify MFA code
  rpc AdminLoginMfa(AdminLoginMfaRequest) returns (AdminLoginMfaResponse);

  // Admin session management
  rpc AdminValidateSession(AdminValidateSessionRequest) returns (AdminValidateSessionResponse);
  rpc AdminRefreshSession(AdminRefreshSessionRequest) returns (AdminRefreshSessionResponse);
  rpc AdminLogout(AdminLogoutRequest) returns (AdminLogoutResponse);
  rpc AdminRevokeAllSessions(AdminRevokeAllSessionsRequest) returns (AdminRevokeAllSessionsResponse);
  rpc AdminGetActiveSessions(AdminGetActiveSessionsRequest) returns (AdminGetActiveSessionsResponse);

  // Admin MFA management
  rpc AdminSetupMfa(AdminSetupMfaRequest) returns (AdminSetupMfaResponse);
  rpc AdminVerifyMfa(AdminVerifyMfaRequest) returns (AdminVerifyMfaResponse);
  rpc AdminDisableMfa(AdminDisableMfaRequest) returns (AdminDisableMfaResponse);
  rpc AdminRegenerateBackupCodes(AdminRegenerateBackupCodesRequest) returns (AdminRegenerateBackupCodesResponse);

  // Admin password management
  rpc AdminChangePassword(AdminChangePasswordRequest) returns (AdminChangePasswordResponse);
  rpc AdminForcePasswordChange(AdminForcePasswordChangeRequest) returns (AdminForcePasswordChangeResponse);

  // ============================================================
  // Operator Assignment (User-based operators)
  // ============================================================

  // Assign operator role to a user account
  rpc AssignOperator(AssignOperatorRequest) returns (AssignOperatorResponse);

  // Revoke operator assignment
  rpc RevokeOperatorAssignment(RevokeOperatorAssignmentRequest) returns (RevokeOperatorAssignmentResponse);

  // Get operator assignment for a user
  rpc GetOperatorAssignment(GetOperatorAssignmentRequest) returns (GetOperatorAssignmentResponse);

  // Get all operator assignments for a service
  rpc GetServiceOperatorAssignments(GetServiceOperatorAssignmentsRequest) returns (GetServiceOperatorAssignmentsResponse);

  // Update operator assignment permissions
  rpc UpdateOperatorAssignmentPermissions(UpdateOperatorAssignmentPermissionsRequest) returns (UpdateOperatorAssignmentPermissionsResponse);

  // Get operator assignment permissions
  rpc GetOperatorAssignmentPermissions(GetOperatorAssignmentPermissionsRequest) returns (GetOperatorAssignmentPermissionsResponse);
}

// Permission represents a single permission
message Permission {
  string id = 1;
  string resource = 2;
  string action = 3;
  string category = 4;
  string description = 5;
  bool is_system = 6;
}

// Role represents a role with permissions
message Role {
  string id = 1;
  string name = 2;
  string description = 3;
  int32 level = 4;
  RoleScope scope = 5;
  repeated Permission permissions = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
}

// RoleScope defines where the role applies
enum RoleScope {
  ROLE_SCOPE_UNSPECIFIED = 0;
  ROLE_SCOPE_GLOBAL = 1;
  ROLE_SCOPE_SERVICE = 2;
  ROLE_SCOPE_TENANT = 3;
}

// Operator represents an admin/operator user
message Operator {
  string id = 1;
  string account_id = 2;
  string email = 3;
  string display_name = 4;
  OperatorStatus status = 5;
  string role_id = 6;
  Role role = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
  google.protobuf.Timestamp last_login_at = 10;
}

// OperatorStatus represents the current state of an operator
enum OperatorStatus {
  OPERATOR_STATUS_UNSPECIFIED = 0;
  OPERATOR_STATUS_PENDING = 1;
  OPERATOR_STATUS_ACTIVE = 2;
  OPERATOR_STATUS_SUSPENDED = 3;
  OPERATOR_STATUS_REVOKED = 4;
}

// Sanction represents a restriction on an account
message Sanction {
  string id = 1;
  string subject_id = 2;
  SubjectType subject_type = 3;
  SanctionType type = 4;
  SanctionSeverity severity = 5;
  string reason = 6;
  string evidence = 7;
  string issued_by = 8;
  google.protobuf.Timestamp issued_at = 9;
  google.protobuf.Timestamp expires_at = 10;
  SanctionStatus status = 11;
}

// SubjectType identifies what kind of entity is sanctioned
enum SubjectType {
  SUBJECT_TYPE_UNSPECIFIED = 0;
  SUBJECT_TYPE_USER = 1;
  SUBJECT_TYPE_OPERATOR = 2;
  SUBJECT_TYPE_SERVICE = 3;
}

// SanctionType categorizes the sanction
enum SanctionType {
  SANCTION_TYPE_UNSPECIFIED = 0;
  SANCTION_TYPE_WARNING = 1;
  SANCTION_TYPE_MUTE = 2;
  SANCTION_TYPE_TEMPORARY_BAN = 3;
  SANCTION_TYPE_PERMANENT_BAN = 4;
  SANCTION_TYPE_FEATURE_RESTRICTION = 5;
}

// SanctionSeverity indicates the severity level
enum SanctionSeverity {
  SANCTION_SEVERITY_UNSPECIFIED = 0;
  SANCTION_SEVERITY_LOW = 1;
  SANCTION_SEVERITY_MEDIUM = 2;
  SANCTION_SEVERITY_HIGH = 3;
  SANCTION_SEVERITY_CRITICAL = 4;
}

// SanctionStatus represents the current state of a sanction
enum SanctionStatus {
  SANCTION_STATUS_UNSPECIFIED = 0;
  SANCTION_STATUS_ACTIVE = 1;
  SANCTION_STATUS_EXPIRED = 2;
  SANCTION_STATUS_REVOKED = 3;
  SANCTION_STATUS_APPEALED = 4;
}

// === Request/Response Messages ===

// CheckPermission
message CheckPermissionRequest {
  string operator_id = 1;
  string resource = 2;
  string action = 3;
  map<string, string> context = 4;
}

message CheckPermissionResponse {
  bool allowed = 1;
  string reason = 2;
  repeated string matched_permissions = 3;
}

// CheckPermissions (batch)
message CheckPermissionsRequest {
  string operator_id = 1;
  repeated PermissionCheck checks = 2;
}

message PermissionCheck {
  string resource = 1;
  string action = 2;
}

message CheckPermissionsResponse {
  bool all_allowed = 1;
  repeated PermissionCheckResult results = 2;
}

message PermissionCheckResult {
  string resource = 1;
  string action = 2;
  bool allowed = 3;
  string reason = 4;
}

// GetOperatorPermissions
message GetOperatorPermissionsRequest {
  string operator_id = 1;
  bool include_role_permissions = 2;
}

message GetOperatorPermissionsResponse {
  repeated Permission permissions = 1;
  repeated Permission direct_permissions = 2;
  repeated Permission role_permissions = 3;
}

// GetRole
message GetRoleRequest {
  string id = 1;
}

message GetRoleResponse {
  Role role = 1;
}

// GetRolesByOperator
message GetRolesByOperatorRequest {
  string operator_id = 1;
}

message GetRolesByOperatorResponse {
  repeated Role roles = 1;
}

// GetOperator
message GetOperatorRequest {
  string id = 1;
}

message GetOperatorResponse {
  Operator operator = 1;
}

// ValidateOperator
message ValidateOperatorRequest {
  string id = 1;
}

message ValidateOperatorResponse {
  bool valid = 1;
  OperatorStatus status = 2;
  string message = 3;
}

// CheckSanction
message CheckSanctionRequest {
  string subject_id = 1;
  SubjectType subject_type = 2;
  optional SanctionType sanction_type = 3;
}

message CheckSanctionResponse {
  bool is_sanctioned = 1;
  repeated Sanction active_sanctions = 2;
  SanctionSeverity highest_severity = 3;
}

// GetActiveSanctions
message GetActiveSanctionsRequest {
  string subject_id = 1;
  SubjectType subject_type = 2;
}

message GetActiveSanctionsResponse {
  repeated Sanction sanctions = 1;
  int32 total_count = 2;
}

// ============================================================
// Admin Authentication Messages
// ============================================================
// Enterprise authentication for platform administrators.
// Admins have separate authentication flow with mandatory MFA,
// password rotation policies, and dedicated session management.
// ============================================================

// Admin represents a platform administrator.
// Admins are privileged users with access to administrative functions.
// Unlike regular users, admins require MFA and have stricter security policies.
message Admin {
  // Unique identifier for the admin (UUIDv7)
  string id = 1;
  // Admin email address (used for login)
  string email = 2;
  // Display name
  string name = 3;
  // Authority scope (SYSTEM or TENANT level)
  AdminScope scope = 4;
  // Associated role ID for RBAC
  string role_id = 5;
  // Full role object with permissions
  Role role = 6;
  // Whether the admin account is active
  bool is_active = 7;
  // Whether MFA is required for this admin (always true for production)
  bool mfa_required = 8;
  // Whether MFA has been set up and verified
  bool mfa_enabled = 9;
  // Whether a password change is required on next login
  bool force_password_change = 10;
  // Last successful login timestamp
  google.protobuf.Timestamp last_login_at = 11;
  // Last password change timestamp (for rotation policy)
  google.protobuf.Timestamp password_changed_at = 12;
  // Account creation timestamp
  google.protobuf.Timestamp created_at = 13;
  // Last update timestamp
  google.protobuf.Timestamp updated_at = 14;
}

// AdminScope defines admin authority level
enum AdminScope {
  ADMIN_SCOPE_UNSPECIFIED = 0;
  ADMIN_SCOPE_SYSTEM = 1;   // Full platform access
  ADMIN_SCOPE_TENANT = 2;   // Tenant-level access
}

// AdminSession represents an active admin session.
// Admin sessions are separate from user sessions for enhanced security.
// Each session tracks MFA verification status and device information.
message AdminSession {
  // Unique session identifier (UUIDv7)
  string id = 1;
  // Admin ID who owns this session
  string admin_id = 2;
  // Whether MFA has been verified for this session
  bool mfa_verified = 3;
  // MFA method used for verification (TOTP or BACKUP_CODE)
  string mfa_method = 4;
  // Client IP address at session creation
  string ip_address = 5;
  // Client user agent string
  string user_agent = 6;
  // Device fingerprint for fraud detection
  string device_fingerprint = 7;
  // Whether the session is currently active
  bool is_active = 8;
  // When MFA was verified for this session
  google.protobuf.Timestamp mfa_verified_at = 9;
  // Last activity timestamp (updated on each request)
  google.protobuf.Timestamp last_activity_at = 10;
  // Session expiration timestamp
  google.protobuf.Timestamp expires_at = 11;
  // Session creation timestamp
  google.protobuf.Timestamp created_at = 12;
}

// AdminLogin - Step 1: Credentials validation
message AdminLoginRequest {
  string email = 1;
  string password = 2;
  string ip_address = 3;
  string user_agent = 4;
  string device_fingerprint = 5;
}

message AdminLoginResponse {
  bool success = 1;
  bool mfa_required = 2;
  string challenge_id = 3;  // For MFA step
  repeated common.v1.MfaMethod available_methods = 4;
  string message = 5;
  Admin admin = 6;  // Only populated if MFA not required
  AdminSession session = 7;  // Only populated if MFA not required
  string access_token = 8;
  string refresh_token = 9;
}

// AdminLoginMfa - Step 2: MFA verification
message AdminLoginMfaRequest {
  string challenge_id = 1;
  string code = 2;
  common.v1.MfaMethod method = 3;
  string ip_address = 4;
  string user_agent = 5;
  string device_fingerprint = 6;
}

message AdminLoginMfaResponse {
  bool success = 1;
  string message = 2;
  Admin admin = 3;
  AdminSession session = 4;
  string access_token = 5;
  string refresh_token = 6;
}

// AdminValidateSession
message AdminValidateSessionRequest {
  string token_hash = 1;
}

message AdminValidateSessionResponse {
  bool valid = 1;
  string admin_id = 2;
  string session_id = 3;
  bool mfa_verified = 4;
  google.protobuf.Timestamp expires_at = 5;
  string message = 6;
}

// AdminRefreshSession
message AdminRefreshSessionRequest {
  string refresh_token_hash = 1;
}

message AdminRefreshSessionResponse {
  bool success = 1;
  string access_token = 2;
  string refresh_token = 3;
  google.protobuf.Timestamp expires_at = 4;
  string message = 5;
}

// AdminLogout
message AdminLogoutRequest {
  string session_id = 1;
}

message AdminLogoutResponse {
  bool success = 1;
  string message = 2;
}

// AdminRevokeAllSessions
message AdminRevokeAllSessionsRequest {
  string admin_id = 1;
  optional string exclude_session_id = 2;
  string reason = 3;
}

message AdminRevokeAllSessionsResponse {
  bool success = 1;
  int32 revoked_count = 2;
  string message = 3;
}

// AdminGetActiveSessions
message AdminGetActiveSessionsRequest {
  string admin_id = 1;
}

message AdminGetActiveSessionsResponse {
  repeated AdminSession sessions = 1;
  int32 total_count = 2;
}

// ============================================================
// Admin MFA Management Messages
// ============================================================

// AdminSetupMfa
message AdminSetupMfaRequest {
  string admin_id = 1;
}

message AdminSetupMfaResponse {
  bool success = 1;
  string secret = 2;  // Base32 encoded TOTP secret
  string qr_code_uri = 3;  // otpauth:// URI for QR code
  repeated string backup_codes = 4;  // Plain text backup codes (one-time view)
  string message = 5;
}

// AdminVerifyMfa (initial setup verification)
message AdminVerifyMfaRequest {
  string admin_id = 1;
  string code = 2;
}

message AdminVerifyMfaResponse {
  bool success = 1;
  string message = 2;
}

// AdminDisableMfa
message AdminDisableMfaRequest {
  string admin_id = 1;
  string password = 2;  // Require password for security
}

message AdminDisableMfaResponse {
  bool success = 1;
  string message = 2;
}

// AdminRegenerateBackupCodes
message AdminRegenerateBackupCodesRequest {
  string admin_id = 1;
  string password = 2;  // Require password for security
}

message AdminRegenerateBackupCodesResponse {
  bool success = 1;
  repeated string backup_codes = 2;  // New plain text backup codes
  string message = 3;
}

// ============================================================
// Admin Password Management Messages
// ============================================================

// AdminChangePassword
message AdminChangePasswordRequest {
  string admin_id = 1;
  string current_password = 2;
  string new_password = 3;
}

message AdminChangePasswordResponse {
  bool success = 1;
  string message = 2;
}

// AdminForcePasswordChange (by system admin)
message AdminForcePasswordChangeRequest {
  string admin_id = 1;
  string requester_admin_id = 2;  // Admin requesting the change
}

message AdminForcePasswordChangeResponse {
  bool success = 1;
  string message = 2;
}

// ============================================================
// Operator Assignment Messages
// ============================================================
// User-based operator system that allows regular users to be
// assigned operator privileges for specific services.
// This replaces the legacy Operator model with a more flexible
// approach where users can have operator access across multiple services.
// ============================================================

// OperatorAssignment represents an operator role assignment to a user account.
// A single user can have multiple operator assignments across different services.
// The assignment is scoped by service_id and country_code.
message OperatorAssignment {
  // Unique assignment identifier (UUIDv7)
  string id = 1;
  // Reference to identity_db.accounts (cross-database reference)
  string account_id = 2;
  // Service this assignment applies to
  string service_id = 3;
  // Country code for regional scoping (ISO 3166-1 alpha-2)
  string country_code = 4;
  // Current status of the assignment
  OperatorAssignmentStatus status = 5;
  // Admin ID who created this assignment
  string assigned_by = 6;
  // When the assignment was created
  google.protobuf.Timestamp assigned_at = 7;
  // When the assignment was deactivated (if applicable)
  google.protobuf.Timestamp deactivated_at = 8;
  // Reason for deactivation
  string deactivation_reason = 9;
  // Record creation timestamp
  google.protobuf.Timestamp created_at = 10;
  // Last update timestamp
  google.protobuf.Timestamp updated_at = 11;
  // Permissions granted to this operator assignment
  repeated Permission permissions = 12;
}

// OperatorAssignmentStatus represents the lifecycle of an operator assignment.
enum OperatorAssignmentStatus {
  // Default unspecified value
  OPERATOR_ASSIGNMENT_STATUS_UNSPECIFIED = 0;
  // Assignment is active and the user has operator privileges
  OPERATOR_ASSIGNMENT_STATUS_ACTIVE = 1;
  // Assignment is temporarily suspended
  OPERATOR_ASSIGNMENT_STATUS_SUSPENDED = 2;
  // Assignment has been permanently revoked
  OPERATOR_ASSIGNMENT_STATUS_REVOKED = 3;
}

// AssignOperator
message AssignOperatorRequest {
  string account_id = 1;  // User account to assign operator role
  string service_id = 2;
  string country_code = 3;
  string assigned_by = 4;  // Admin ID
  repeated string permission_ids = 5;  // Initial permissions
}

message AssignOperatorResponse {
  bool success = 1;
  OperatorAssignment assignment = 2;
  string message = 3;
}

// RevokeOperatorAssignment
message RevokeOperatorAssignmentRequest {
  string assignment_id = 1;
  string revoked_by = 2;  // Admin ID
  string reason = 3;
}

message RevokeOperatorAssignmentResponse {
  bool success = 1;
  string message = 2;
}

// GetOperatorAssignment
message GetOperatorAssignmentRequest {
  string account_id = 1;
  string service_id = 2;
  string country_code = 3;
}

message GetOperatorAssignmentResponse {
  OperatorAssignment assignment = 1;
  bool found = 2;
}

// GetServiceOperatorAssignments
message GetServiceOperatorAssignmentsRequest {
  string service_id = 1;
  optional string country_code = 2;
  optional OperatorAssignmentStatus status = 3;
  int32 page = 4;
  int32 page_size = 5;
}

message GetServiceOperatorAssignmentsResponse {
  repeated OperatorAssignment assignments = 1;
  int32 total_count = 2;
  int32 page = 3;
  int32 page_size = 4;
}

// UpdateOperatorAssignmentPermissions
message UpdateOperatorAssignmentPermissionsRequest {
  string assignment_id = 1;
  repeated string permission_ids = 2;  // New permission list (replaces existing)
  string updated_by = 3;  // Admin ID
}

message UpdateOperatorAssignmentPermissionsResponse {
  bool success = 1;
  OperatorAssignment assignment = 2;
  string message = 3;
}

// GetOperatorAssignmentPermissions
message GetOperatorAssignmentPermissionsRequest {
  string assignment_id = 1;
}

message GetOperatorAssignmentPermissionsResponse {
  repeated Permission permissions = 1;
}
